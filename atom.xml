<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title><![CDATA[Shane Hsi Rocks]]></title>
  
  <link href="/atom.xml" rel="self"/>
  <link href="http://shane.hsi.rocks/"/>
  <updated>2016-03-23T02:24:18.000Z</updated>
  <id>http://shane.hsi.rocks/</id>
  
  <author>
    <name><![CDATA[Shane Hsi]]></name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title><![CDATA[前端技术选型思考于2016年03月23日]]></title>
    <link href="http://shane.hsi.rocks/2016/03/23/2016-03-23-Front-End-General-Techniques-Thoughts/"/>
    <id>http://shane.hsi.rocks/2016/03/23/2016-03-23-Front-End-General-Techniques-Thoughts/</id>
    <published>2016-03-23T01:40:04.000Z</published>
    <updated>2016-03-23T02:24:18.000Z</updated>
    <content type="html"><![CDATA[<ul>
<li>HTML/CSS</li>
<li>React</li>
<li>Redux</li>
<li>React Router</li>
<li>Rx</li>
<li>Falcor/Relay/GraphQL</li>
<li>Express</li>
</ul>
<p>分层的话：</p>
<table>
<thead>
<tr>
<th>分层</th>
</tr>
</thead>
<tbody>
<tr>
<td>HTML/CSS - UI, UE</td>
</tr>
<tr>
<td>View - React</td>
</tr>
<tr>
<td>Data flow - Redux/Rx</td>
</tr>
<tr>
<td>Ajax/Cache - Falcor</td>
</tr>
<tr>
<td>Backend - Express/Falcor Endpoint</td>
</tr>
</tbody>
</table>
<p>其他的：</p>
<ul>
<li>Test<ul>
<li>Ava</li>
<li>Enzyme</li>
</ul>
</li>
<li>React Router</li>
<li>Webpack module bundler</li>
<li>Proxy</li>
<li>Mock Server</li>
</ul>
<p><strong>优先级</strong>：</p>
<ol>
<li>Ava/Enzyme </li>
<li>Redux/Rx</li>
<li>HTML/CSS</li>
<li>Faclor</li>
<li>Express</li>
<li>Mock Server</li>
<li>Proxy</li>
</ol>
]]></content>
    <summary type="html">
    <![CDATA[<ul>
<li>HTML/CSS</li>
<li>React</li>
<li>Redux</li>
<li>React Router</li>
<li>Rx</li>
<li>Falcor/Relay/GraphQL</li>
<li>Express</li>
</ul>
]]>
    </summary>
    
  </entry>
  
  <entry>
    <title><![CDATA[npm link]]></title>
    <link href="http://shane.hsi.rocks/2016/03/22/npm-link/"/>
    <id>http://shane.hsi.rocks/2016/03/22/npm-link/</id>
    <published>2016-03-22T06:26:37.000Z</published>
    <updated>2016-03-22T06:32:17.000Z</updated>
    <content type="html"><![CDATA[<p>参考链接：<a href="http://justjs.com/posts/npm-link-developing-your-own-npm-modules-without-tears" target="_blank" rel="external">justjs: node.js tutorials</a></p>
<p><strong>npm link: symbolic links to the rescue</strong></p>
<p>Fortunately npm provides a tool to avoid this tedium. And it’s easy to use. But there’s a catch.</p>
<p>Here’s how it’s supposed to work:</p>
<ol>
<li><p>cd to src/appy</p>
</li>
<li><p>Run “<strong>npm link</strong>“. This creates a symbolic link from a global folder to the src/appy folder.</p>
</li>
<li><p>cd to src/mysite</p>
</li>
<li><p>Run “<strong>npm link appy</strong>“. This links “node_modules/appy” in this particular project to the global folder, so that “require” calls looking for appy wind up loading it from your development folder, src/appy.</p>
</li>
</ol>
<p>Mission accomplished… almost. If you installed Node in a typical way, using MacPorts or Ubuntu’s apt-get, then npm’s “global” folders are probably in a location shared system-wide, like /opt/local/npm or /usr/lib/npm. And this is not good, because it means those “npm link” commands are going to fail unless you run them as root.</p>
<p>如何删除呢？</p>
<p>参考链接：<a href="http://stackoverflow.com/questions/19094630/how-do-i-uninstall-a-package-installed-using-npm-link" target="_blank" rel="external">How do I uninstall a package installed using npm link?</a></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo npm rm --global foo&#10;npm ls --global foo # &#26816;&#26597;&#19979;</span><br></pre></td></tr></table></figure>]]></content>
    <summary type="html">
    <![CDATA[<p>参考链接：<a href="http://justjs.com/posts/npm-link-developing-your-own-npm-modules-without-tears" target="_blank" rel="external">justjs: node]]>
    </summary>
    
  </entry>
  
  <entry>
    <title><![CDATA[Learn Github RESTful API v3]]></title>
    <link href="http://shane.hsi.rocks/2016/03/22/Learn-Github-RESTful-API-v3/"/>
    <id>http://shane.hsi.rocks/2016/03/22/Learn-Github-RESTful-API-v3/</id>
    <published>2016-03-22T03:37:01.000Z</published>
    <updated>2016-03-22T03:56:31.000Z</updated>
    <content type="html"><![CDATA[<p><strong>meida type:</strong></p>
<p>最基本：<br>    application/json</p>
<p>其他类似于上传功能等单独定义。</p>
<p><strong>响应</strong></p>
<p>Response Header:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Status</span>: <span class="string">200 OK</span></span><br><span class="line"></span><br><span class="line"><span class="1c">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>分页</strong></p>
<p>/search/users?q=xx&amp;pageIndex=1&amp;pageSize=10</p>
<p>| 名称 | 类型 | 描述 |<br>| q | string | 关键词 |<br>| pageIndex | number | 第几页 |<br>| pageSize | number | 每页分几个 |</p>
<p><strong>错误</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Status</span>: <span class="string">500 INTERNAL SERVER ERROR</span></span><br><span class="line"></span><br><span class="line"><span class="css"><span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">error</span>:<span class="value"> <span class="string">'...'</span></span><br><span class="line"></span></span></span>&#125;</span></span><br></pre></td></tr></table></figure>
]]></content>
    <summary type="html">
    <![CDATA[<p><strong>meida type:</strong></p>
<p>最基本：<br>    application/json</p>
<p>其他类似于上传功能等单独定义。</p>
<p><strong>响应</strong></p>
<p>Response Header]]>
    </summary>
    
  </entry>
  
  <entry>
    <title><![CDATA[Setting up webpack-dev-middleware in Express]]></title>
    <link href="http://shane.hsi.rocks/2016/03/22/Setting-up-webpack-dev-middleware-in-Express/"/>
    <id>http://shane.hsi.rocks/2016/03/22/Setting-up-webpack-dev-middleware-in-Express/</id>
    <published>2016-03-22T01:21:32.000Z</published>
    <updated>2016-03-22T02:31:32.000Z</updated>
    <content type="html"><![CDATA[<p>需要了解几个概念：</p>
<ol>
<li>Express 和 connect 的区别</li>
<li>Express middleware 的原理大概了解</li>
</ol>
<p>Webpack dev 的几个概念：</p>
<p><strong>a. webpack dev server 完全可以 self-running 的 dev server，并包含 live reloading。</strong>：</p>
<p><strong>b. webpack dev middleware，</strong>：</p>
<p>是一个 simple wrapper middleware for webpack。 It serves the files emitted from webpack over a <strong>connect server</strong>.</p>
<p>和 bundling as files 相比的优势：</p>
<ol>
<li>No files are written to disk, it handles the files <strong>in memory</strong>。</li>
<li>If files changed <strong>in watch mode</strong>, the middleware no longer serves the old bundle, but <strong>delays requests until the compiling has finished</strong>. You don’t have to wait before refreshing the page after a file modification.</li>
</ol>
<p><strong>c. webpack hot middleware</strong></p>
<p>Webpack hot reloading using only webpack-dev-middleware. This allows you to add hot reloading into an existing server without webpack-dev-server.</p>
<p>以上两种 middleware 的区别可能要看代码。从文档和我的理解来说：</p>
<ol>
<li>dev 是 in memory</li>
<li>hot 是依赖了 dev，并增加了 hot reload</li>
</ol>
<p>因为已经有 Express 作为 server，所以，目的是：</p>
<p><strong>use webpack-dev-server as a middleware</strong></p>
]]></content>
    <summary type="html">
    <![CDATA[<p>需要了解几个概念：</p>
<ol>
<li>Express 和 connect 的区别</li>
<li>Express middleware 的原理大概了解</li>
</ol>
<p>Webpack dev 的几个概念：</p>
<p><strong>a. webpa]]>
    </summary>
    
  </entry>
  
  <entry>
    <title><![CDATA[Thoughts on Progressive Web Development]]></title>
    <link href="http://shane.hsi.rocks/2016/03/17/Thoughts-on-Progressive-Web-Development/"/>
    <id>http://shane.hsi.rocks/2016/03/17/Thoughts-on-Progressive-Web-Development/</id>
    <published>2016-03-17T09:00:44.000Z</published>
    <updated>2016-03-17T10:59:59.000Z</updated>
    <content type="html"><![CDATA[<h2 id="u6837_u5F0F"><a href="#u6837_u5F0F" class="headerlink" title="样式"></a>样式</h2><p>样式使用 ant.design。</p>
<p>样式不会变。ant.design 的就很好。</p>
<p>但是如何使用 React 实现？可以修改。反正对用户的（接口）不要变。</p>
<h2 id="u4F46_u662F_u57FA_u672C_u7684_Layout__u8981_u5B9A_u4E0B_u6765"><a href="#u4F46_u662F_u57FA_u672C_u7684_Layout__u8981_u5B9A_u4E0B_u6765" class="headerlink" title="但是基本的 Layout 要定下来"></a>但是基本的 Layout 要定下来</h2><img src="/2016/03/17/Thoughts-on-Progressive-Web-Development/mockup.png" alt="mockup.png" title="">
<p>借鉴的淘宝的。可以很顺畅的放下 </p>
<ul>
<li>logo</li>
<li>omni serach</li>
<li>function area, ex. notification, help</li>
<li>left side bar</li>
<li>tab bar</li>
</ul>
<p>不要给用户选择。</p>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="u6837_u5F0F"><a href="#u6837_u5F0F" class="headerlink" title="样式"></a>样式</h2><p>样式使用 ant.design。</p>
<p>样式不会变。ant.design 的就很好。</p>
<]]>
    </summary>
    
  </entry>
  
  <entry>
    <title><![CDATA[如何设计出色的网站后台原型？- 知乎问题学习]]></title>
    <link href="http://shane.hsi.rocks/2016/03/17/How-to-Design-an-Excellent-Web-Admin-Prototype/"/>
    <id>http://shane.hsi.rocks/2016/03/17/How-to-Design-an-Excellent-Web-Admin-Prototype/</id>
    <published>2016-03-17T07:11:18.000Z</published>
    <updated>2016-03-17T08:10:20.000Z</updated>
    <content type="html"><![CDATA[<p>Q：新手请教，如何设计出色的网站后台的原型？前辈们都有那些什么工作方法，设计经验，请不吝赐教!~</p>
<p>作者：justinlam</p>
<p>严重不同意最高票的回答。对 <strong>信息系统逻辑</strong> 的理解太表面。</p>
<p>没错，在设计系统时最开始确实是要定义好模块结构的划分，但是划分的方法不应该按照功能模块而是 <strong>按照业务逻辑进行划分</strong>。首先在 <strong>规划系统时要思考这个系统的作用到底是解决了什么问题或者对企业带来了怎么样的提升</strong> 。在这个大的环境下确定了之后，需求分析的阶段，应该按照业务的职责区块来划分子系统。</p>
<blockquote>
<p>应该一直维护一个图谱，每一块的都是相连的。可以乱，可以花时间整理。</p>
<p>注：作者认为这个是 <strong>在使用上是达不到出色的</strong>。原因是划分的方式。</p>
</blockquote>
<img src="/2016/03/17/How-to-Design-an-Excellent-Web-Admin-Prototype/zhihu-1.png" alt="zhihu-1.png" title="">
<p>这张图应该是 <strong>很普遍而且典型的后台管理系统</strong>，但是这样的系统无论是在开发还是使用我认为都是 <strong>达不到出色的</strong>。图中的板块划分采用 <strong>“业务名词+管理”</strong> 来进行命名，实际上也就是 <strong>以”物”为线索</strong> 贯穿整个系统。但是在实际操作中 <strong>物与物之间的传递都是交错</strong> 在一起的，例如图中的项目管理板块中包含了”合同管理”，在合同管理板块中又包含了”合同管理”那么究竟是哪个进行管理呢，项目管理中是否又包含权限的区分呢，这样的划分明显是有问题的。我在另一个回答上提到过 <strong>“穷尽不重复”</strong> 的划分方法，其实在这里就可以体现出作用来。</p>
<blockquote>
<p><strong>物与物之间的传递都是交错</strong>，就是 graph。上例的划分是 tree。</p>
</blockquote>
<p>那么正确的后台划分子系统的方式应该是 <strong>按照业务流程</strong> 来划分，以 <strong>“事”</strong> 为线索贯穿系统。采用 <strong>业务流程的环节</strong> 进行划分可以有效的 <strong>避免重复和混乱</strong> 的现象，对整个系统的架构都是非常清晰明了的。想要以”事”为线索进行梳理，有一个很好的方法就是使用 <strong>UML中的构件图</strong> 的来解决。对于产品人员，只需要理解构件图的思想，画出一个轻量级的框架。</p>
<blockquote>
<p><strong>按照业务流程</strong>，采用 <strong>业务流程的环节</strong> 进行划分。有效的 <strong>避免重复和混乱</strong> 。</p>
</blockquote>
<img src="/2016/03/17/How-to-Design-an-Excellent-Web-Admin-Prototype/zhihu-2.png" alt="zhihu-2.png" title="">
<p>首先在构件图中两个最重要的概念 <strong>构件和接口</strong> 对应着 <strong>事件和流程</strong> ，接口与接口之间只存在 <strong>实现(代表这个流程由这个事件提供的)和使用(代表这个事件要使用这个流程)</strong> 这两个关系。理解了这一概念之后就可以对 <strong>事与事，事与流程，流程与流程之间进行连接</strong>。</p>
<img src="/2016/03/17/How-to-Design-an-Excellent-Web-Admin-Prototype/zhihu-3.png" alt="zhihu-3.png" title="">
<p>画构件图，<strong>第一步是识别建模的构件集合，也就是对主题域进行划分</strong>。可以按照 <strong>工作职责范围(部门)</strong> 划分成不同的 <strong>主题域</strong>，划分的时候也可以根据需要 <strong>进行多级的嵌套</strong> ，这样可以更容易理解上下级之间的关联。例如软件开发商可以按照开发人员，产品人员，销售人员职责不同进行第一级区块划分，然后再根据开发人员负责的不同环节进行第二级部门的划分。那么根据区块就可以很容易划分出”销售”和”研发”两个主题域。</p>
<blockquote>
<p>构件的集合，可以理解成 namespace。可以镜像于 <strong>部门（工作职责）</strong><br>嵌套关系，可以镜像于 Job Family。</p>
<p>Job Family Group -&gt; Job Family 职业群，职业<br>Job Family + Management Level = Job Profile 职能<br>Job Profile + Organizaiton = Position 职位</p>
</blockquote>
<p>在研发这个主题域内主要负责针对软件研发进行管理，经过设计，研发，测试这几个阶段生产出成型的软件。那么这块就可以命名为”研发管理系统子系统”。</p>
<p>在销售这个主题域内主要负责对客户的销售，客户培训，售后服务等，因此这块可以命名为”客户服务管理子系统”。</p>
<p>在一般的系统中往往会加入后勤板块，在这个板块内含有硬件，财政和人员这些基本模板，可以划分成“硬件服务管理子系统”，”财政管理子系统”和”人员管理子系统”。后面两个子系统按照范围界定的原则相对独立，所以在前期设计中暂不考虑。</p>
<img src="/2016/03/17/How-to-Design-an-Excellent-Web-Admin-Prototype/zhihu-4.png" alt="zhihu-4.png" title="">
<p>第二步需要把 <strong>功能不同的模块</strong> 划分成 <strong>构件</strong>，同时 <strong>确定构件与构件之间的接口，也就是开始绘制构件图</strong>。首先每一个主题域就是一个构件，这个比较好理解。先分析各个主题域之间的关系，四个系统两两之间有不同的关系。因为人员管理子系统相对比较独立，所以这块可以最后考虑。</p>
<p>“研发管理系统子系统”与”客户服务管理子系统”:研发管理需要获取客户服务管理中的订单详情、研发要求、客户资料等；而客户服务管理需要获取研发管理中的项目进展、功能设置等。</p>
<p>“研发管理系统子系统”与”硬件服务管理子系统”:研发管理需要知道数据库和服务器的情况，后台资源占用的情况；硬件服务管理需要获取研发团队的项目进度，功能规划和版本维护的情况。</p>
<p>“客户服务管理子系统”与”硬件服务管理子系统”: 硬件服务管理需要知道客户的基本信息以便确定投入什么硬件支持；客户服务管理系统一般就不需要从后台服务系统获取信息。</p>
<img src="/2016/03/17/How-to-Design-an-Excellent-Web-Admin-Prototype/zhihu-5.png" alt="zhihu-5.png" title="">
<p>（上图是一个比较简单的原型，实际规划还要考虑主题域之间更多关联）</p>
<p>最后一步 <strong>进行主题域范围的明确，界定每个主题域内进行的功能以及相关的事件</strong>。在一些书籍中也把这个关系成为 <strong>上下文关系</strong>，即主题域与功能之间父级与子级的概念。在这个阶段要考虑到 Customer 与 Worker 之间的关系。找到系统中所有的客户，考虑这些客户会引起什么事件的发生，这些事件会引起Worker什么样的工作，讲这些都考虑进来。然后再补充Worker主动发起的动作，那么一个系统的所有事件就能没有遗漏地梳理完整了。这里值得注意的是，对于研发管理子系统而言，其他的客服管理，财政管理都属于是客户关系。他们对于研发关系系统属于消费者的动作。</p>
<blockquote>
<p>差不多理解作者的思想，核心是从流程触发，找到节点，找到节点间的接口。类似于 SOA，或者 FP。所以，需要一种 stream 的通用格式。<br>但是需要 namespace 之类的进行划分。这一块可以参考领域驱动设计。</p>
</blockquote>
<img src="/2016/03/17/How-to-Design-an-Excellent-Web-Admin-Prototype/zhihu-6.png" alt="zhihu-6.png" title="">
<p>通过以上三步可以把一个系统大致的框架搭建起来。这样搭建的好处在于系统的业务流程很清晰，无论是对于研发还是使用者而言都是有好处的，每个人都能清楚地意识到自己在做什么事情。上述分析方法是徐峰老师提出的 <strong>SERU需求分析法</strong> 中关于主题域确定，也就是系统框架结构确定的第一步，这也是设计一个系统最根基的地方，然后才是去考虑更细化，更精准的业务流程设计。把根基打好再去做子系统内部的规划就变得比较简单。对于一个系统，在设计时一定要有“自上而下”的思想，从最大的环境去考虑问题，这样才不会在后期规划中因为突然插入的东西变得混乱。(图片有部分来自网络，侵删)</p>
<p>参考资料：</p>
<ul>
<li><a href="http://zhuanlan.zhihu.com/justinlam/20383851" target="_blank" rel="external">SERU最佳需求分析方法</a></li>
<li><a href="https://book.douban.com/subject/3265691/" target="_blank" rel="external">软件需求最佳实践</a></li>
</ul>
]]></content>
    <summary type="html">
    <![CDATA[<p>Q：新手请教，如何设计出色的网站后台的原型？前辈们都有那些什么工作方法，设计经验，请不吝赐教!~</p>
<p>作者：justinlam</p>
<p>严重不同意最高票的回答。对 <strong>信息系统逻辑</strong> 的理解太表面。</p>
<p>没错，在设计系统]]>
    </summary>
    
  </entry>
  
  <entry>
    <title><![CDATA[What Relay is Solved]]></title>
    <link href="http://shane.hsi.rocks/2016/03/17/What-Relay-is-Solved/"/>
    <id>http://shane.hsi.rocks/2016/03/17/What-Relay-is-Solved/</id>
    <published>2016-03-17T02:30:46.000Z</published>
    <updated>2016-03-17T02:38:23.000Z</updated>
    <content type="html"><![CDATA[<img src="/2016/03/17/What-Relay-is-Solved/0.png" alt="0.png" title="">
<img src="/2016/03/17/What-Relay-is-Solved/1.png" alt="1.png" title="">
<img src="/2016/03/17/What-Relay-is-Solved/2.png" alt="2.png" title="">
<img src="/2016/03/17/What-Relay-is-Solved/3.png" alt="3.png" title="">
]]></content>
    <summary type="html">
    <![CDATA[<img src="/2016/03/17/What-Relay-is-Solved/0.png" alt="0.png" title="">
<img src="/2016/03/17/What-Relay-is-Solved/1.png" alt="1.png" title=]]>
    </summary>
    
  </entry>
  
  <entry>
    <title><![CDATA[Getting Started With Falcor]]></title>
    <link href="http://shane.hsi.rocks/2016/03/16/Getting-Started-With-Falcor/"/>
    <id>http://shane.hsi.rocks/2016/03/16/Getting-Started-With-Falcor/</id>
    <published>2016-03-16T06:55:41.000Z</published>
    <updated>2016-03-16T10:05:05.000Z</updated>
    <content type="html"><![CDATA[<p><a href="https://auth0.com/blog/2015/08/28/getting-started-with-falcor/" target="_blank" rel="external">Getting Started With Falcor</a></p>
<h2 id="Outline"><a href="#Outline" class="headerlink" title="Outline"></a>Outline</h2><p>In this tutorial, we will look at some of Falcor’s basic operations and show how they can be used to construct a virtual JSON model from a data source. The example data we’ll use will model a handful of JavaScript conferences. We’ll start on the client side and eventually move everything over to be served from a NodeJS back end. </p>
<p>会涉及到 Falcor 的一些基本操作。</p>
<p>如何从 data source 构造 virutal JSON model。</p>
<p>mock 数据是 JavaScript 会议。</p>
<p>先从 client 端，在写到 NodeJS backend。</p>
<p>Specifically, we will cover:</p>
<ul>
<li>√ What Falcor is and what problems it solves</li>
<li>How to set up a Falcor model on the client and prime it with data 纯 client 端</li>
<li>How to use Falcor’s JSON Graph to avoid having duplicate data JSON Graph 上场，dedupe</li>
<li>How to set up up a Falcor Router with Falcor Express Falcor Router 上场</li>
<li>How to do a basic search using a Falcor route 一个基本的搜索功能</li>
</ul>
<h2 id="What_is_Falcor_3F"><a href="#What_is_Falcor_3F" class="headerlink" title="What is Falcor?"></a>What is Falcor?</h2><p>One of the key problems that Falcor solves is the fact that HTTP wasn’t designed and really isn’t optimized for how web applications should ideally request data. With HTTP, only a single resource can be retrieved per request. Since web applications tend to need to request many small resources, many HTTP requests are often required to get all the data the application needs.</p>
<p>HTTP 并不是为 web application 设计和优化的。</p>
<p>web application 需要很多次小的资源请求。开销又很大。</p>
<p>Another problem that Falcor solves is that JSON objects represent data hierarchically, as trees, whereas data is much more often a graph. In other words, an application’s data doesn’t always have a strict parent-child relationship, but rather will tend to have many predecessors, or be related to many other pieces of data. For example, suppose that we have several categories for our JavaScript conferences. A conference like ng-conf could fit under the category of “JavaScript”, but could also fit under “AngularJS”. If we were to model this with JSON, we might get something like this:</p>
<p>另一个解决的问题，是 data representation，数据展示。</p>
<p>JSON 对象是 tree。</p>
<p>而 data 一般是 graph。</p>
<p>也就是一般不是父子单线关系，而是多线联系。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">categories: &#123;</span><br><span class="line">  javascript: [</span><br><span class="line">    <span class="number">0</span>: &#123;</span><br><span class="line">      name: ng-conf</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  angularjs: [</span><br><span class="line">    <span class="number">0</span>: &#123;</span><br><span class="line">      name: ng-conf</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>As it is expressed here, ng-conf has a parent-child relationship with both categories, when really it is related to both. Falcor makes it possible to deal with data as a graph, but still output it as a normal JSON object.</p>
<p>Falcor 做到是，可以用 graph 来表示 data，但是输出的还是普通的 JSON 对象。</p>
<p>Falcor also helps to make data retrieval more efficient. Instead of pulling many JSON objects from an API and then only using some parts of them in the view layer, Falcor wires together a single virtual JSON model that provides only the data that is required at the time that it is needed. For example, if we wanted to get the name of a conference and the first names of its attendees, we typically would first have our API serve the user data and then we would use the first name value in our view. However, with Falcor, we can easily say that we want only the first name value for each attendee and then have that be the only piece of user data that is returned. In this way, Falcor essentially customizes data to the application’s view. Falcor does this through its JSON Graph convention, which is used to model graph information as a JSON object.</p>
<p>数据获取高效：按需索取。</p>
<p>Furthermore, Falcor caches the virtual JSON model so that it can be accessed in-memory. When it becomes necessary to request more or different data, Falcor first consults the cache and if the data is not available there, it makes another request for only the fragment that is missing.</p>
<p>缓存。</p>
<p>后面的就直接练习吧。</p>
<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> falcor = <span class="built_in">require</span>(<span class="string">'falcor'</span>);</span><br><span class="line"><span class="keyword">var</span> falcorExpress = <span class="built_in">require</span>(<span class="string">'falcor-express'</span>);</span><br><span class="line"><span class="keyword">var</span> Router = <span class="built_in">require</span>(<span class="string">'falcor-router'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> _ = <span class="built_in">require</span>(<span class="string">'lodash'</span>);</span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Have Express request index.html</span></span><br><span class="line">app.use(express.static(<span class="string">'.'</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> $ref = falcor.Model.ref;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Same data that was used in the view for our</span></span><br><span class="line"><span class="comment">// events, but this time on a simple object</span></span><br><span class="line"><span class="comment">// and not a Falcor model.</span></span><br><span class="line"><span class="keyword">var</span> eventsData = &#123;</span><br><span class="line">  locationsById: &#123;</span><br><span class="line">    <span class="number">1</span>: &#123;</span><br><span class="line">      city: <span class="string">"Salt Lake City"</span>,</span><br><span class="line">      state: <span class="string">"Utah"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="number">2</span>: &#123;</span><br><span class="line">      city: <span class="string">"Las Vegas"</span>,</span><br><span class="line">      state: <span class="string">"Nevada"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="number">3</span>: &#123;</span><br><span class="line">      city: <span class="string">"Minneapolis"</span>,</span><br><span class="line">      state: <span class="string">"Minnesota"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="number">4</span>: &#123;</span><br><span class="line">      city: <span class="string">"Walker Creek Ranch"</span>,</span><br><span class="line">      state: <span class="string">"California"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  events: [</span><br><span class="line">    &#123;</span><br><span class="line">      name: <span class="string">"ng-conf"</span>,</span><br><span class="line">      description: <span class="string">"The world's best Angular Conference"</span>,</span><br><span class="line">      location: $ref(<span class="string">'locationsById[1]'</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      name: <span class="string">"React Rally"</span>,</span><br><span class="line">      description: <span class="string">"Conference focusing on Facebook's React"</span>,</span><br><span class="line">      location: $ref(<span class="string">'locationsById[1]'</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      name: <span class="string">"ng-Vegas"</span>,</span><br><span class="line">      description: <span class="string">"Two days jam-packed with Angular goodness with a focus on Angular 2"</span>,</span><br><span class="line">      location: $ref(<span class="string">'locationsById[2]'</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      name: <span class="string">"Midwest JS"</span>,</span><br><span class="line">      description: <span class="string">"Midwest JS is a premier technology conference focused on the JavaScript ecosystem."</span>,</span><br><span class="line">      location: $ref(<span class="string">'locationsById[3]'</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      name: <span class="string">"NodeConf"</span>,</span><br><span class="line">      description: <span class="string">"NodeConf is the longest running community driven conference for the Node community."</span>,</span><br><span class="line">      location: $ref(<span class="string">'locationsById[4]'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.use(<span class="string">"/model.json"</span>, falcorExpress.dataSourceRoute(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Router([&#123;</span><br><span class="line">      <span class="comment">// route 需要符合 整形模式，作为 eventIds</span></span><br><span class="line">    route: <span class="string">"events[&#123;integers:eventIds&#125;]['name', 'description']"</span>,</span><br><span class="line">        get: <span class="function"><span class="keyword">function</span>(<span class="params">pathSet</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> results = [];</span><br><span class="line">            <span class="comment">// 在上面我们指定了 eventIds 标识符</span></span><br><span class="line">            <span class="comment">// 是 array，可以 loop</span></span><br><span class="line">            pathSet.eventIds.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">eventId</span>) </span>&#123;</span><br><span class="line">              <span class="comment">// pathSet[2] 维护的是 key names array</span></span><br><span class="line">              <span class="comment">// JavaScript 嵌套一层（共两层），就会有两个 forEach</span></span><br><span class="line">                pathSet[<span class="number">2</span>].forEach(<span class="function"><span class="keyword">function</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">var</span> eventRecord = eventsData.events[eventId];</span><br><span class="line">                    <span class="comment">// 就是构造一个 &#123;path, value&#125;，让 client 能读懂</span></span><br><span class="line">                    results.push(&#123;</span><br><span class="line">                        path: [<span class="string">'events'</span>, eventId, key],</span><br><span class="line">                        value: eventRecord[key]</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> results;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;]);</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Listening on http://localhost:3000"</span>);</span><br></pre></td></tr></table></figure>
<p>Routes 是匹配 KeySet。在route string 的第一个数组。</p>
<p><code>route: &quot;events[{integers:eventIds}][&#39;name&#39;, &#39;description&#39;]&quot;</code></p>
<p>这里，我们指定：</p>
<ul>
<li>想匹配 integers</li>
<li>要被 eventId 检索</li>
</ul>
<p><code>get</code> 中的 <code>pathSet</code> 参数可以让我们访问 KeySet（KeySet 是客户端提供的，也就是 get 里的）。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> model = <span class="keyword">new</span> falcor.Model(&#123; source: <span class="keyword">new</span> falcor.HttpDataSource(<span class="string">'/model.json'</span>) &#125;);</span><br><span class="line"></span><br><span class="line">model</span><br><span class="line">    .get([</span><br><span class="line">        <span class="string">"events"</span>,</span><br><span class="line">        &#123; from: <span class="number">0</span>, to: <span class="number">2</span> &#125;,</span><br><span class="line">        [<span class="string">"name"</span>, <span class="string">"description"</span>]</span><br><span class="line">    ])</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">document</span>.getElementById(<span class="string">'event-data'</span>).innerHTML = <span class="built_in">JSON</span>.stringify(response, <span class="literal">null</span>, <span class="number">2</span>);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p>总结下，这个 route 就是要访问 <code>name</code> 和 <code>description</code>。</p>
<p>如果要获取 <code>location</code>，要写另一个 route，<strong>同时记得在第一个 route 里加上 ‘location’</strong>。</p>
<p>下面的 route string，加上了 <code>&#39;location&#39;</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">route: <span class="string">"events[&#123;integers:eventIds&#125;]['name', 'description', 'location']"</span>,</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    route: <span class="string">"locationsById[&#123;integers:locationId&#125;]['city', 'state']"</span>,</span><br><span class="line">    get: <span class="function"><span class="keyword">function</span>(<span class="params">pathSet</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> results = [];</span><br><span class="line">        pathSet.locationId.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">locationId</span>) </span>&#123;</span><br><span class="line">            pathSet[<span class="number">2</span>].forEach(<span class="function"><span class="keyword">function</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">var</span> location = eventsData.locationsById[locationId];</span><br><span class="line">                results.push(&#123;</span><br><span class="line">                    path: [<span class="string">'locationsById'</span>, locationId, key],</span><br><span class="line">                    value: location[key]</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> results;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>最后一个 route，<strong>Search for an Event by Name</strong>：</p>
<p>The client can send integers as a KeySet to pull a range of results, but it can also provide strings. We can use this to setup an “event by name” search route.</p>
<blockquote>
<p>吐槽下，route string 非常的诡异啊。得写一个 parser 啊。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    <span class="string">"events"</span>,</span><br><span class="line">    &#123; from: <span class="number">0</span>, to: <span class="number">2</span> &#125;,</span><br><span class="line">    [<span class="string">"name"</span>, <span class="string">"description"</span>]</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>可以用 <code>{ from: 0, to: 2 }</code> 作为 KeySet 来表示 range。</p>
<p>当然，也可以提供 string 啦。可以用这个特性，做一个 search route（“event by name“）。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    route: <span class="string">"events.byName[&#123;keys&#125;]['description']"</span>,</span><br><span class="line">    get: <span class="function"><span class="keyword">function</span>(<span class="params">pathSet</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> results = [];</span><br><span class="line">        pathSet[<span class="number">2</span>].forEach(<span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">            eventsData.events.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (_.includes(event, name)) &#123;</span><br><span class="line">                    results.push(&#123;</span><br><span class="line">                        path: [<span class="string">'events'</span>, <span class="string">'byName'</span>, name, <span class="string">'description'</span>],</span><br><span class="line">                        value: event.description</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> results;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>client 调用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">model.get([<span class="string">"events"</span>, <span class="string">"byName"</span>, [<span class="string">"Midwest JS"</span>], [<span class="string">"description"</span>]])</span><br></pre></td></tr></table></figure>
]]></content>
    <summary type="html">
    <![CDATA[<p><a href="https://auth0.com/blog/2015/08/28/getting-started-with-falcor/" target="_blank" rel="external">Getting Started With Falcor</a></]]>
    </summary>
    
  </entry>
  
  <entry>
    <title><![CDATA[Falcor Getting Start]]></title>
    <link href="http://shane.hsi.rocks/2016/03/16/Falcor-Getting-Start/"/>
    <id>http://shane.hsi.rocks/2016/03/16/Falcor-Getting-Start/</id>
    <published>2016-03-16T02:54:11.000Z</published>
    <updated>2016-03-16T06:22:28.000Z</updated>
    <content type="html"><![CDATA[<p>对 Falcor 的期望是：</p>
<ul>
<li>在 app state 和 backend service 之间做一个中间层</li>
<li>不要管理太多 data flow</li>
<li>不要侵入 view</li>
</ul>
<p>参考文章：<a href="https://netflix.github.io/falcor/starter/what-is-falcor.html" target="_blank" rel="external">What is Falcor?</a></p>
<p>Falcor is the innovative data platform that powers the Netflix UIs. Falcor allows you to model all your backend data as a single Virtual JSON object on your Node server. On the client you work with your remote JSON object using familiar JavaScript operations like get, set, and call. If you know your data, you know your API.</p>
<p>建模 所有的 backend data 到 一个单独的 Virutal JSON object，到你的 Node server（但是似乎 Java server 也有了）。</p>
<p>在客户端，使用熟悉的 JavaScript 操作，比如 <code>get</code>，<code>set</code>，<code>call</code>。API 是不需要学习成本的。只要了解数据。</p>
<p>Falcor is middleware. It is not a replacement for your application server, database, or MVC framework. Instead Falcor can be used to optimize communication between the layers of a new or existing application.</p>
<p>Falcor 是一个 middleware。</p>
<p>不是代替 application server，database，或者 MVC framework。</p>
<p>Falcor 是用来 优化 layers 之间的 communication。</p>
<h2 id="One_Model_Everywhere"><a href="#One_Model_Everywhere" class="headerlink" title="One Model Everywhere"></a>One Model Everywhere</h2><p>Falcor allows you to model all of your backend data as a single JSON resource on the application server.</p>
<p>Falcor 可以允许你将所有的 backend data 在 application server 上建模成一个单独的 JSON resource。</p>
<img src="/2016/03/16/Falcor-Getting-Start/falcor-network-diagram.png" alt="falcor-network-diagram.png" title="">
<p>Clients request subsets of this JSON resource on demand, just like they would from an in-memory JSON object. To retrieve values from the JSON resource on the server, the client passes the server JavaScript paths to each desired value within the JSON object. The server responds with a subset of the JSON object that contains only those values.</p>
<p>客户端会按需请求 JSON resource 的子集，就像是获取一个内存中的 JSON 对象。</p>
<p>客户端会通过参数：每个需要的值的 JavaScript paths 来请求服务端。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/model.json?paths=[<span class="string">"user.name"</span>, <span class="string">"user.surname"</span>, <span class="string">"user.address"</span>]</span><br><span class="line"></span><br><span class="line">GET /model.json?paths=[<span class="string">"user.name"</span>, <span class="string">"user.surname"</span>, <span class="string">"user.address"</span>]</span><br><span class="line">&#123;</span><br><span class="line">  user: &#123;</span><br><span class="line">    name: <span class="string">"Frank"</span>,</span><br><span class="line">    surname: <span class="string">"Underwood"</span>,</span><br><span class="line">    address: <span class="string">"1600 Pennsylvania Avenue, Washington, DC"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Exposing all data as a single URL allows clients to request all of the data they need in a single network request. This can reduce latency by avoiding sequential server round trips.</p>
<p>一个 endpoint 暴露所有的数据，可以：</p>
<ul>
<li>通过避免后续的往返请求减少网络延迟</li>
</ul>
<p>In order to ensure that your application server remains stateless, Falcor provides a specialized Router which routes requests for values within the JSON object to different backend services.</p>
<p>为了保证你的 <strong>应用服务器</strong> 保持无状态型，Falcor 提供了一个特殊的 <strong>Router</strong>，用来路由对不同的 backend services 的请求。</p>
<p>Instead of matching URLs, the Falcor Router matches one or more JavaScript paths.</p>
<p>Falcor Router 不是通过符合 URLs，而是符合 JavaScript paths：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> router = <span class="keyword">new</span> Router([</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// matches user.name or user.surname or user.address</span></span><br><span class="line">    route: <span class="string">"user['name','surname','address']"</span>,</span><br><span class="line">    get(pathSet) &#123;</span><br><span class="line">      <span class="comment">// pathSet could be ["user", ["name"]], ["user", ["name", "surname"]], ["user", ["surname", "address"]] and so on...</span></span><br><span class="line">      userService.</span><br><span class="line">        getUser(getUserID()).</span><br><span class="line">        then(<span class="function"><span class="keyword">function</span>(<span class="params">user</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> pathSet[<span class="number">1</span>].</span><br><span class="line">            map(<span class="function"><span class="keyword">function</span>(<span class="params">userKey</span>) </span>&#123;</span><br><span class="line">              <span class="comment">// return response for each individual requested path</span></span><br><span class="line">              <span class="keyword">return</span> &#123;</span><br><span class="line">                path: [<span class="string">"user"</span>, userKey],</span><br><span class="line">                value: user[userKey]</span><br><span class="line">              &#125;;</span><br><span class="line">            &#125;);</span><br><span class="line">         &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>
<p>看出来了吗？这个 <code>get</code> 类似于 GraphQL 的 resolve 方法。</p>
<p>pathSet 是可能的路径集合。</p>
<p>The Falcor Router allows you to expose a single JSON model to the client, while giving you the flexibility to store your data anywhere.</p>
<p>只是对 backend data 做建模，最终暴露一个 JSON model 给客户端。</p>
<p>但也保证了灵活性来在其他地方存储 data。</p>
<img src="/2016/03/16/Falcor-Getting-Start/services-diagram.png" alt="services-diagram.png" title="">
<h2 id="The_Data_is_the_API"><a href="#The_Data_is_the_API" class="headerlink" title="The Data is the API"></a>The Data is the API</h2><p>You do not need to learn a complicated service layer to work with your data when you are using Falcor. If you know your data, you know your API. Falcor allows you to work with remote data the same way you work with local data, using JavaScript paths and operations. The primary difference is that Falcor’s client API is asynchronous.</p>
<p>你不需要学习一个复杂的 service layer 来处理 data。没有新增的语义，完全是 JavaScript Object 的 API。唯一的区别就是，Falcor’s client API 是异步的。</p>
<p>Here’s an example retrieving the surname of a user directly from an in-memory JSON object using a simple JavaScript path.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> model = &#123;</span><br><span class="line">  user: &#123;</span><br><span class="line">    name: <span class="string">"Frank"</span>,</span><br><span class="line">    surname: <span class="string">"Underwood"</span>,</span><br><span class="line">    address: <span class="string">"1600 Pennsylvania Avenue, Washington, DC"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// prints "Underwood"</span></span><br><span class="line"><span class="built_in">console</span>.log(model.user.surname);</span><br></pre></td></tr></table></figure>
<p>Applications that use Falcor do not work directly with JSON data. Instead they work with their JSON data indirectly using a Falcor Model. The Falcor Model allows you to use familiar idioms like JavaScript paths and JavaScript operations to work with your data. The primary difference between working with JSON data directly and using a Falcor Model, is that a Falcor Model has an asynchronous API.</p>
<p>使用 Falcor 的应用并不会直接和 JSON data 打交道，而是通过 Falcor Model。</p>
<p>Falcor Model 提供了类似于 JavaScript paths 和 operations 的 API。只是他是异步的。</p>
<p>Let’s rewrite the code above using a Falcor Model instead of working with the JSON directly:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> model = <span class="keyword">new</span> falcor.Model(&#123;</span><br><span class="line">  cache: &#123;</span><br><span class="line">    user: &#123;</span><br><span class="line">      name: <span class="string">"Frank"</span>,</span><br><span class="line">      surname: <span class="string">"Underwood"</span>,</span><br><span class="line">      address: <span class="string">"1600 Pennsylvania Avenue, Washington, DC"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// prints "Underwood" eventually</span></span><br><span class="line">model.</span><br><span class="line">  getValue(<span class="string">"user.surname"</span>).</span><br><span class="line">  then(<span class="function"><span class="keyword">function</span>(<span class="params">surname</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(surname);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<p>Note that we use the same JavaScript path to retrieve our data as when we worked with the JSON data directly. The only difference is that the result is pushed to a callback when it becomes available.</p>
<p>The advantage of working with your data using Falcor’s asynchronous API is that you can move your data anywhere on the network without changing the client code that consumes the data. Using the Falcor Model, we only need to change a few lines of code to alter the previous example to work with remote data.</p>
<p>好处是，获取的 API 相同，不用变。但是 model 的值却可以放在其他地方。比如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> model = <span class="keyword">new</span> falcor.Model(&#123;</span><br><span class="line">  source: <span class="keyword">new</span> falcor.HttpDataSource(<span class="string">"/model.json"</span>)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// prints "Underwood" eventually</span></span><br><span class="line">model.</span><br><span class="line">  getValue(<span class="string">"user.surname"</span>).</span><br><span class="line">  then(<span class="function"><span class="keyword">function</span>(<span class="params">surname</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(surname);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<p>Now instead of working with in-memory JSON data, Falcor remotes requests for data to the application server’s Virtual JSON object. The Router retrieves the data from the data store with the information, and sends back only the requested fields.</p>
<p>现在是请求唯一的 endpoint，<code>/model.json</code>。</p>
<img src="/2016/03/16/Falcor-Getting-Start/falcor-end-to-end.png" alt="falcor-end-to-end.png" title="">
<p>Using an asynchronous API allows you to use the same programming model regardless of whether your data is local or remote. With Falcor it is common practice to begin development immediately by mocking the server’s JSON object. Once the server’s JSON resource has been written, the Falcor Model is connected to the server JSON using an HttpDataSource. No other client code needs to change. This approach can shrink project timelines by decoupling client and server developers.</p>
<p>使用一套异步 API 操作数据，不用关心数据在 local 还是 remote。</p>
<p>通用的实践就是，立即 mock server 的 JSON object。一旦 server 的 JSON resource 写好后，Falcor Model 就可以通过 HTTPDataSource 连接上 server 的 JSON。</p>
<p>不需要改变任何客户端代码。</p>
<h2 id="Bind_to_the_Cloud"><a href="#Bind_to_the_Cloud" class="headerlink" title="Bind to the Cloud"></a>Bind to the Cloud</h2><p>In most MVC systems, controllers are responsible for retrieving data from the server. <strong>One pattern for building applications with Falcor is to have your views retrieve data directly from the Falcor Model, just as they would from an in-memory JSON object</strong>. This pattern is sometimes referred to as Async MVC, because the communication between the view and the model is asynchronous.</p>
<p>在大多的 MVC 系统里，controllers 负责从 server 获取数据。<strong>在 Falcor 中，views 直接从 Falcor Model 获取数据。这是其中一种 pattern</strong>。</p>
<p>这种模式有时叫做 Async MVC。因为 view 和 model 之间是 async 的。</p>
<img src="/2016/03/16/Falcor-Getting-Start/async-mvc.png" alt="async-mvc.png" title="">
<p>In addition to decoupling controllers and views, Async MVC can improve the efficiency of your application’s network requests. When the view drives the data fetching, only the data absolutely required to render a view is retrieved from the server.</p>
<p>因为 Views 来声明需要什么数据，也就是必须的数据才获取。提高了效率。</p>
<p>In addition to Async MVC there are a variety of different patterns for integrating Falcor into your application. We are looking to the community for help building adapters for the various frameworks in use today.</p>
<p>除了 Async MVC，其他的 pattern 期待社区帮助构建。</p>
<h1 id="How_Does_Falcor_Work_3F"><a href="#How_Does_Falcor_Work_3F" class="headerlink" title="How Does Falcor Work?"></a>How Does Falcor Work?</h1><p>原文：<a href="https://netflix.github.io/falcor/starter/how-does-falcor-work.html" target="_blank" rel="external">How Does Falcor Work?</a></p>
<p>The Falcor Model transparently handles all network communication with the server. In order to ensure efficient client/server interactions, the Falcor Model applies a variety of different optimizations:</p>
<p>Faclor Model 隐式地处理着和 server 的网络请求。为了保证高效的 client/server 交互，Falcor Model 应用了一些列优化。</p>
<h2 id="Caching"><a href="#Caching" class="headerlink" title="Caching"></a>Caching</h2><p>Falcor maintains a fast in–memory cache that contains all of the values previously retrieved from the application server’s JSON object. If a request is made for information that is already available in the cache, the data will be retrieved from the cache and sent to the consumer’s callback as soon as possible.</p>
<p>Falcor 维护了一套快速的内存缓存，保存了之前所有从服务端获得的 JSON 对象。如果请求的信息在 cache 中已有，则从 cache 中获取，理解给 consumer 的 callback。</p>
<img src="/2016/03/16/Falcor-Getting-Start/model-caching.png" alt="model-caching.png" title="">
<p>To prevent the cache growing larger than the available memory on the device, developers can configure a maximum size for the cache. When the cache grows beyond the maximum size, the least-recently-used values are purged. This makes it possible to run the same application on an inexpensive mobile device or a powerful desktop machine.</p>
<p>为防止 cache 超过可用设备内存，开发者可以控制下 cache 的最大值。通过 LRU 算法清除。有客户端决定。</p>
<h2 id="Batching"><a href="#Batching" class="headerlink" title="Batching"></a>Batching</h2><p>Falcor’s ability to select as much or as little data from the network in a single request gives it the flexibility to batch multiple small requests for data into a single large request. The Falcor model can be configured to collect up multiple requests, and schedule them to be sent to the data source at once.</p>
<p>Falcor 可以打包小的请求到一个大的请求。涉及的逻辑是 schedule。</p>
<img src="/2016/03/16/Falcor-Getting-Start/batching.png" alt="batching.png" title="">
<p>In this example, we make a request for three individual values from the Model, and only a single coarse-grained request is sent to the data source</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> log = <span class="built_in">console</span>.log.bind(<span class="built_in">console</span>);</span><br><span class="line"><span class="keyword">var</span> httpDataSource = <span class="keyword">new</span> falcor.HttpDataSource(<span class="string">"/model.json"</span>);</span><br><span class="line"><span class="keyword">var</span> model = <span class="keyword">new</span> falcor.Model(&#123; source: httpDataSource &#125;);</span><br><span class="line"><span class="keyword">var</span> batchModel = model.batch();</span><br><span class="line"></span><br><span class="line">batchModel.getValue(<span class="string">"todos[0].name"</span>).then(log);</span><br><span class="line">batchModel.getValue(<span class="string">"todos[1].name"</span>).then(log);</span><br><span class="line">batchModel.getValue(<span class="string">"todos[2].name"</span>).then(log);</span><br><span class="line"></span><br><span class="line"><span class="comment">// The previous three model requests only send a single request</span></span><br><span class="line"><span class="comment">// to the httpDataSource: "todos[0..2].name"</span></span><br></pre></td></tr></table></figure>
<p>The ability to batch requests can significantly improve performance when using a network protocol with a high connection cost (ex. HTTP).</p>
<p>batch 可以极大的提升高开销网络协议（比如 HTTP）的性能。</p>
<h2 id="Request_Deduping"><a href="#Request_Deduping" class="headerlink" title="Request Deduping"></a>Request Deduping</h2><p>In addition to batching outgoing requests, the Falcor Model dedupes requests. If a request is made for a value for which there is already an outstanding request, no additional request is made. This allows individual application views to retrieve their own data without having to coordinate with other views, just as if they were retrieving data from a fast in-memory JSON store.</p>
<p>除了 batching 对外的 requests，Falcor Model 也会对请求去重。</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>对 Falcor 的期望是：</p>
<ul>
<li>在 app state 和 backend service 之间做一个中间层</li>
<li>不要管理太多 data flow</li>
<li>不要侵入 view</li>
</ul>
<p>参考文章：<a hre]]>
    </summary>
    
  </entry>
  
  <entry>
    <title><![CDATA[Transcending REST and RPC]]></title>
    <link href="http://shane.hsi.rocks/2016/03/16/Transcending-REST-and-RPC/"/>
    <id>http://shane.hsi.rocks/2016/03/16/Transcending-REST-and-RPC/</id>
    <published>2016-03-16T00:04:07.000Z</published>
    <updated>2016-03-16T00:52:54.000Z</updated>
    <content type="html"><![CDATA[<p>It seems that a new paradigm is coming. Facebook and Netflix have come up with different implementations for that idea. Some people are calling it <a href="http://www.infoq.com/presentations/domain-driven-architecture" target="_blank" rel="external">Demand-Driven Architecture</a>, but before I show you some solutions, let’s go over some history to understand the problem. I will use the example that Netflix provides, but I think that most of us will find the patterns familiar.</p>
<p>来自 Netflix 的一个例子（应该是共性的）</p>
<p>Just for clarity, let’s assume that we have an on-demand streaming service — quite similar to Netflix :) — that has three microservices. One contains the genres, another one the titles and the last one contains the ratings that different users give to those titles. As we’re in 2015 we’ll discard RPC as architectural style and we’ll go with a RESTful design. Let’s briefly enumerate the characteristics of a RESTful design:</p>
<p>假设和 Netflix 一样，有一个即时流服务 - 有3个微服务。一个包含 种类，一个是 标题，一个是 （对标题的）评级。</p>
<p>在 2015 我们放弃了 RPC，选择了 RESTful。</p>
<p>简要列举下 RESTful 设计的特性：</p>
<ul>
<li><p>HTTP verbs have direct correspondence with CRUD verbs. One of the benefits is that clients can understand what is going on the server without digging into the implementation. For instance, we know that PUT is idempotent, so as there will not be any side effect, the client can call to that endpoint several times in a row without any issue.</p>
</li>
<li><p>We use extensive HTTP caching. Through headers like Cache-Control or ETag, we leverage one of the most juicy features of HTTP: caching resources.</p>
</li>
<li><p>HATEOAS for the win. Every single representation should have links to different representations so the clients can navigate through our backend like a graph. <a href="http://www.restapitutorial.com/" target="_blank" rel="external">Further reading</a></p>
</li>
</ul>
<blockquote>
<p>HATEOAS Hypermedia as the Engine of Application State</p>
</blockquote>
<ul>
<li>统一接口（理解起来方便）</li>
<li>直接利用 HTTP cache</li>
<li>HATEOAS</li>
</ul>
<h2 id="REST_limitations"><a href="#REST_limitations" class="headerlink" title="REST limitations"></a>REST limitations</h2><p>Let’s imagine that we send a GET to the genres endpoint. The response will include links to other GET requests like titles/1234 or ratings/6789. If we have the title “Titanic” in different genres (romance, drama and DiCaprioRules) you can see how the client is going to do at least two redundant requests. Apart from that the client is going to reshape the data whenever it comes back since it’s likely that the client won’t need every single field that those responses include. So, we have two problems with this design:</p>
<ul>
<li>High latency as we don’t optimize calls.</li>
<li><p>Large message sizes.</p>
</li>
<li><p>Round requests，没有做优化（通过 HATEOAS）</p>
</li>
<li>数据量太大，很多数据字段不需要</li>
</ul>
<h2 id="Patching_REST_with_RPC"><a href="#Patching_REST_with_RPC" class="headerlink" title="Patching REST with RPC"></a>Patching REST with RPC</h2><p>One way of overcoming these problems is customising our requests with query params. You can say to the server something like “give me only a couple of the fields that you expose on that representation“” or whatever arbitrary parameter. That means that you’ll lose the caching that HTTP offers as now you’ll have a ton of possible not-really-resources to cache.</p>
<p>通过 query params，这样就没有了 HTTP 提供的 cache。</p>
<p>Also you can create new abstractions ad-hoc that aggregate that for the client. In fact one of the benefits of CQRS is being able to create different views of your internal entities, so the demands of the client doesn’t affect your domain modeling. That has a problem though: there is a big a coupling with the server. Our system has a massive amount of fragmentation as you can stream over Android, iOS, TVs and also, different versions of the same client device. Therefore there are going to be different needs and rhythms and the coordination between backend and clients is going to be really messy.</p>
<p>Ad-hoc endpoint。由于终端太多，view model 太多，不好维护。</p>
<p>Also, CQRS is amazing in the fact that you could decide to model your system around different bounded contexts, i.e, different CQRS deployables. If your client needs a view that aggregate data from two CQRS units, you have the same problem.</p>
<h2 id="Demand_driven_architecture_to_the_rescue"><a href="#Demand_driven_architecture_to_the_rescue" class="headerlink" title="Demand driven architecture to the rescue"></a>Demand driven architecture to the rescue</h2><p>This leads to the point of Demand Driven Architectures. Conceptually the backend is just a single entity and, since it’s modeled using REST principles, it’s defining what is the shape of the data. However, we’re going to have tons of clients with different needs and all of them need to twist themselves in order to get the shape of the data that they want. Would it be great if clients could just send queries to the logical data unit called backend?</p>
<p>概念上，backend 只有一个入口，也是用 REST 原则建模。</p>
<p>If we think in a relational database the concept is similar. We have different tables (rest endpoints, resources, backend services) and we have a query language that allows us to join and shape the data easily. Some of the optimizations of that query will be done by the platform that runs those queries.</p>
<p>用一种 QL 来 query，join 多个 tables（rest endpoints，resources，backend services）。QL 也可以被优化。</p>
<h2 id="Falcor_and_JSON_Graph"><a href="#Falcor_and_JSON_Graph" class="headerlink" title="Falcor and JSON Graph"></a>Falcor and JSON Graph</h2><p>Netflix has created a tool called <a href="http://netflix.github.io/falcor" target="_blank" rel="external">Falcor</a> that tries to solve this concrete problem. Clients won’t talk with the backend services directly anymore, instead of they will send queries to a Falcor service that will do the routing, aggregations, projections and optimizations. This is an image from Falcor’s official documentation.</p>
<p>Clients 不在和 backend services 直接通信，而是先发送 queries 到一个 Falcor service，后者会进行 routing，aggragations（集合），projections（投影）和 optimizations（优化）。</p>
<img src="/2016/03/16/Transcending-REST-and-RPC/falcor-network-diagram.png" alt="Falcor Network Diagram" title="Falcor Network Diagram">
<p>They based that platform on the idea of JSON Graph. Let me explain it briefly. JSON is in essence a tree structure. However, most of our data has relationships so it should be modeled like a graph. Using REST design programmers usually solve that problem through ids, but that makes our life really difficult (think about problems like cache invalidation). As they say:</p>
<p>基于 JSON Graph。</p>
<p>JSON 本身是树结构，但是 data 一般有关系（relationships），所以应该建模成 graph。</p>
<p>RESTful 一般通过 ids 来解决。但是问题也有，比如 cache invalidation。</p>
<blockquote>
<p>JSON Graph is valid JSON and can be parsed by any JSON parser. However JSON Graph introduces new primitive types to JSON to allow JSON to be used to represent graph information in a simple and consistent way.</p>
</blockquote>
<p>JSON Graph 是有效的 JSON，可以被解析。但是 JSON Graph 引入了新的基本类型到 JSON，可以让其用简单一致的方式展示 graph 信息。</p>
<p>They borrow the idea from unix filesystem. That filesystem is a tree, but thanks to symlinks you can emulate the behaviour of a graph. That has massive implications in the way that Falcor optimises calls to backend services. Instead of keeping some values in a denormalised fashion, Falcor keeps references to that normalised value, so, if you ask for a value that has been already retrieved, Falcor will avoid that call. Also That makes cache invalidation much easier.</p>
<p>借鉴了 Unix 文件系统的思路。文件系统是 tree，但是通过 symlinks，可以模拟 graph。</p>
<p>Falcor 优化了对后端服务的调用：值通过标准化方式被引用，可以做缓存和缓存失效。</p>
<img src="/2016/03/16/Transcending-REST-and-RPC/falcor-services-diagram-1024x518.png" alt="falcor-services-diagram-1024x518.png" title="">
<p>As you can see in the example, we don’t store denormalised documents for titles inside of genres, but a reference through a titles map indexed by id. I can show you some code that I’ve been working on for a proof of concept. Falcor server side is currently only available on Node.js but there are <a href="https://twitter.com/falcorjs/status/575657256475189248" target="_blank" rel="external">plans to porting it into another platforms</a>.</p>
<p>没有存储非范式文档的 title 在 generes 里。而是通过 reference。(flatten javasript)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">router.get(<span class="string">'/model.json'</span>, falcorKoa.dataSourceRoute(<span class="keyword">new</span> FalcorRouter([</span><br><span class="line">        &#123;</span><br><span class="line">            route: <span class="string">"teamsById[&#123;integers:teamIds&#125;]['name', 'memberCount']"</span>,</span><br><span class="line">            get  : <span class="function"><span class="keyword">function</span>(<span class="params">pathSet</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">const</span> teamIds = pathSet.teamIds;</span><br><span class="line">                <span class="keyword">const</span> keys = pathSet[<span class="number">2</span>];</span><br><span class="line">                <span class="keyword">return</span> teamsService.getTeams()</span><br><span class="line">                        .then(<span class="function"><span class="keyword">function</span>(<span class="params">teams</span>) </span>&#123;</span><br><span class="line">                            <span class="keyword">var</span> results = [];</span><br><span class="line">                            teamIds.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">teamId</span>) </span>&#123;</span><br><span class="line">                                keys.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">                                    <span class="keyword">var</span> team = teams[teamId];</span><br><span class="line">                                    results.push(&#123;</span><br><span class="line">                                        path : [<span class="string">'team'</span>, teamId, key],</span><br><span class="line">                                        value: team[key]</span><br><span class="line">                                    &#125;);</span><br><span class="line">                                &#125;);</span><br><span class="line">                            &#125;);</span><br><span class="line">                            <span class="keyword">return</span> results;</span><br><span class="line">                        &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ])));</span><br></pre></td></tr></table></figure>
<p>客户端：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> model = <span class="keyword">new</span> falcor.Model(&#123; source: <span class="keyword">new</span> falcor.HttpDataSource(<span class="string">'/model.json'</span>) &#125;);</span><br><span class="line">model.get(<span class="string">'teamsById['</span><span class="number">1234</span><span class="string">', '</span><span class="number">456</span><span class="string">'].name'</span>);</span><br><span class="line">model.get(<span class="string">'teamsById['</span><span class="number">789</span><span class="string">']['</span>name<span class="string">', '</span>memberCount<span class="string">']'</span>);</span><br></pre></td></tr></table></figure>
<h2 id="IN_CONCLUSION"><a href="#IN_CONCLUSION" class="headerlink" title="IN CONCLUSION"></a>IN CONCLUSION</h2><p>There are no silver bullets in software and nobody is claiming than Falcor or GraphQL are going to solve every single problem with client/server integration. However, if you have an application with a lot of clients and your backend has a complex data model, it might be worth giving this new paradigm a try.</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>It seems that a new paradigm is coming. Facebook and Netflix have come up with different implementations for that idea. Some people are c]]>
    </summary>
    
  </entry>
  
  <entry>
    <title><![CDATA[Redux APIs]]></title>
    <link href="http://shane.hsi.rocks/2016/03/15/Redux-APIs/"/>
    <id>http://shane.hsi.rocks/2016/03/15/Redux-APIs/</id>
    <published>2016-03-15T09:02:36.000Z</published>
    <updated>2016-03-16T01:09:10.000Z</updated>
    <content type="html"><![CDATA[<p>因为我在使用 rxjs 自己做一个简单的 flux。主要目的是做精细的 stream 控制。</p>
<p>这里想借鉴下 Redux 的 API 设计。</p>
<p>从例子看：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">render(</span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="title">Provider</span> <span class="attribute">store</span>=<span class="value">&#123;store&#125;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">App</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">Provider</span>&gt;</span>,</span><br><span class="line">  document.getElementById('root') /&gt;</span><br><span class="line">)</span></span><br></pre></td></tr></table></figure>
<p>store 是通过 context 全局可见的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapStateToProps</span>(<span class="params">state</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    counter: state.counter</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapDispatchToProps</span>(<span class="params">dispatch</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> bindActionCreators(CounterActions, dispatch)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(mapStateToProps, mapDispatchToProps)(Counter)</span><br></pre></td></tr></table></figure>
<p>connect 里主要的是 mapStateToProps。类似于 cursor 的功能。</p>
<h2 id="API_Design_2016-03-15_17_3A11_3A11"><a href="#API_Design_2016-03-15_17_3A11_3A11" class="headerlink" title="API Design 2016-03-15 17:11:11"></a>API Design 2016-03-15 17:11:11</h2><h3 id="store__u901A_u8FC7_context__u4F20_u9012"><a href="#store__u901A_u8FC7_context__u4F20_u9012" class="headerlink" title="store 通过 context 传递"></a>store 通过 context 传递</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">state$.subscribe(<span class="function"><span class="keyword">function</span> (<span class="params">state</span>) </span>&#123;</span><br><span class="line">  ReactDOM.render(</span><br><span class="line">    <span class="xml"><span class="tag">&lt;<span class="title">Component</span> /&gt;</span>,</span><br><span class="line">    document.getElementById('root'));</span><br><span class="line">&#125;);</span></span><br></pre></td></tr></table></figure>
<p>变成？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">state$.subscribe( state =&gt; render(</span><br><span class="line">    <span class="xml"><span class="tag">&lt;<span class="title">Provider</span> <span class="attribute">store</span>=<span class="value">&#123;state&#125;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">Component</span> /&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;/<span class="title">Provider</span>&gt;</span> ,  document.getElementById('root')   /&gt;</span><br><span class="line">)</span>);</span><br></pre></td></tr></table></figure>
<p>让 state 全局可见。不用显式往下传递。</p>
<h3 id="cursor__u62FF_u503C"><a href="#cursor__u62FF_u503C" class="headerlink" title="cursor 拿值"></a>cursor 拿值</h3><p>view 直接修改 store（或者调用 store 里的方法）。暂时不觉得 actions 有什么特别大的作用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"></span><br><span class="line">@cursor(state =&gt; &#123;</span><br><span class="line">    return state.counter;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Counter</span> <span class="keyword">extends</span> <span class="title">Component</span>&lt;<span class="title">any</span>, <span class="title">any</span>&gt; </span>&#123;</span><br><span class="line">  constructor(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; value, onIncrement, onDecrement &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    onIncrement(<span class="xml"><span class="tag">&lt;<span class="title">mutations</span>&gt;</span>)</span>;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="xml"><span class="tag">&lt;<span class="title">p</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="title">p</span>&gt;</span> /&gt;</span><br><span class="line">    )</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Counter;</span><br></pre></td></tr></table></figure>
<p>因为 store 已经全局可见了。所以 <code>cursor</code> 肯定是可以拿到值的。</p>
<p>counter 的 model，或者 store</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;Provider store=&#123;state&#125; animateStore=&#123;&#125;&gt;</span><br><span class="line">    <span class="xml"><span class="tag">&lt;<span class="title">Component</span> /&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="title">Provider</span>&gt;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>还是使用 redux 的 API 吧。只不过是使用 RxJS 来实现。</p>
<img src="/2016/03/15/Redux-APIs/diagram.png" alt="diagram.png" title="">
]]></content>
    <summary type="html">
    <![CDATA[<p>因为我在使用 rxjs 自己做一个简单的 flux。主要目的是做精细的 stream 控制。</p>
<p>这里想借鉴下 Redux 的 API 设计。</p>
<p>从例子看：</p>
<figure class="highlight js"><table><tr><td]]>
    </summary>
    
  </entry>
  
  <entry>
    <title><![CDATA[immutable-js 入门]]></title>
    <link href="http://shane.hsi.rocks/2016/03/15/immutable-js-getting-start/"/>
    <id>http://shane.hsi.rocks/2016/03/15/immutable-js-getting-start/</id>
    <published>2016-03-15T06:11:07.000Z</published>
    <updated>2016-03-15T08:47:35.000Z</updated>
    <content type="html"><![CDATA[<h1 id="Immutable_collections_for_JavaScript"><a href="#Immutable_collections_for_JavaScript" class="headerlink" title="Immutable collections for JavaScript"></a>Immutable collections for JavaScript</h1><p><a href="https://travis-ci.org/facebook/immutable-js" target="_blank" rel="external"><img src="https://travis-ci.org/facebook/immutable-js.svg" alt="Build Status"></a></p>
<p><a href="http://en.wikipedia.org/wiki/Immutable_object" target="_blank" rel="external">Immutable</a> data cannot be changed once created, leading to much simpler<br>application development, no defensive copying, and enabling advanced memoization<br>and change detection techniques with simple logic. <a href="http://en.wikipedia.org/wiki/Persistent_data_structure" target="_blank" rel="external">Persistent</a> data presents<br>a mutative API which does not update the data in-place, but instead always<br>yields new updated data.</p>
<p>简化开发流程：</p>
<ul>
<li>不会出现防守型复制（defensive copying）。</li>
<li>可以进行高级的记忆（memoization）</li>
<li>简化变动监测（change detection）</li>
</ul>
<p>持久化（Persistent）data 提供了可变的 API ，不会更新 data，而是总是生成新的更新过的数据。</p>
<p>Immutable.js provides many Persistent Immutable data structures including:<br><code>List</code>, <code>Stack</code>, <code>Map</code>, <code>OrderedMap</code>, <code>Set</code>, <code>OrderedSet</code> and <code>Record</code>.</p>
<p>所以，提供的是：</p>
<p><strong> Persistent Immutable data structures </strong>，持久化不可变数据结构</p>
<p>包括： <code>List</code>，<code>Stack</code>，<code>Map</code>，<code>OrderedMap</code>，<code>Set</code>，<code>OrderedSet</code> 和 <code>Record</code>。</p>
<p>These data structures are highly efficient on modern JavaScript VMs by using<br>structural sharing via <a href="http://en.wikipedia.org/wiki/Hash_array_mapped_trie" target="_blank" rel="external">hash maps tries</a> and <a href="http://hypirion.com/musings/understanding-persistent-vector-pt-1" target="_blank" rel="external">vector tries</a> as popularized<br>by Clojure and Scala, minimizing the need to copy or cache data.</p>
<p>在现代的 JavaScript VMs 是非常高效的（通过使用 structural sharing，后者又是基于 hash map tries，和 vector tries，这些概念是因 Closure 和 Scala 流行的）。减少了复制或者缓存数据的需求。</p>
<p><code>Immutable</code> also provides a lazy <code>Seq</code>, allowing efficient<br>chaining of collection methods like <code>map</code> and <code>filter</code> without creating<br>intermediate representations. Create some <code>Seq</code> with <code>Range</code> and <code>Repeat</code>.</p>
<p>同时也提供了 lazy <code>Seq</code>，可以允许集合方法高效的 chaining，比如 <code>map</code>，<code>filter</code>，不用创造中介的展示。</p>
<h2 id="Getting_started"><a href="#Getting_started" class="headerlink" title="Getting started"></a>Getting started</h2><p>Install <code>immutable</code> using npm.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install immutable</span><br></pre></td></tr></table></figure>
<p>Then require it into any module.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Immutable = <span class="built_in">require</span>(<span class="string">'immutable'</span>);</span><br><span class="line"><span class="keyword">var</span> map1 = Immutable.Map(&#123;a:<span class="number">1</span>, b:<span class="number">2</span>, c:<span class="number">3</span>&#125;);</span><br><span class="line"><span class="keyword">var</span> map2 = map1.set(<span class="string">'b'</span>, <span class="number">50</span>);</span><br><span class="line">map1.get(<span class="string">'b'</span>); <span class="comment">// 2</span></span><br><span class="line">map2.get(<span class="string">'b'</span>); <span class="comment">// 50</span></span><br></pre></td></tr></table></figure>
<h3 id="Browser"><a href="#Browser" class="headerlink" title="Browser"></a>Browser</h3><p>To use <code>immutable</code> from a browser, download <a href="https://github.com/facebook/immutable-js/blob/master/dist/immutable.min.js" target="_blank" rel="external">dist/immutable.min.js</a><br>or use a CDN such as <a href="https://cdnjs.com/libraries/immutable" target="_blank" rel="external">CDNJS</a><br>or <a href="http://www.jsdelivr.com/#!immutable.js" target="_blank" rel="external">jsDelivr</a>.</p>
<p>Then, add it as a script tag to your page:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"immutable.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">script</span>&gt;</span><span class="actionscript"></span><br><span class="line">    <span class="keyword">var</span> map1 = Immutable.Map(&#123;a:<span class="number">1</span>, b:<span class="number">2</span>, c:<span class="number">3</span>&#125;);</span><br><span class="line">    <span class="keyword">var</span> map2 = map1.<span class="keyword">set</span>(<span class="string">'b'</span>, <span class="number">50</span>);</span><br><span class="line">    map1.<span class="keyword">get</span>(<span class="string">'b'</span>); <span class="comment">// 2</span></span><br><span class="line">    map2.<span class="keyword">get</span>(<span class="string">'b'</span>); <span class="comment">// 50</span></span><br><span class="line"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Or use an AMD loader (such as <a href="http://requirejs.org/" target="_blank" rel="external">RequireJS</a>):</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>([<span class="string">'./immutable.min.js'</span>], <span class="function"><span class="keyword">function</span> (<span class="params">Immutable</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> map1 = Immutable.Map(&#123;a:<span class="number">1</span>, b:<span class="number">2</span>, c:<span class="number">3</span>&#125;);</span><br><span class="line">    <span class="keyword">var</span> map2 = map1.set(<span class="string">'b'</span>, <span class="number">50</span>);</span><br><span class="line">    map1.get(<span class="string">'b'</span>); <span class="comment">// 2</span></span><br><span class="line">    map2.get(<span class="string">'b'</span>); <span class="comment">// 50</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>If you’re using <a href="http://browserify.org/" target="_blank" rel="external">browserify</a>, the <code>immutable</code> npm module<br>also works from the browser.</p>
<h3 id="TypeScript"><a href="#TypeScript" class="headerlink" title="TypeScript"></a>TypeScript</h3><p>Use these Immutable collections and sequences as you would use native<br>collections in your <a href="http://typescriptlang.org" target="_blank" rel="external">TypeScript</a> programs while still taking<br>advantage of type generics, error detection, and auto-complete in your IDE.</p>
<p>Just add a reference with a relative path to the type declarations at the top<br>of your file.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///&lt;reference path='./node_modules/immutable/dist/immutable.d.ts'/&gt;</span></span><br><span class="line"><span class="keyword">import</span> Immutable = require(<span class="string">'immutable'</span>);</span><br><span class="line"><span class="keyword">var</span> map1: Immutable.Map&lt;string, number&gt;;</span><br><span class="line">map1 = Immutable.Map(&#123;a:<span class="number">1</span>, b:<span class="number">2</span>, c:<span class="number">3</span>&#125;);</span><br><span class="line"><span class="keyword">var</span> map2 = map1.set(<span class="string">'b'</span>, <span class="number">50</span>);</span><br><span class="line">map1.get(<span class="string">'b'</span>); <span class="comment">// 2</span></span><br><span class="line">map2.get(<span class="string">'b'</span>); <span class="comment">// 50</span></span><br></pre></td></tr></table></figure>
<p>其中，<code>Map</code> 是数据结构。</p>
<p><code>set</code> 设置 key，<code>get</code> 获取 key。</p>
<h2 id="The_case_for_Immutability"><a href="#The_case_for_Immutability" class="headerlink" title="The case for Immutability"></a>The case for Immutability</h2><p>Much of what makes application development difficult is tracking mutation and<br>maintaining state. Developing with immutable data encourages you to think<br>differently about how data flows through your application.</p>
<p>应用开发之所以复杂，在于要跟踪 变动（tracking mutations），维护状态。</p>
<p>使用 immutable data 可以鼓励从不同的角度看 data flows。</p>
<p>Subscribing to data events throughout your application creates a huge overhead of<br>book-keeping which can hurt performance, sometimes dramatically, and creates<br>opportunities for areas of your application to get out of sync with each other<br>due to easy to make programmer error. Since immutable data never changes,<br>subscribing to changes throughout the model is a dead-end and new data can only<br>ever be passed from above.</p>
<ul>
<li>订阅 data events 会创建很多记忆（book-keeping）负担，影响到性能，有时是严重性的。</li>
<li>分布在多个区块的数据可能会不一致</li>
<li>由于 immutable data 会可变，所以，订阅 data evetns 是死路。</li>
</ul>
<p>This model of data flow aligns well with the architecture of <a href="http://facebook.github.io/react/" target="_blank" rel="external">React</a><br>and especially well with an application designed using the ideas of <a href="http://facebook.github.io/flux/docs/overview.html" target="_blank" rel="external">Flux</a>.</p>
<p>这种 data flows 也催生出了 react 以及 flux 的设计</p>
<p>When data is passed from above rather than being subscribed to, and you’re only<br>interested in doing work when something has changed, you can use equality.</p>
<p>数据是 passed，不是 subscribed。</p>
<p>Immutable collections should be treated as <em>values</em> rather than <em>objects</em>. While<br>objects represents some thing which could change over time, a value represents<br>the state of that thing at a particular instance of time. This principle is most<br>important to understanding the appropriate use of immutable data. In order to<br>treat Immutable.js collections as values, it’s important to use the<br><code>Immutable.is()</code> function or <code>.equals()</code> method to determine value equality<br>instead of the <code>===</code> operator which determines object reference identity.</p>
<p>Immutable 集合应该当做 <em>values</em>，而不是 <em>objects</em>。值不会变，代表着一个时间的一个实例。</p>
<p>所以，objects 相关的都不要用。</p>
<p>要用：</p>
<p><code>Immutable.is()</code> 或者 <code>equals()</code> 方法，不要用 <code>===</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> map1 = Immutable.Map(&#123;a:<span class="number">1</span>, b:<span class="number">2</span>, c:<span class="number">3</span>&#125;);</span><br><span class="line"><span class="keyword">var</span> map2 = map1.set(<span class="string">'b'</span>, <span class="number">2</span>);</span><br><span class="line">assert(map1.equals(map2) === <span class="literal">true</span>);</span><br><span class="line"><span class="keyword">var</span> map3 = map1.set(<span class="string">'b'</span>, <span class="number">50</span>);</span><br><span class="line">assert(map1.equals(map3) === <span class="literal">false</span>);</span><br></pre></td></tr></table></figure>
<p>Note: As a performance optimization <code>Immutable</code> attempts to return the existing<br>collection when an operation would result in an identical collection, allowing<br>for using <code>===</code> reference equality to determine if something definitely has not<br>changed. This can be extremely useful when used within memoization function<br>which would prefer to re-run the function if a deeper equality check could<br>potentially be more costly. The <code>===</code> equality check is also used internally by<br><code>Immutable.is</code> and <code>.equals()</code> as a performance optimization.</p>
<p>注意：性能优化原因，有时 <code>Immutable</code> 会返回一样的 collection（如果从值上看一样的话），这时候 <code>===</code> 的结果也是对的。<br>这个在 memoization function 运行 deep equality check 很有用，更简单了。</p>
<blockquote>
<p>注意：这里的 memoization function 就是 <code>shouldComponentUpdate</code>。</p>
</blockquote>
<p>If an object is immutable, it can be “copied” simply by making another reference<br>to it instead of copying the entire object. Because a reference is much smaller<br>than the object itself, this results in memory savings and a potential boost in<br>execution speed for programs which rely on copies (such as an undo-stack).</p>
<p>如果 object 是 immutable，就可以很简单的 copy，只要新建一个 reference，而不是复制整个对象。</p>
<p>reference 很小。也简化了内存，可能也会对依赖复制的应用增加执行速度。</p>
<p>这里的 copy，就是通过 <code>=</code>（赋值运算符）。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> map1 = Immutable.Map(&#123;a:<span class="number">1</span>, b:<span class="number">2</span>, c:<span class="number">3</span>&#125;);</span><br><span class="line"><span class="keyword">var</span> clone = map1;</span><br></pre></td></tr></table></figure>
<h2 id="JavaScript-first_API"><a href="#JavaScript-first_API" class="headerlink" title="JavaScript-first API"></a>JavaScript-first API</h2><p>While <code>immutable</code> is inspired by Clojure, Scala, Haskell and other functional<br>programming environments, it’s designed to bring these powerful concepts to<br>JavaScript, and therefore has an Object-Oriented API that closely mirrors that<br>of <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/New_in_JavaScript/ECMAScript_6_support_in_Mozilla" target="_blank" rel="external">ES6</a> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank" rel="external">Array</a>, <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map" target="_blank" rel="external">Map</a>, and <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Set" target="_blank" rel="external">Set</a>.</p>
<p>尽量接近 JavaScript 的标准。提供了镜像 Array，Map，Set 的面向对象的 API。</p>
<p>The difference for the immutable collections is that methods which would mutate<br>the collection, like <code>push</code>, <code>set</code>, <code>unshift</code> or <code>splice</code> instead return a new<br>immutable collection. Methods which return new arrays like <code>slice</code> or <code>concat</code><br>instead return new immutable collections.</p>
<p>区别是，<code>push</code>，<code>set</code>，<code>unshift</code>，<code>splice</code> 不会更改集合，而是返回一个系你的 immutable collection。</p>
<p>像 <code>slice</code> 和 <code>concat</code> 之前返回新的 arrays，会返回新的 immutable collections。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> list1 = Immutable.List.of(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">var</span> list2 = list1.push(<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">var</span> list3 = list2.unshift(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">var</span> list4 = list1.concat(list2, list3);</span><br><span class="line">assert(list1.size === <span class="number">2</span>);</span><br><span class="line">assert(list2.size === <span class="number">5</span>);</span><br><span class="line">assert(list3.size === <span class="number">6</span>);</span><br><span class="line">assert(list4.size === <span class="number">13</span>);</span><br><span class="line">assert(list4.get(<span class="number">0</span>) === <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>Almost all of the methods on <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array" target="_blank" rel="external">Array</a> will be found in similar form on<br><code>Immutable.List</code>, those of <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map" target="_blank" rel="external">Map</a> found on <code>Immutable.Map</code>, and those of <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Set" target="_blank" rel="external">Set</a><br>found on <code>Immutable.Set</code>, including collection operations like <code>forEach()</code><br>and <code>map()</code>.</p>
<p>Array -&gt; Immuable.List<br>Map -&gt; Immutable.Map<br>Set -&gt; Immutable.Set</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> alpha = Immutable.Map(&#123;a:<span class="number">1</span>, b:<span class="number">2</span>, c:<span class="number">3</span>, d:<span class="number">4</span>&#125;);</span><br><span class="line">alpha.map((v, k) =&gt; k.toUpperCase()).join();</span><br><span class="line"><span class="comment">// 'A,B,C,D'</span></span><br></pre></td></tr></table></figure>
<h3 id="Accepts_raw_JavaScript_objects"><a href="#Accepts_raw_JavaScript_objects" class="headerlink" title="Accepts raw JavaScript objects."></a>Accepts raw JavaScript objects.</h3><p>Designed to inter-operate with your existing JavaScript, <code>immutable</code><br>accepts plain JavaScript Arrays and Objects anywhere a method expects an<br><code>Iterable</code> with no performance penalty.</p>
<p>因为要和 JavaScript 代码交互，所以 <code>immutable</code> 可以接受 plain JavaScriptJavaScript Arrays 和 Objects（可以接收 <code>Iterable</code> 的方法）。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> map1 = Immutable.Map(&#123;a:<span class="number">1</span>, b:<span class="number">2</span>, c:<span class="number">3</span>, d:<span class="number">4</span>&#125;);</span><br><span class="line"><span class="keyword">var</span> map2 = Immutable.Map(&#123;c:<span class="number">10</span>, a:<span class="number">20</span>, t:<span class="number">30</span>&#125;);</span><br><span class="line"><span class="keyword">var</span> obj = &#123;d:<span class="number">100</span>, o:<span class="number">200</span>, g:<span class="number">300</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> map3 = map1.merge(map2, obj);</span><br><span class="line"><span class="comment">// Map &#123; a: 20, b: 2, c: 10, d: 100, t: 30, o: 200, g: 300 &#125;</span></span><br></pre></td></tr></table></figure>
<p>This is possible because <code>immutable</code> can treat any JavaScript Array or Object<br>as an Iterable. You can take advantage of this in order to get sophisticated<br>collection methods on JavaScript Objects, which otherwise have a very sparse<br>native API. Because Seq evaluates lazily and does not cache intermediate<br>results, these operations can be extremely efficient.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myObject = &#123;a:<span class="number">1</span>,b:<span class="number">2</span>,c:<span class="number">3</span>&#125;;</span><br><span class="line">Immutable.Seq(myObject).map(x =&gt; x * x).toObject();</span><br><span class="line"><span class="comment">// &#123; a: 1, b: 4, c: 9 &#125;</span></span><br></pre></td></tr></table></figure>
<p>Keep in mind, when using JS objects to construct Immutable Maps, that<br>JavaScript Object properties are always strings, even if written in a quote-less<br>shorthand, while Immutable Maps accept keys of any type.</p>
<p>记住一点，构造成 immutable 所有的 key 都会变成 string。即 <code>.get(key: string)</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123; <span class="number">1</span>: <span class="string">"one"</span> &#125;;</span><br><span class="line"><span class="built_in">Object</span>.keys(obj); <span class="comment">// [ "1" ]</span></span><br><span class="line">obj[<span class="string">"1"</span>]; <span class="comment">// "one"</span></span><br><span class="line">obj[<span class="number">1</span>];   <span class="comment">// "one"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> map = Immutable.fromJS(obj);</span><br><span class="line">map.get(<span class="string">"1"</span>); <span class="comment">// "one"</span></span><br><span class="line">map.get(<span class="number">1</span>);   <span class="comment">// undefined</span></span><br></pre></td></tr></table></figure>
<p>Property access for JavaScript Objects first converts the key to a string, but<br>since Immutable Map keys can be of any type the argument to <code>get()</code> is<br>not altered.</p>
<h3 id="Converts_back_to_raw_JavaScript_objects"><a href="#Converts_back_to_raw_JavaScript_objects" class="headerlink" title="Converts back to raw JavaScript objects."></a>Converts back to raw JavaScript objects.</h3><p>All <code>immutable</code> Iterables can be converted to plain JavaScript Arrays and<br>Objects shallowly with <code>toArray()</code> and <code>toObject()</code> or deeply with <code>toJS()</code>.<br>All Immutable Iterables also implement <code>toJSON()</code> allowing them to be passed to<br><code>JSON.stringify</code> directly.</p>
<p>变回 raw JavaScript objects。</p>
<p><code>toArray()</code>，<code>toObject()</code>，<code>toJS()</code>。</p>
<p><code>toJSON()</code>，可以直接传递给 <code>JSON.stringify</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> deep = Immutable.Map(&#123; a: <span class="number">1</span>, b: <span class="number">2</span>, c: Immutable.List.of(<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>) &#125;);</span><br><span class="line">deep.toObject() <span class="comment">// &#123; a: 1, b: 2, c: List [ 3, 4, 5 ] &#125;</span></span><br><span class="line">deep.toArray() <span class="comment">// [ 1, 2, List [ 3, 4, 5 ] ]</span></span><br><span class="line">deep.toJS() <span class="comment">// &#123; a: 1, b: 2, c: [ 3, 4, 5 ] &#125;</span></span><br><span class="line"><span class="built_in">JSON</span>.stringify(deep) <span class="comment">// '&#123;"a":1,"b":2,"c":[3,4,5]&#125;'</span></span><br></pre></td></tr></table></figure>
<h3 id="Embraces_ES6"><a href="#Embraces_ES6" class="headerlink" title="Embraces ES6"></a>Embraces ES6</h3><p><code>Immutable</code> takes advantage of features added to JavaScript in <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/New_in_JavaScript/ECMAScript_6_support_in_Mozilla" target="_blank" rel="external">ES6</a>,<br>the latest standard version of ECMAScript (JavaScript), including <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/The_Iterator_protocol" target="_blank" rel="external">Iterators</a>,<br><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions" target="_blank" rel="external">Arrow Functions</a>, <a href="http://wiki.ecmascript.org/doku.php?id=strawman:maximally_minimal_classes" target="_blank" rel="external">Classes</a>, and <a href="http://www.2ality.com/2014/09/es6-modules-final.html" target="_blank" rel="external">Modules</a>. It’s also inspired by the<br><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map" target="_blank" rel="external">Map</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Set" target="_blank" rel="external">Set</a> collections added to ES6. The library is “transpiled” to ES3<br>in order to support all modern browsers.</p>
<p>All examples are presented in ES6. To run in all browsers, they need to be<br>translated to ES3.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ES6</span></span><br><span class="line">foo.map(x =&gt; x * x);</span><br><span class="line"><span class="comment">// ES3</span></span><br><span class="line">foo.map(<span class="function"><span class="keyword">function</span> (<span class="params">x</span>) </span>&#123; <span class="keyword">return</span> x * x; &#125;);</span><br></pre></td></tr></table></figure>
<h2 id="Nested_Structures"><a href="#Nested_Structures" class="headerlink" title="Nested Structures"></a>Nested Structures</h2><p>The collections in <code>immutable</code> are intended to be nested, allowing for deep<br>trees of data, similar to JSON.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> nested = Immutable.fromJS(&#123;a:&#123;b:&#123;c:[<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]&#125;&#125;&#125;);</span><br><span class="line"><span class="comment">// Map &#123; a: Map &#123; b: Map &#123; c: List [ 3, 4, 5 ] &#125; &#125; &#125;</span></span><br></pre></td></tr></table></figure>
<p>A few power-tools allow for reading and operating on nested data. The<br>most useful are <code>mergeDeep</code>, <code>getIn</code>, <code>setIn</code>, and <code>updateIn</code>, found on <code>List</code>,<br><code>Map</code> and <code>OrderedMap</code>.</p>
<p>这是一些帮助方法，可以帮助读取，操作嵌套结构。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> nested2 = nested.mergeDeep(&#123;a:&#123;b:&#123;d:<span class="number">6</span>&#125;&#125;&#125;);</span><br><span class="line"><span class="comment">// Map &#123; a: Map &#123; b: Map &#123; c: List [ 3, 4, 5 ], d: 6 &#125; &#125; &#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">nested2.getIn([<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'d'</span>]); <span class="comment">// 6</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> nested3 = nested2.updateIn([<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'d'</span>], value =&gt; value + <span class="number">1</span>);</span><br><span class="line"><span class="comment">// Map &#123; a: Map &#123; b: Map &#123; c: List [ 3, 4, 5 ], d: 7 &#125; &#125; &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> nested4 = nested3.updateIn([<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>], list =&gt; list.push(<span class="number">6</span>));</span><br><span class="line"><span class="comment">// Map &#123; a: Map &#123; b: Map &#123; c: List [ 3, 4, 5, 6 ], d: 7 &#125; &#125; &#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="Lazy_Seq"><a href="#Lazy_Seq" class="headerlink" title="Lazy Seq"></a>Lazy Seq</h2><p><code>Seq</code> describes a lazy operation, allowing them to efficiently chain<br>use of all the Iterable methods (such as <code>map</code> and <code>filter</code>).</p>
<p><strong>Seq is immutable</strong> — Once a Seq is created, it cannot be<br>changed, appended to, rearranged or otherwise modified. Instead, any mutative<br>method called on a Seq will return a new Seq.</p>
<p><strong>Seq is lazy</strong> — Seq does as little work as necessary to respond to any<br>method call.</p>
<p>For example, the following does not perform any work, because the resulting<br>Seq is never used:</p>
<pre><code>var oddSquares = Immutable.Seq.of(1,2,3,4,5,6,7,8)
  .filter(x =&gt; x % 2).map(x =&gt; x * x);
</code></pre><p>Once the Seq is used, it performs only the work necessary. In this<br>example, no intermediate arrays are ever created, filter is called three times,<br>and map is only called twice:</p>
<pre><code>console.log(oddSquares.get(1)); // 9
</code></pre><p>Any collection can be converted to a lazy Seq with <code>.toSeq()</code>.</p>
<pre><code>var seq = Immutable.Map({a:1, b:1, c:1}).toSeq();
</code></pre><p>Seq allow for the efficient chaining of sequence operations, especially when<br>converting to a different concrete type (such as to a JS object):</p>
<pre><code>seq.flip().map(key =&gt; key.toUpperCase()).flip().toObject();
// Map { A: 1, B: 1, C: 1 }
</code></pre><p>As well as expressing logic that would otherwise seem memory-limited:</p>
<pre><code>Immutable.Range(1, Infinity)
  .skip(1000)
  .map(n =&gt; -n)
  .filter(n =&gt; n % 2 === 0)
  .take(2)
  .reduce((r, n) =&gt; r * n, 1);
// 1006008
</code></pre><p>Note: An iterable is always iterated in the same order, however that order may<br>not always be well defined, as is the case for the <code>Map</code>.</p>
<h2 id="Equality_treats_Collections_as_Data"><a href="#Equality_treats_Collections_as_Data" class="headerlink" title="Equality treats Collections as Data"></a>Equality treats Collections as Data</h2><p><code>Immutable</code> provides equality which treats immutable data structures as pure<br>data, performing a deep equality check if necessary.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> map1 = Immutable.Map(&#123;a:<span class="number">1</span>, b:<span class="number">1</span>, c:<span class="number">1</span>&#125;);</span><br><span class="line"><span class="keyword">var</span> map2 = Immutable.Map(&#123;a:<span class="number">1</span>, b:<span class="number">1</span>, c:<span class="number">1</span>&#125;);</span><br><span class="line">assert(map1 !== map2); <span class="comment">// two different instances</span></span><br><span class="line">assert(Immutable.is(map1, map2)); <span class="comment">// have equivalent values</span></span><br><span class="line">assert(map1.equals(map2)); <span class="comment">// alternatively use the equals method</span></span><br></pre></td></tr></table></figure>
<p><code>Immutable.is()</code> uses the same measure of equality as <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/is" target="_blank" rel="external">Object.is</a><br>including if both are immutable and all keys and values are equal<br>using the same measure of equality.</p>
<h2 id="Batching_Mutations"><a href="#Batching_Mutations" class="headerlink" title="Batching Mutations"></a>Batching Mutations</h2><blockquote>
<p>If a tree falls in the woods, does it make a sound?</p>
<p>If a pure function mutates some local data in order to produce an immutable<br>return value, is that ok?</p>
<p>— Rich Hickey, Clojure</p>
</blockquote>
<p>Applying a mutation to create a new immutable object results in some overhead,<br>which can add up to a minor performance penalty. If you need to apply a series<br>of mutations locally before returning, <code>Immutable</code> gives you the ability to<br>create a temporary mutable (transient) copy of a collection and apply a batch of<br>mutations in a performant manner by using <code>withMutations</code>. In fact, this is<br>exactly how  <code>Immutable</code> applies complex mutations itself.</p>
<p>As an example, building <code>list2</code> results in the creation of 1, not 3, new<br>immutable Lists.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> list1 = Immutable.List.of(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>);</span><br><span class="line"><span class="keyword">var</span> list2 = list1.withMutations(<span class="function"><span class="keyword">function</span> (<span class="params">list</span>) </span>&#123;</span><br><span class="line">  list.push(<span class="number">4</span>).push(<span class="number">5</span>).push(<span class="number">6</span>);</span><br><span class="line">&#125;);</span><br><span class="line">assert(list1.size === <span class="number">3</span>);</span><br><span class="line">assert(list2.size === <span class="number">6</span>);</span><br></pre></td></tr></table></figure>
<p>Note: <code>immutable</code> also provides <code>asMutable</code> and <code>asImmutable</code>, but only<br>encourages their use when <code>withMutations</code> will not suffice. Use caution to not<br>return a mutable copy, which could result in undesired behavior.</p>
<p><em>Important!</em>: Only a select few methods can be used in <code>withMutations</code> including<br><code>set</code>, <code>push</code> and <code>pop</code>. These methods can be applied directly against a<br>persistent data-structure where other methods like <code>map</code>, <code>filter</code>, <code>sort</code>,<br>and <code>splice</code> will always return new immutable data-structures and never mutate<br>a mutable collection.</p>
<h2 id="Documentation"><a href="#Documentation" class="headerlink" title="Documentation"></a>Documentation</h2><p><a href="http://facebook.github.io/immutable-js/docs/" target="_blank" rel="external">Read the docs</a> and eat your vegetables.</p>
<p>Docs are automatically generated from <a href="https://github.com/facebook/immutable-js/blob/master/type-definitions/Immutable.d.ts" target="_blank" rel="external">Immutable.d.ts</a>.<br>Please contribute!</p>
<p>Also, don’t miss the <a href="https://github.com/facebook/immutable-js/wiki" target="_blank" rel="external">Wiki</a> which<br>contains articles on specific topics. Can’t find something? Open an <a href="https://github.com/facebook/immutable-js/issues" target="_blank" rel="external">issue</a>.</p>
<h2 id="Contribution"><a href="#Contribution" class="headerlink" title="Contribution"></a>Contribution</h2><p>Use <a href="https://github.com/facebook/immutable-js/issues" target="_blank" rel="external">Github issues</a> for requests.</p>
<p>We actively welcome pull requests, learn how to <a href="./CONTRIBUTING.md">contribute</a>.</p>
<h2 id="Changelog"><a href="#Changelog" class="headerlink" title="Changelog"></a>Changelog</h2><p>Changes are tracked as <a href="https://github.com/facebook/immutable-js/releases" target="_blank" rel="external">Github releases</a>.</p>
<h2 id="Thanks"><a href="#Thanks" class="headerlink" title="Thanks"></a>Thanks</h2><p><a href="https://www.youtube.com/watch?v=K2NYwP90bNs" target="_blank" rel="external">Phil Bagwell</a>, for his inspiration<br>and research in persistent data structures.</p>
<p><a href="https://github.com/hughfdjackson/" target="_blank" rel="external">Hugh Jackson</a>, for providing the npm package<br>name. If you’re looking for his unsupported package, see <a href="https://www.npmjs.org/package/immutable/1.4.1" target="_blank" rel="external">v1.4.1</a>.</p>
<h2 id="License"><a href="#License" class="headerlink" title="License"></a>License</h2><p><code>Immutable</code> is <a href="./LICENSE">BSD-licensed</a>. We also provide an additional <a href="./PATENTS">patent grant</a>.</p>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="Immutable_collections_for_JavaScript"><a href="#Immutable_collections_for_JavaScript" class="headerlink" title="Immutable collection]]>
    </summary>
    
  </entry>
  
  <entry>
    <title><![CDATA[Redux - multiple stores, why not?]]></title>
    <link href="http://shane.hsi.rocks/2016/03/14/Redux-multiple-stores-why-not/"/>
    <id>http://shane.hsi.rocks/2016/03/14/Redux-multiple-stores-why-not/</id>
    <published>2016-03-14T08:55:32.000Z</published>
    <updated>2016-03-14T09:12:11.000Z</updated>
    <content type="html"><![CDATA[<p>实话说，我不认为一个 store 是好事情。</p>
<p>实话说，我不认为多个 store 会出什么问题。当然也遇到过问题：</p>
<ul>
<li>如果一个 store 保存 当前考核周期</li>
<li>另一个 store 会根据当前考核周期获取考核群体列表</li>
</ul>
<p>这样 store 之间拿数据很麻烦。</p>
<p>如果是一个 store 就很方便。其实没有遇到过 flux 中的 <code>waitFor</code> 的场景。即使遇到，redux 也无法解决。它本身也是按照顺序执行 reducer 更新 state 的。</p>
<p>最大的问题就是，拿数据很麻烦。毕竟逻辑上分开了。有时又要它们在一起使用。这块没有 common pattern。</p>
<p><a href="http://stackoverflow.com/questions/33619775/redux-multiple-stores-why-not" target="_blank" rel="external">stackoverflow - Redux - multiple stores, why not?</a></p>
<h2 id="Question"><a href="#Question" class="headerlink" title="Question"></a>Question</h2><p>As a note: I’ve read the docs for Redux (Baobab, too), and I’ve done a fair share of Googling &amp; testing.</p>
<p>Why is it so strongly suggested that a Redux app have only one store?</p>
<p>I understand the pros/cons of a single-store setup vs a multiple store setup (There are many Q&amp;A on SO on this subject).</p>
<p>IMO, this architectural decision belongs to the app developers <strong>based on their projects’ needs</strong>. So why is it so strongly suggested for Redux, almost to the point of sounding mandatory (though nothing is stopping us from making multiple stores)?</p>
<p>EDIT: feedback after converting to single-store</p>
<p><strong>After a few months working with redux on what many would consider a complex SPA, I can say that the single store structure has been a pure delight to work with.</strong> </p>
<p>作者反水了。看看原因。</p>
<p>A few points that might help others understand why single store vs many store is a moot question in many, many use-cases:</p>
<ul>
<li>it’s reliable: we use selectors to dig through the app state and obtain context-relevant information. We know that all the needed data is in a single store. It avoids all questioning as to where state issues could be.</li>
</ul>
<p>还好。实变形不变。</p>
<ul>
<li>it’s fast: our store currently has close to 100 reducers, if not more. Even at that count, only a handful of reducers process data on any given dispatch, the others just return the previous state. The argument that a huge/complex store (nbr of reducers) is slow is pretty much moot. At least we’ve not seen any performance issues coming from there.</li>
</ul>
<p>store 会慢吗？逻辑多，或者不必要的逻辑多才会慢。</p>
<ul>
<li>debugging friendly: while this is a most convincing argument to use redux as a whole, it also goes for single store vs multiple store. When building an app you’re bound to have state errors in the process (programmer mistakes), it’s normal. The PITA is when those errors take hours to debug. Thanks to the single store (and redux-logger) we’ve never spent more than a few minutes on any given state issue.<br>a few pointers</li>
</ul>
<p>The true challenge in building your redux store is when deciding how to structure it. Firstly, because changing structure down the road is just a major pain. Secondly, because it largely determines how you’ll be using, and querying your app data for any process. There are many suggestions on how to structure a store. In our case we found the following to be ideal:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  apis: &#123;     <span class="comment">// data from various services</span></span><br><span class="line">    api1: &#123;&#125;,</span><br><span class="line">    api2: &#123;&#125;,</span><br><span class="line">    ...</span><br><span class="line">  &#125;, </span><br><span class="line">  components: &#123;&#125; <span class="comment">// UI state data for each widget, component, you name it </span></span><br><span class="line">  session: &#123;&#125; <span class="comment">// session-specific information</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Hopefully this feedback will help others.</p>
<hr>
<h2 id="Answer"><a href="#Answer" class="headerlink" title="Answer"></a>Answer</h2><p>There are edge cases when you might use multiple stores (e.g. if you have performance problems with updating lists of thousands of items that are on screen at the same time many times per second). That said it’s an exception, and in most apps you never need more than a single store.</p>
<p>作者说，只有考虑到性能，才会用到多个 stores。</p>
<p>Why do we stress this in the docs? Because most people coming from Flux will assume multiple stores is the solution to making update code modular. However Redux has a different solution for this: reducer composition.</p>
<p>所以嘛？就是实变形不变（逻辑上一致的）。</p>
<p>Having multiple reducers that are further split into a reducer tree is how you keep updates modular in Redux. If you don’t recognize this, and go for multiple stores without fully understanding reducer composition first, you will miss many benefits of Redux single store architecture:</p>
<p>Using reducer composition makes it easy to implement “dependent updates” a la waitFor in Flux by writing a reducer manually calling other reducers with additional information and in a specific order.</p>
<p>reducer 是通过 function 来组合。而且 waitFor 也可以通过顺序调用 reducer 实现。</p>
<p>当然，Rx 的 stream 也可以组合啊。</p>
<p>With a single store, it’s very easy to persist, hydrate, and read the state. Server rendering and data prefetching is trivial because there is just one data storage that needs to be filled and rehydrated on the client, and JSON can describe its contents without worrying about store’s ID or name.</p>
<p>在 store -&gt; view 之间给一个点，介入这个点就可以。比如直接一个 Store.subject.onNext(…, initalState)。</p>
<p>A single store makes Redux DevTools time travel features possible. It also makes community extensions like redux-undo or redux-optimist easy because they operate on the reducer level. Such “reducer enhancers” can’t be written for stores.</p>
<p>但是，我对 DE 没啥兴趣。time travel 到可以做。</p>
<p>Single store guarantees that the subscriptions are called only after the dispatch has been processed. That is, by the time listeners are notified, the state has been fully updated. With many stores, there is no such guarantees. This is one of the reasons Flux needs the waitFor crutch. With a single store, this is not a problem you see in the first place.</p>
<p>这个的确是，只监听一个 store，所有的 reducer 都是完成了，才告诉 view 可以更新了。</p>
<p>Above all, multiple stores are unnecessary in Redux (except for performance edge cases which you are supposed to profile first anyway). We make it an important point in the docs so you are encouraged to learn reducer composition and other Redux patterns instead of using Redux as if it was Flux, and losing its benefits.</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>实话说，我不认为一个 store 是好事情。</p>
<p>实话说，我不认为多个 store 会出什么问题。当然也遇到过问题：</p>
<ul>
<li>如果一个 store 保存 当前考核周期</li>
<li>另一个 store 会根据当前考核周期获取考核群体列表</l]]>
    </summary>
    
  </entry>
  
  <entry>
    <title><![CDATA[Redux RxJS]]></title>
    <link href="http://shane.hsi.rocks/2016/03/14/Redux-RxJS/"/>
    <id>http://shane.hsi.rocks/2016/03/14/Redux-RxJS/</id>
    <published>2016-03-14T07:53:21.000Z</published>
    <updated>2016-03-14T11:02:42.000Z</updated>
    <content type="html"><![CDATA[<p>使用 RxJS 的目的是为了引入 stream 的操作。</p>
<ul>
<li>actions 作为 mutations 保留，并且 view 对 actions 是 imperative。</li>
<li><p>store 监听 action。</p>
</li>
<li><p>stream 在进入 store 之前 merge 一次。</p>
</li>
<li>store 到 view，最简单的是通过 throttle，交给 requestAnimationFrame。</li>
<li>（但是如果有 animation store，可以在加入一层 combine）</li>
</ul>
<p>附：</p>
<p><a href="https://gist.github.com/justinwoo/08f9f8fcdcf865025f18" target="_blank" rel="external">Using RxJS for data flow instead of Flux with React</a></p>
<p>Reposted from Qiita</p>
<p>For almost a year now, I’ve been using this “flux” architecture to organize my React applications and to work on other people’s projects, and its popularity has grown quite a lot, to the point where it shows up on job listings for React and a lot of people get confused about what it is.</p>
<h1 id="Why_I_u2019m_tired_of_using_and_teaching_flux"><a href="#Why_I_u2019m_tired_of_using_and_teaching_flux" class="headerlink" title="Why I’m tired of using and teaching flux"></a>Why I’m tired of using and teaching flux</h1><p>There are a billion explainations on the internet, so I’ll skip explaining the parts. Instead, let’s cut to the chase – the main parts I hate about flux are the Dispatcher and the Store’s own updating mechanism.</p>
<p>If you use a setup similar to the examples in facebook/flux, and you use flux.Dispatcher, you probably have this kind of flow:</p>
<ol>
<li>You have a method on an <code>Action</code> object that you call, which then does <code>Dispatcher.prototype.dispatch(payload)</code>, where <code>payload</code> is <code>actionType: String, {...}</code></li>
<li>flux.Dispatcher dispatches only that single payload, and doesn’t let anything else happen. It goes through registered callbacks, calling each one with this payload.</li>
<li>All of your registered callbacks fire off, in your <code>Store</code> objects’ closures. The values in your Stores’ closures get set and then you call <code>Store.emitChange</code>.</li>
<li><code>Store.emitChange</code> then uses <code>EventEmitter.prototype.emit</code> to call callbacks you registered with <code>EventEmitter.prototype.addListener</code> for whatever key you used, like <code>&#39;change&#39;</code> or something.</li>
<li>Your callback was probably defined in your component, in which case it would then call <code>this.setState</code> but also have to call <code>Store.getState</code> to retrieve your application’s state.</li>
</ol>
<p>No wonder there are tons of questions about flux, because seriously, what the flux is this? And if you think this is just extra information nobody cares about, guess what you have to think and worry about when you need to have all of the separate store states come together to make up your whole application state? When you have one store update that then triggers another action to update another store? Or you could also just add an event listener to that Store’s emitChange so that you can update your dependent store and emit a change event too.</p>
<p>And so at the end of the day, all the store does is use its callbacks on the Dispatcher to receive actions, act on them, emit its own events to consume itself, and then call callbacks which call methods on the Store to update your components.</p>
<p>I haven’t seen any flux library implement anything that doesn’t look like this. It may not use flux.Dispatcher (though most do) or EventEmitter (though, a lot of them do also), but they almost always come down to this same system, and the only benefit they provide is that you don’t have to provide your own Dispatcher or Store implementation (in which you consume theirs, which almost always works in the same way).</p>
<p>Did I mention I also hate how you’re supposed to load up your application state? Most of the time, you don’t want to render without having your Store’s state, so you have to use <code>getInitialState</code> to do it. What ends up happening, inevitably, is that you end up with a method called <code>getAppState</code> which does <code>return Store.getAppState()</code> and you use that in <code>getInitialState</code> and your <code>onChange</code> handler which probably is <code>this.setState(getAppState())</code> and will get called back like so in your Store. Ugh.</p>
<p>这个还好，不是因为 getInitalState()，而是因为就要从 store 中获取 state。在 redux 中也用 selector 实现。</p>
<h1 id="Using_RxJS_instead"><a href="#Using_RxJS_instead" class="headerlink" title="Using RxJS instead"></a>Using RxJS instead</h1><p>So instead of all that crap we get in our flux setup, let’s just use RxJS. A few things you’ll want to know:</p>
<ol>
<li><a href="https://github.com/Reactive-Extensions/RxJS/blob/master/doc/api/core/observable.md" target="_blank" rel="external">Rx.Observable</a> – these are the observable “streams” that you can subscribe to, where the value coming down is either what is provided by the source, or transformed by something.</li>
<li><a href="https://github.com/Reactive-Extensions/RxJS/blob/master/doc/api/core/operators/subscribe.md" target="_blank" rel="external">Rx.Observable.prototype.subscribe</a> – this is what you use to register an observer in the end to the values coming out of your stream.</li>
<li><a href="https://github.com/Reactive-Extensions/RxJS/blob/master/doc/api/subjects/subject.md" target="_blank" rel="external">Rx.Subject</a> – these are Observables that provide some other features also, but I’m mostly concerned with onNext, which lets me publish the newest value of my stream.</li>
</ol>
<h2 id="A_note_about_using_ReplaySubject"><a href="#A_note_about_using_ReplaySubject" class="headerlink" title="A note about using ReplaySubject"></a>A note about using ReplaySubject</h2><p>Instead of doing the awkward thing of figuring out how to load up our application state and then observe our stream, I think we should just use the ReplaySubject with a buffer of 1, i.e., when we subscribe to this, we want the latest value sent to us to use it as if we are getting fresh data from the stream.</p>
<p>1 代表最近的一次值。</p>
<h2 id="Actually_building_our_application"><a href="#Actually_building_our_application" class="headerlink" title="Actually building our application"></a>Actually building our application</h2><p>For our simple example, I’m just going to build a clicking application.</p>
<h3 id="Setting_up_Keys"><a href="#Setting_up_Keys" class="headerlink" title="Setting up Keys"></a>Setting up Keys</h3><p>For a variety of reasons, we want to use keys to identify Intents to our Model so it can handle data changes appropriately.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> keyMirror = <span class="built_in">require</span>(<span class="string">'keymirror'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = keyMirror(&#123;</span><br><span class="line">  INCREMENT_COUNTER: <span class="literal">null</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>能不能不要这个 key 的逻辑？直连而不是先存储，再根据 key 检索。</p>
<h3 id="Seting_up_our_Intents"><a href="#Seting_up_our_Intents" class="headerlink" title="Seting up our Intents"></a>Seting up our Intents</h3><p>Instead of using a dispatcher, we’re just going to provide a stream of user Intents and let our Model handle them as necessary. I’m just going to use a ReplaySubject since it’s easy enough to use, though we will likely never need a replay.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Rx = <span class="built_in">require</span>(<span class="string">'rx'</span>);</span><br><span class="line"><span class="keyword">var</span> Keys = <span class="built_in">require</span>(<span class="string">'./keys'</span>);</span><br><span class="line"><span class="keyword">var</span> intentSubject = <span class="keyword">new</span> Rx.ReplaySubject(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  subject: intentSubject,</span><br><span class="line"></span><br><span class="line">  incrementCounter: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    intentSubject.onNext(&#123;</span><br><span class="line">      key: Keys.INCREMENT_COUNTER</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>And so you can see that when <code>Intent.incrementCounter()</code> is called, our subject will publish a payload.</p>
<p>这里我还是叫做 actions 吧。只是包装成 stream 了而已。</p>
<h3 id="Setting_up_our_Model"><a href="#Setting_up_our_Model" class="headerlink" title="Setting up our Model"></a>Setting up our Model</h3><p>Now comes the interesting part, where we need to subscribe to our Intents so we can handle them appropriately. This is so easy, it’s boring.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Rx = <span class="built_in">require</span>(<span class="string">'rx'</span>);</span><br><span class="line"><span class="keyword">var</span> update = <span class="built_in">require</span>(<span class="string">'react/lib/update'</span>);</span><br><span class="line"><span class="keyword">var</span> Keys = <span class="built_in">require</span>(<span class="string">'./keys'</span>);</span><br><span class="line"><span class="keyword">var</span> Intent = <span class="built_in">require</span>(<span class="string">'./intent'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subject = <span class="keyword">new</span> Rx.ReplaySubject(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> state = &#123;</span><br><span class="line">  counter: <span class="number">0</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这个是 helpers 可以单独拿出来</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">incrementCounter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  state = update(state, &#123;</span><br><span class="line">    $merge: &#123;</span><br><span class="line">      counter: state.counter + <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  subject.onNext(state);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Intent.subject.subscribe(<span class="function"><span class="keyword">function</span> (<span class="params">payload</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span>(payload.key) &#123;</span><br><span class="line">    <span class="keyword">case</span> Keys.INCREMENT_COUNTER:</span><br><span class="line">      incrementCounter();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="built_in">console</span>.warn(<span class="string">`<span class="subst">$&#123;payload.key&#125;</span> not recognized in model.`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">subject.onNext(state);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  subject: subject</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>And so we can see that the Model has its own ReplaySubject(1), and handled intents will make our subject publish our new application state.</p>
<h3 id="Setting_up_our_root_component"><a href="#Setting_up_our_root_component" class="headerlink" title="Setting up our root component"></a>Setting up our root component</h3><p>So our Store was dead easy to set up. Surely, there’s going to be a lot of work to set up our root component, right? Well, I really hate having to mess with component state, so I decided to just shove it all into props instead.</p>
<p>// 我也是，不要 state。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> React = <span class="built_in">require</span>(<span class="string">'react'</span>);</span><br><span class="line"><span class="keyword">var</span> Rx = <span class="built_in">require</span>(<span class="string">'rx'</span>);</span><br><span class="line"><span class="keyword">var</span> Model = <span class="built_in">require</span>(<span class="string">'./model'</span>);</span><br><span class="line"><span class="keyword">var</span> Root = <span class="built_in">require</span>(<span class="string">'./views/root'</span>);</span><br><span class="line"></span><br><span class="line">Model.subject.subscribe((appState) =&gt; &#123;</span><br><span class="line">  React.render(</span><br><span class="line">    <span class="xml"><span class="tag">&lt;<span class="title">Root</span> &#123;<span class="attribute">...appState</span>&#125;/&gt;</span>, document.getElementById('app') /&gt;</span><br><span class="line">  )</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><code>Model.subject</code> is a <code>Rx.Observable</code>, and by using <code>Rx.Observable.prototype.subscribe</code>, we are able to subscribe an observer which renders our application using the appState data published to it. And because we used a <code>ReplaySubject(1)</code>, the initializing <code>subject.onNext(state)</code> in our model plays back, rendering our application. This part is pretty boring too, since we didn’t write much code at all.</p>
<p>In the end, it looks like this (after clicking the button some):</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/42481/1cd3d418-b816-4c7f-3f61-af73d1895b2a.png" alt="kobito.1430010588.424467.png" title="kobito.1430010588.424467.png"></p>
<p>Let’s look at some other demos since this was so short and boring.</p>
<h1 id="Dealing_with_multiple_Models"><a href="#Dealing_with_multiple_Models" class="headerlink" title="Dealing with multiple Models"></a>Dealing with multiple Models</h1><p>What if we have multiple Models that we need to subscribe to in order to get our application state? Well, in that case, we do need another Model and its stream.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Rx = <span class="built_in">require</span>(<span class="string">'rx'</span>);</span><br><span class="line"><span class="keyword">var</span> update = <span class="built_in">require</span>(<span class="string">'react/lib/update'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> YahharoKeys = <span class="built_in">require</span>(<span class="string">'../keys/yahharo-keys'</span>);</span><br><span class="line"><span class="keyword">var</span> YahharoIntent = <span class="built_in">require</span>(<span class="string">'../intents/yahharo-intent'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subject = <span class="keyword">new</span> Rx.ReplaySubject(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> yahharo = <span class="string">'やっはろー'</span>;</span><br><span class="line"><span class="keyword">var</span> haroharo = <span class="string">'はろはろー'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> state = &#123;</span><br><span class="line">  greeting: yahharo</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">switchGreeting</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  state = update(state, &#123;</span><br><span class="line">    $merge: &#123;</span><br><span class="line">      greeting: state.greeting === yahharo ? haroharo : yahharo</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  subject.onNext(state);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">YahharoIntent.subject.subscribe(<span class="function"><span class="keyword">function</span> (<span class="params">payload</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span>(payload.key) &#123;</span><br><span class="line">    <span class="keyword">case</span> YahharoKeys.SWITCH_GREETING:</span><br><span class="line">      switchGreeting();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="built_in">console</span>.warn(<span class="string">`<span class="subst">$&#123;payload.key&#125;</span> not recognized in model.`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">subject.onNext(state);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  subject: subject</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>But how do we handle the logic for combining the two streams? Well, time to call <a href="https://github.com/Reactive-Extensions/RxJS/blob/master/doc/api/core/operators/combinelatest.md" target="_blank" rel="external">Rx.Observable.combineLatest</a>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> React = <span class="built_in">require</span>(<span class="string">'react'</span>);</span><br><span class="line"><span class="keyword">var</span> Rx = <span class="built_in">require</span>(<span class="string">'rx'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> CounterModel = <span class="built_in">require</span>(<span class="string">'./models/counter-model'</span>);</span><br><span class="line"><span class="keyword">var</span> YahharoModel = <span class="built_in">require</span>(<span class="string">'./models/yahharo-model'</span>);</span><br><span class="line"><span class="keyword">var</span> Root = <span class="built_in">require</span>(<span class="string">'./views/root'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> AppObservable = Rx.Observable.combineLatest(</span><br><span class="line">  CounterModel.subject,</span><br><span class="line">  YahharoModel.subject,</span><br><span class="line">  <span class="function"><span class="keyword">function</span> (<span class="params"></span><br><span class="line">    CounterState,</span><br><span class="line">    YahharoState</span><br><span class="line">  </span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      CounterState: CounterState,</span><br><span class="line">      YahharoState: YahharoState</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">AppObservable.subscribe((appState) =&gt; &#123;</span><br><span class="line">  React.render(</span><br><span class="line">    <span class="xml"><span class="tag">&lt;<span class="title">Root</span> &#123;<span class="attribute">...appState</span>&#125;/&gt;</span>,</span><br><span class="line">    document.getElementById('app')</span><br><span class="line">  );</span><br><span class="line">&#125;);</span></span><br></pre></td></tr></table></figure>
<p>As we can see, we can just use RxJS to take the latest data from all three and combine them into a new Observable to feed into our Root component:</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/42481/2e866e3c-afcf-cd3e-8ace-136700114980.png" alt="kobito.1430010899.143385.png" title="kobito.1430010899.143385.png"></p>
<p>Let’s do another since this one was pretty short too.</p>
<h1 id="Dependent_events"><a href="#Dependent_events" class="headerlink" title="Dependent events"></a>Dependent events</h1><p>This one is pretty annoying for me currently, setting up a store that only does logical operations, and then having its emitChange trigger another store that does calculations based on it.</p>
<p>Let’s consider this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> state = &#123;</span><br><span class="line">  counter: <span class="number">0</span>,</span><br><span class="line">  list: [],</span><br><span class="line">  filterEvens: <span class="literal">true</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">incrementCounter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  state = update(state, &#123;</span><br><span class="line">    $merge: &#123;</span><br><span class="line">      counter: state.counter + <span class="number">1</span>,</span><br><span class="line">      list: state.list.concat(state.counter)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  subject.onNext(state);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>That <code>filterEvens</code> will get switched between true and false, for filtering out even values (of course, in the real world, I have a list of predicates that will go through a big list to figure out what gets rendered and gets unmounted).</p>
<p>Turns out, this is one of the most common operations in Rx. To write a transform that applies to each published event, we end up using <a href="https://github.com/Reactive-Extensions/RxJS/blob/master/doc/api/core/operators/select.md" target="_blank" rel="external">Rx.Observable.prototype.map</a>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> React = <span class="built_in">require</span>(<span class="string">'react'</span>);</span><br><span class="line"><span class="keyword">var</span> Rx = <span class="built_in">require</span>(<span class="string">'rx'</span>);</span><br><span class="line"><span class="keyword">var</span> update = <span class="built_in">require</span>(<span class="string">'react/lib/update'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> Model = <span class="built_in">require</span>(<span class="string">'./model'</span>);</span><br><span class="line"><span class="keyword">var</span> Root = <span class="built_in">require</span>(<span class="string">'./views/root'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> FilteredObservable = Model.subject.map(<span class="function"><span class="keyword">function</span> (<span class="params">appState</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> filteredList = appState.list.filter(<span class="function"><span class="keyword">function</span> (<span class="params">item</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> isEven = item % <span class="number">2</span> === <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> appState.filterEvens ? !isEven : isEven;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> update(appState, &#123;</span><br><span class="line">    $merge: &#123;</span><br><span class="line">      filteredList: filteredList</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">FilteredObservable.subscribe((appState) =&gt; &#123;</span><br><span class="line">  React.render(</span><br><span class="line">    <span class="xml"><span class="tag">&lt;<span class="title">Root</span> &#123;<span class="attribute">...appState</span>&#125;/&gt;</span>,</span><br><span class="line">    document.getElementById('app')</span><br><span class="line">  );</span><br><span class="line">&#125;);</span></span><br></pre></td></tr></table></figure>
<p>Again, we get a new Observable that we then subscribe to in order to render our application with the filtered data:</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/42481/a8ec0665-6ff6-eb6e-087d-2577007ba9e9.png" alt="kobito.1430011586.218478.png" title="kobito.1430011586.218478.png"></p>
<h1 id="In_Closing"><a href="#In_Closing" class="headerlink" title="In Closing"></a>In Closing</h1><p>I know I probably turned some people off talking about how much I hate flux when it’s honestly done a lot to change how people think about data flow in their applications. For that, flux remains quite significant to me and I think it’s done quite a lot of good, but I am no longer content to use it to manage data flows in my applications. If you think otherwise, I hope you might consider taking the time to write to me on why you think I should change my practices when using flux to make it a more enjoyable and productive experience.</p>
<p>Otherwise, if you were intrigued by the use of RxJS and want to see the source code for this article, see the repo here: <a href="https://github.com/justinwoo/react-rxjs-flow" target="_blank" rel="external">https://github.com/justinwoo/react-rxjs-flow</a></p>
<p>If you made it this far, thanks for reading!</p>
<h2 id="Update_-_Apr_26"><a href="#Update_-_Apr_26" class="headerlink" title="Update - Apr 26"></a>Update - Apr 26</h2><p>Do you have thoughts about using a Rx.Subject for each intent rather than using the intent keys system? I did the keys-based system for this demonstration, but I’m still on the fence about whether or not I’m going to use keys to identify payloads or use separate subjects. Let me know on <a href="https://twitter.com/jusrin00" target="_blank" rel="external">twitter</a> what you think!</p>
<h2 id="Update_-_Apr_28"><a href="#Update_-_Apr_28" class="headerlink" title="Update - Apr 28"></a>Update - Apr 28</h2><p>I pushed another branch that gets rid of the Keys-based single subject with multiple subjects that can be subscribed to here: <a href="https://github.com/justinwoo/react-rxjs-flow/tree/each-intent-subject" target="_blank" rel="external">https://github.com/justinwoo/react-rxjs-flow/tree/each-intent-subject</a>. Seems pretty nice, thanks to <a href="https://twitter.com/saneyuki_s" target="_blank" rel="external">@saneyuki_s</a> for the suggestion.</p>
<h2 id="Update_-_Sep_27"><a href="#Update_-_Sep_27" class="headerlink" title="Update - Sep 27"></a>Update - Sep 27</h2><p>A lot of this is very early rough drafts of how you might use Rx for your data modeling. A lot of the time, if you need a stream with a initial value that you use but then gets updated (like window size, etc.), you might/will probably be better off using the <code>.startWith</code> or <code>.just</code> operators instead of Subjects. Regardless, I hope you find this a little bit useful to thinking about new ways to do things ;)</p>
<h2 id="External_links"><a href="#External_links" class="headerlink" title="External links"></a>External links</h2><ul>
<li>Repo: <a href="https://github.com/justinwoo/react-rxjs-flow" target="_blank" rel="external">https://github.com/justinwoo/react-rxjs-flow</a><ul>
<li>Multiple models: <a href="https://github.com/justinwoo/react-rxjs-flow/tree/multiple-models-intents" target="_blank" rel="external">https://github.com/justinwoo/react-rxjs-flow/tree/multiple-models-intents</a></li>
<li>Transform: <a href="https://github.com/justinwoo/react-rxjs-flow/tree/subject-transform" target="_blank" rel="external">https://github.com/justinwoo/react-rxjs-flow/tree/subject-transform</a></li>
<li>Separate Subjects per intent: <a href="https://github.com/justinwoo/react-rxjs-flow/tree/each-intent-subject" target="_blank" rel="external">https://github.com/justinwoo/react-rxjs-flow/tree/each-intent-subject</a></li>
</ul>
</li>
<li>RxJS: <a href="https://github.com/Reactive-Extensions/RxJS" target="_blank" rel="external">https://github.com/Reactive-Extensions/RxJS</a></li>
<li>The staltz intro to Reactive Programming: <a href="https://gist.github.com/staltz/868e7e9bc2a7b8c1f754" target="_blank" rel="external">https://gist.github.com/staltz/868e7e9bc2a7b8c1f754</a></li>
<li>Another crappy article I wrote on RxJS usage: <a href="http://qiita.com/kimagure/items/88d2cd9c3d7aeaa1ac73" target="_blank" rel="external">http://qiita.com/kimagure/items/88d2cd9c3d7aeaa1ac73</a></li>
<li>Rx Marbles, because pictures are worth a lot of words: <a href="http://rxmarbles.com/" target="_blank" rel="external">http://rxmarbles.com/</a></li>
</ul>
]]></content>
    <summary type="html">
    <![CDATA[<p>使用 RxJS 的目的是为了引入 stream 的操作。</p>
<ul>
<li>actions 作为 mutations 保留，并且 view 对 actions 是 imperative。</li>
<li><p>store 监听 action。</p>
</li>
]]>
    </summary>
    
  </entry>
  
  <entry>
    <title><![CDATA[Reactive Programming with RxJS - 笔记]]></title>
    <link href="http://shane.hsi.rocks/2016/03/14/Read-Reactive-Programming-with-RxJS/"/>
    <id>http://shane.hsi.rocks/2016/03/14/Read-Reactive-Programming-with-RxJS/</id>
    <published>2016-03-14T06:28:04.000Z</published>
    <updated>2016-03-15T09:01:43.000Z</updated>
    <content type="html"><![CDATA[<p>Untangle Your Asynchronous JavaScript Code</p>
<blockquote>
<p>events happen in random order 事件不同顺序，就要管理事件<br>applications crash 就要重启<br>networks fails 就要重试<br>Few applications are completely synchronous 现状<br> need super-fast responses and  异步，快速响应。<br>the ability to process data from different sources at the same time without missing a beat. 同时处理多个源的数据的能力，不丢失。<br>code becomes expo- nentially more complex as we add concurrency and application state. 引入并发和应用状态，程序变非常复杂。</p>
</blockquote>
<h2 id="Ch1_-_The_Reactive_Way"><a href="#Ch1_-_The_Reactive_Way" class="headerlink" title="Ch1 - The Reactive Way"></a>Ch1 - The Reactive Way</h2><p>多个源头</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> button = <span class="built_in">document</span>.getElementById(<span class="string">'retrieveDataBtn'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source1 = Rx.DOM.getJSON(<span class="string">'/resource1'</span>).pluck(<span class="string">'name'</span>);</span><br><span class="line"><span class="keyword">var</span> source2 = Rx.DOM.getJSON(<span class="string">'/resource2'</span>).pluck(<span class="string">'props'</span>, <span class="string">'name'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getResults</span>(<span class="params">amount</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> source1.merge(source2)</span><br><span class="line">        .pluck(<span class="string">'names'</span>)</span><br><span class="line">        .flatMap(<span class="function"><span class="keyword">function</span>(<span class="params">array</span>) </span>&#123; <span class="keyword">return</span> Rx.Observable.from(array); &#125;</span><br><span class="line">            ).distinct()</span><br><span class="line">        .take(amount);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> clicks = Rx.Observable.fromEvent(button, <span class="string">'click'</span>);</span><br><span class="line"></span><br><span class="line">clicks.debounce(<span class="number">1000</span>)</span><br><span class="line">    .flatMap(getResults(<span class="number">5</span>))</span><br><span class="line">    .subscribe(</span><br><span class="line">        <span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123; <span class="built_in">console</span>.log(<span class="string">'Received value'</span>, value); &#125;,</span><br><span class="line">        <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123; <span class="built_in">console</span>.error(err); &#125;,</span><br><span class="line">        <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="built_in">console</span>.log(<span class="string">'All values retrieved!'</span>); &#125;</span><br><span class="line">    );</span><br></pre></td></tr></table></figure>
<p>重点：</p>
<ul>
<li>pluck 来做摘取</li>
<li>merge 来合并</li>
<li>flatMap 来展平</li>
<li>distinct 进行去重</li>
<li>take 取样</li>
<li>debounce 防抖</li>
<li>subscribe 订阅</li>
</ul>
<p>An Observable represents a stream of data.</p>
<p>再强调：Observable，可被观察到的事物。</p>
<p>这里面：</p>
<ul>
<li>两个 remote source 是 Observable</li>
<li>mouse clicks 是 Observable</li>
</ul>
<blockquote>
<p>后面会看到，<code>Subject</code> 可以做 proxy。方便构建架构。</p>
</blockquote>
<p><code>Rx.Observable.create</code></p>
<h2 id="Ch_2_-_Deep_in_the_Sequence"><a href="#Ch_2_-_Deep_in_the_Sequence" class="headerlink" title="Ch 2 - Deep in the Sequence"></a>Ch 2 - Deep in the Sequence</h2><ul>
<li>map</li>
<li>filter</li>
<li>reduce</li>
<li>flatMap 表达式这样： O[O1, O2, O3]</li>
</ul>
<img src="/2016/03/14/Read-Reactive-Programming-with-RxJS/flatMap.png" alt="FlatMap" title="FlatMap">
<p>| from | Synchronous | 从 arrays 和 iterables |<br>| range | Sync | |<br>| interval | Async | 时间间隔生成值 |<br>| distinct | Same as | | </p>
<h3 id="RxJS_u2019s_Subject_Class"><a href="#RxJS_u2019s_Subject_Class" class="headerlink" title="RxJS’s Subject Class"></a>RxJS’s Subject Class</h3><p>A Subject is a type that implements both Observer and Observable types. As an Observer, it can subscribe to Observables, and as an Observable it can produce values and have Observers subscribe to it.</p>
<p>In some scenarios a single Subject can do the work of a combination of Observers and Observables. For example, for making a proxy object between a data source and the Subject’s listeners, we could use this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> subject = <span class="keyword">new</span> Rx.Subject();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> source = Rx.Observable.interval(<span class="number">300</span>)</span><br><span class="line">    .map(<span class="function"><span class="keyword">function</span>(<span class="params">v</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Interval message #'</span> + v; &#125;).take(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">source.subscribe(subject);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subscription = subject.subscribe(</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">onNext</span>(<span class="params">x</span>) </span>&#123; <span class="built_in">console</span>.log(<span class="string">'onNext: '</span> + x); &#125;,</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">onError</span>(<span class="params">e</span>) </span>&#123; <span class="built_in">console</span>.log(<span class="string">'onError: '</span> + e.message); &#125;,</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">onCompleted</span>(<span class="params"></span>) </span>&#123; <span class="built_in">console</span>.log(<span class="string">'onCompleted'</span>); &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">subject.onNext(<span class="string">'Our message #1'</span>);</span><br><span class="line"></span><br><span class="line">subject.onNext(<span class="string">'Our message #2'</span>);</span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    subject.onCompleted();</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>
<p>In the preceding example we create a <strong>new Subject</strong> and a <strong>source Observable</strong> that emits an integer every 300 millisecond. Then we <strong>subscribe</strong> the <strong>Subject</strong> to the <strong>Observable</strong>. After that, we <strong>subscribe</strong> an <strong>Observer</strong> to the <strong>Subject</strong> itself. The Subject now behaves as an Observable.</p>
<p>Next we make the Subject <strong>emit values of its own</strong> (message1 and message2). In the final result, we get the Subject’s own messages and then the proxied values from the source Observable. The values from the Observable come later because they are <strong>asynchronous</strong>, whereas we made the Subject’s own values immediate. Notice that even if we tell the source Observable to take the first five values, the output shows only the first three. That’s because after one second we call <strong>onCompleted</strong> on the Subject. This <strong>finishes</strong> the <strong>notifications</strong> to all subscriptions and overrides the take operator in this case.</p>
<h3 id="AsyncSubject"><a href="#AsyncSubject" class="headerlink" title="AsyncSubject"></a>AsyncSubject</h3><p>AsyncSubject emits the <strong>last value</strong> of a sequence only if the sequence completes. This value is then <strong>cached forever</strong>, and any Observer that subscribes after the value has been emitted will receive it right away. AsyncSubject is convenient for asynchronous operations that <strong>return a single value</strong>, such as Ajax requests.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> delayedRange = Rx.Observable.range(<span class="number">0</span>, <span class="number">5</span>).delay(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> subject = <span class="keyword">new</span> Rx.AsyncSubject();</span><br><span class="line">delayedRange.subscribe(subject);</span><br><span class="line">subject.subscribe(</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">onNext</span>(<span class="params">item</span>) </span>&#123; <span class="built_in">console</span>.log(<span class="string">'Value:'</span>, item); &#125;,</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">onError</span>(<span class="params">err</span>) </span>&#123; <span class="built_in">console</span>.log(<span class="string">'Error:'</span>, err); &#125;,</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">onCompleted</span>(<span class="params"></span>) </span>&#123; <span class="built_in">console</span>.log(<span class="string">'Completed.'</span>); &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Value: 4 </span></span><br><span class="line"><span class="comment">// Completed.</span></span><br></pre></td></tr></table></figure>
<h3 id="BehaviorSubject"><a href="#BehaviorSubject" class="headerlink" title="BehaviorSubject"></a>BehaviorSubject</h3><p>会有一个 placehodler，<code>var subject = new Rx.BehaviorSubject(&#39;Waiting for content&#39;);</code>。</p>
<p>会等待 remote source 给出一个值，然后就用 remote source 代替。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">subject.subscribe(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">document</span>.body.textContent = result.response || result;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">document</span>.body.textContent = <span class="string">'There was an error retrieving content'</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">Rx.DOM.get(<span class="string">'/remote/content'</span>).subscribe(subject);</span><br></pre></td></tr></table></figure>
<p>类似于，就是，Subject，但是他 subscrib 的是一个值（或者自己 onNext 了一个值）。</p>
<h3 id="ReplaySubject"><a href="#ReplaySubject" class="headerlink" title="ReplaySubject"></a>ReplaySubject</h3><p>A ReplaySubject caches its values and re-emits them to any Observer that sub- scribes late to it. Unlike with AsyncSubject, the sequence doesn’t need to be completed for this to happen.</p>
<p>及时是后面才 subscribe，但是会回放 observables 上所有的值。</p>
<img src="/2016/03/14/Read-Reactive-Programming-with-RxJS/ReplaySubject.png" alt="ReplaySubject" title="ReplaySubject">
]]></content>
    <summary type="html">
    <![CDATA[<p>Untangle Your Asynchronous JavaScript Code</p>
<blockquote>
<p>events happen in random order 事件不同顺序，就要管理事件<br>applications crash 就要重启<br>]]>
    </summary>
    
  </entry>
  
  <entry>
    <title><![CDATA[Gulp API]]></title>
    <link href="http://shane.hsi.rocks/2016/03/13/Gulp-API/"/>
    <id>http://shane.hsi.rocks/2016/03/13/Gulp-API/</id>
    <published>2016-03-13T13:15:58.000Z</published>
    <updated>2016-03-14T02:01:07.000Z</updated>
    <content type="html"><![CDATA[<p>我很喜欢 gulp。接口很纯粹，模块化的思路很简洁。</p>
<blockquote>
<p>也就是说，我不喜欢 npm scripts。或者说是 shell 脚本。宁愿写 plguin 把逻辑模块化。</p>
</blockquote>
<p>所谓模块化的思路，就是 pipe，公用一套 steamm，vinyl。把文件的处理给分块。</p>
<ul>
<li>src</li>
<li>dest</li>
<li>task</li>
</ul>
<p>纯粹一点，js 不要引用 font，css，img。</p>
<p><del>不对，js 必须引用 svg，font，css，img 这些。</del></p>
<p><del>因为可以 inline。</del></p>
<p>前端比较麻烦的就是，各种格式都要用。我觉得还是没有必要 inline 吧。根据标准走。</p>
<p>如果经常变化的，inline（比如验证码图片）。所以，inline 是一种特殊需求的解决方案，不要做通用场景。</p>
<p>那其中一个 task 就来了。</p>
<ul>
<li>字体文件的合并</li>
<li>图片的合并，sprite</li>
</ul>
<blockquote>
<p>图片优化的其他策略，比如通过css，svg，iconfont 代替图片之类的。不是 task。</p>
</blockquote>
<p>这些是单独的开发流程。都是对其他资源的引用。</p>
<hr>
<h2 id="u9644_uFF1A_u518D_u8C08_u524D_u7AEF_u9700_u6C42"><a href="#u9644_uFF1A_u518D_u8C08_u524D_u7AEF_u9700_u6C42" class="headerlink" title="附：再谈前端需求"></a>附：再谈前端需求</h2><p>其他资源搞定了。</p>
<p>现在是 html，css 开发。</p>
<p>大的东西，一般不希望变（比如布局）。首先，作为大的东西，语义本来就很少。比如，只是设定边界。如果变，就可能变了30%。</p>
<p>如果是小的东西，可以变，变的话，只变了 1%。比如。小的东西，语义非常多。</p>
<p>大的东西都是精炼好的，职责单一的。才能做通用。</p>
<p>从布局组件来看，React 我觉得不好模拟。</p>
<p>不是我包含你，而是你附着我。</p>
<p>而且，因为是 whole store，不需要特殊的通信逻辑。</p>
<p>数据如果很慢的话，DOM 慢就不怕了。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;Anchor.Head&gt;</span><br><span class="line">    &lt;Elem.Logo&gt;</span><br><span class="line">    &lt;/Elem.Logo&gt;</span><br><span class="line">    &lt;Elem.</span><br><span class="line">&lt;/Anchor.Head&gt;</span><br><span class="line">&lt;Anchor.Anchor1&gt;</span><br><span class="line">&lt;/Anchor.Anchor1&gt;</span><br><span class="line">&lt;Anchor.Anchor2&gt;</span><br><span class="line">&lt;/Anchor.Anchor2&gt;</span><br><span class="line">&lt;Anchor.Foot&gt;</span><br><span class="line">&lt;/Anchor.Foot&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>看更新：</p>
</blockquote>
<p>从左至右，从上至下。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">L</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">L.Sidebar</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">L.Sidebar</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">L.Head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">L.Head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">L.Workspace</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">L.Workspace</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">L</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">L.Head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">L.OmniSearch</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">L.OmniSearch</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">L.FunctonArea</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">L.FunctonArea</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">L.Head</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">L.OmniSearch</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">E.SearchBox</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">E.SearchBox</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">L.OmniSearch</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">L.FunctonArea</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">E.LFA.Add</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">E.Apps</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">E.LFA.Help</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">E.Setting</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">E.Notification</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">E.LFA.Uesr</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">L.FunctonArea</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>考虑到命名冲突，加入 namespace。</p>
<p>总之，不要提前抽象。而是合并抽象，类似于一种吸纳进标准库的流程。</p>
<p>Layout Store 来做 Layout Component 间通信。</p>
<p>One Single Store is also true. 因为，其实是 stream 的 merge。</p>
<p>从前端问题出发，做逻辑分类。便于精细处理。</p>
<blockquote>
<p>细分会变复杂，组织要用标准原语。降低复杂度。</p>
</blockquote>
<p>不要考虑性能，考虑性能瓶颈。</p>
<p>更多的考虑可读性。</p>
<p>其实，对 Component 再做下 Layout 和 Element 的逻辑分类。是映射于 CSS 的定位、布局相关属性和样式相关属性。</p>
<p>现在的分类标准是：</p>
<p><strong>如果要做 Loading 样式（就是线稿中间的默认空白显示），则分成 Layout 和 Element</strong>。</p>
<p>因为没有必要特别细化空白显示的结构。所以，Layout 到很微笑时，就没必要了。代码逻辑可以 monolithic 一点。反正可控好维护。</p>
<p>当然，如果分类了，就纯粹些（指 CSS 属性的运用）。</p>
<p>比如，Layout 的 Empty Placeholder 如何被加载到的 Data 和 View 替换？</p>
<p>挂载点的替换。在 React 里其实就是 Children。这块逻辑看起来不属于 Layout，而是为 Layout 在这个 context 中一个必备功能。可以抽出。</p>
<p>现在还有一个 portal 的还需要想好如何处理？</p>
<p>相对定位，这种两个 box 状态的绑定，是浏览器原生提供的。自己做一套不必。</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>我很喜欢 gulp。接口很纯粹，模块化的思路很简洁。</p>
<blockquote>
<p>也就是说，我不喜欢 npm scripts。或者说是 shell 脚本。宁愿写 plguin 把逻辑模块化。</p>
</blockquote>
<p>所谓模块化的思路，就是 pi]]>
    </summary>
    
  </entry>
  
  <entry>
    <title><![CDATA[一个 Maven 小技巧]]></title>
    <link href="http://shane.hsi.rocks/2016/03/10/A-Maven-Tip/"/>
    <id>http://shane.hsi.rocks/2016/03/10/A-Maven-Tip/</id>
    <published>2016-03-10T09:51:16.000Z</published>
    <updated>2016-03-10T09:56:32.000Z</updated>
    <content type="html"><![CDATA[<blockquote>
<ol>
<li>当修改了biz包时，需要deploy biz包，为了规避风险，线下统一发布snapshot, 线上发布release, 每次修改升级一个版本号，发布线上时把snapshot去掉(mvn versions:set -DnewVersion=1.1 -DgenerateBackupPoms=false)</li>
</ol>
</blockquote>
<p>另外有直接的插件，<a href="https://maven.apache.org/guides/mini/guide-releasing.html" target="_blank" rel="external">maven-release-plugin</a>。</p>
<p>附一则：</p>
<p>查找重复类: mvn enforcer:enforce</p>
<p><a href="http://www.cnblogs.com/zemliu/p/3277241.html" target="_blank" rel="external">Maven重复类的解决</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<blockquote>
<ol>
<li>当修改了biz包时，需要deploy biz包，为了规避风险，线下统一发布snapshot, 线上发布release, 每次修改升级一个版本号，发布线上时把snapshot去掉(mvn versions:set -DnewVersion]]>
    </summary>
    
  </entry>
  
  <entry>
    <title><![CDATA[React Component 规格]]></title>
    <link href="http://shane.hsi.rocks/2016/03/09/React-Component-Spec/"/>
    <id>http://shane.hsi.rocks/2016/03/09/React-Component-Spec/</id>
    <published>2016-03-09T03:48:20.000Z</published>
    <updated>2016-03-11T09:12:47.000Z</updated>
    <content type="html"><![CDATA[<ul>
<li>× 组件小而美，互相独立，不要搞大而全的 ui 框架，但是需要统一的架构（css，demo，test 等）</li>
<li>× 拥抱开源，多利用开源组件，在其基础上做一些本地化，二次开发，最好可以提 pr 反向回馈开源组件</li>
<li>√ 开源组件实在无法满足需求的情况，需要我们自己开发组件</li>
<li>√ 样式提供 css 文件，不同业务可以有不同的引入方式</li>
<li>√ 组件的输出需要是完整的编译后的代码（可以考虑只提供 CommonJS 风格），而不是编译前的 es6 代码，不应该把编译过程交给使用方</li>
</ul>
<h2 id="u7ED3_u6784_u548C_u6837_u5F0F"><a href="#u7ED3_u6784_u548C_u6837_u5F0F" class="headerlink" title="结构和样式"></a>结构和样式</h2><p><strong>样式提供 css 文件，不同业务可以有不同的引入方式</strong>：</p>
<p>这也就是为什么样式要和 HTML 分离的原因了。目前蚂蚁用的是 namespace。</p>
<p>引申下来，其实就是给个基础的样式，完全放开权限可以微调（如果想重写也是没问题的）。反正就是 HTML 结构是固定了，除了这个限制，爱怎么写 CSS 完全没问题。（所以，HTML 结构设计要合理，不要浮夸）。</p>
<p>这样感觉，less 很好的（讨厌 sass，嫌他复杂，依赖还有个 C 扩展，每次安装，每次改 npm 都一丢丢问题）。</p>
<h3 id="u66F4_u591A_u60F3_u6CD5"><a href="#u66F4_u591A_u60F3_u6CD5" class="headerlink" title="更多想法"></a>更多想法</h3><ul>
<li>结构很重要，最好提供文档，帮助写样式</li>
<li>我不想信 CSS，当然很多的属性可以再聚集成大的属性，用 PostCSS。但是我不想做标准化的事情。是个长期积淀的过程。</li>
</ul>
<h2 id="u524D_u7AEF_u7684_ISP"><a href="#u524D_u7AEF_u7684_ISP" class="headerlink" title="前端的 ISP"></a>前端的 ISP</h2><p><strong>拥抱开源，多利用开源组件，在其基础上做一些本地化，二次开发，最好可以提 pr 反向回馈开源组件</strong>：</p>
<p>目前 JavaScript 社区，能把接口定义好，再回馈。目前还是以 Monolithic 为主。</p>
<p>前端如何服务化，做到 micro，需要思考。<a href="http://www.zhihu.com/question/20314255" target="_blank" rel="external">Linux 为什么还要坚持使用宏内核？</a>。</p>
<h2 id="u5148_u5B8F_u540E_u5FAE_uFF0C_u76EE_u5F55_u9694_u79BB"><a href="#u5148_u5B8F_u540E_u5FAE_uFF0C_u76EE_u5F55_u9694_u79BB" class="headerlink" title="先宏后微，目录隔离"></a>先宏后微，目录隔离</h2><p><strong>组件小而美，互相独立，不要搞大而全的 ui 框架，但是需要统一的架构（css，demo，test 等）</strong>：</p>
<p>是从 Design（UI）推动 Component ？还是反之？</p>
<p>我目前的想法是，要从 Design 开始。出现业务需求是，也要从 Design Standard 出发进行设计增强。然后组件实现。</p>
<p>组件的实现要轻量。</p>
<p>从功能上划分，</p>
<ul>
<li>如果只是改动了 HTML 结构，放在一个组件</li>
<li>如果是样式上，由 CSS 负责。</li>
</ul>
<p>Design 的增强映射成 DOM 结构的增加（如果是修改，要是微调）。我相信从功能点划分出发，子类不会有 DOM 的巨大差异。只可能是增加。</p>
<p>组件化只是开发方便，从用户出发，还是 Design。</p>
<h2 id="u66F4_u591A_u60F3_u6CD5-1"><a href="#u66F4_u591A_u60F3_u6CD5-1" class="headerlink" title="更多想法"></a>更多想法</h2><p>类似于 ant.design 和 react-component 的关系。</p>
<p>后者提供 HTML DOM 结构，一份基础的样式。</p>
<p>HTML/CSS 之外的功能。这块功能的逻辑性是够强的，可以使用 OO 组合（and 我现在对 function 不求甚解，不甚感冒）。</p>
<h2 id="css__u7684_u8BA8_u8BBA"><a href="#css__u7684_u8BA8_u8BBA" class="headerlink" title="css 的讨论"></a>css 的讨论</h2><p>我觉得还是有好处的。说一些自己的经历和由此产生的想法。<br>如果每个组件都有单独的 CSS 文件，那么对于复杂的可能引入很多组件的项目来说，这个问题该怎么解决呢？因为如果是用 React 做项目的话，肯定要把基础的 HTML 结构放到顶层 React Component 里提供复用，如果使用最简单的方式，把组件的 CSS 以 形式写在 里，可能会有几个问题：1. 真正引用我们的组件的 React Component 并不能直接接触到 ，如果需要 inject 的话，就得用 document.head.appendChild(linkElement) 这种比较脏的形式，而且会导致 server rendering 的结果和浏览器端结果 checksum 不一致（会有 warning）。如果引用我们组件的 React Component 自身是会被重复引用的组件，很可能 元素会被重复写入 ；或者当组件的生命周期结束的时候，相应的 又没有从 DOM 被移除。如果不能妥善处理 元素，会有几个潜在问题：1. 里边出现大量重复的 ; 2. 大量重复无意义的请求; 3. CSS 很难合并; 4. CSS 文件自身变得难以管理，组件更新乃至替换组件变成了复杂、有风险的事情。为了避开这些问题，对方可能会选择使用 Reducer 这种集成化的解决方案，然而 Reducer 是在 Browserify 之上的封装（抱歉不是特别了解 Reducer，只看过源码，可能理解有误），选择 Reducer 也就意味着牺牲了自由度，对方需要放弃原来的 Browserify / WebPack 技术栈，也就是放弃大量的开源插件，这是有风险的事情，更何况让对方接受一个不是非常知名的集成解决方案并不是十分容易的事情。原本使用 React 组件只是类似调用一个函数那么简单的事情，为什么对方应该考虑这么多呢？<br>对于我们之前做项目来说，因为使用 Browerify 打包，CSS 地址必须 hardcode 到想要引用这个 CSS 的地方去，而且，不能使用常量，地址必须以某种非常特殊且明确的形式写在那里（或者写个简单的 transform 可以稍微解决得好一点，至少做 rebase 会简单些），不仅开发体验差、CSS 资源难管理，而且仍然会有前边提到的 checksum 不一致的问题。<br>之前在聚艺项目里的做法是，使用 Less 做开发，所有组件的样式都写在各自单独的样式文件里，然后统一从 entry.less 中 import 进来，实现 concat。这样就避开了在各种 React Component 里 inject 样式很麻烦的问题，也避开了 inline style 形式可能出现的 CSS 重复打包的问题。但是仍然有问题：各个组件必须有自己的命名空间，对于写 Less 来说还好，但是写组件就会麻烦很多；而且因为各种样式共享全局作用域，要想知道某个样式文件依赖了另外某一个样式文件是很难的事情。这里边有很多潜在的问题。<br>之前曾经非常看好把 CSS Style 以 JS Object 的形式写在 .jsx 里，但是这种形式开发体验并不好，语法也比原生的 CSS 啰嗦、失去了 CSS Preprocessor 的各种优势，而且因为不能原生支持 :hover 等形式，限制很多。如果依赖 Radium 等第三方库去做转换的话，仍然有问题：1. :hover, :active 等非常常用的伪类要用 JS 模拟，这在性能上会有问题，而且也无法保证模拟效果和原生 CSS 绝对一致；2. 原生 CSS 的很多可供选择的开源工具会废掉，比如个人比较常用的 Autoprefixer 在开发效率上会带来很大帮助，可以拓宽一些 CSS 新属性的兼容范围（比如最典型的 flex-box），而且对于 CSS 的可维护性也有改善（随着浏览器的更新、浏览器市场份额的变化，我们可以随时调整 vendor-prefix 的添加策略），但是如果写成 CSS in JS 的话，因为是一个全新的领域，原来这些很有用的工具就不存在了；3. CSS 全部写在 JS 里，可以想象会有多少重复的样式被 server render 出来。<br>个人认为比较理想的方式仍然是把 CSS 写在外部文件里，我们不仅可以使用各种 CSS Preprocessor，还可以同时使用 PostCSS 做更多事情。但是前边提到的引入 CSS 文件的问题怎么解决？我们自己开发一套解决方案不是一个很容易让人接受的方式（比如我一直一直都不太能接受 FES，总觉得一旦开始用它的框架，以后整个项目的发展空间就被框在它提供的功能范围里了，这是很大的风险）；其次，CSS 可以提供很好的可复用性，比如说 className，它本来就是一个 Class。我们可以利用一些工具在 build 阶段把 CSS 中的各种 className 替换成有规则的 ID，然后提供一个方法帮助组件在 JS 里调用这些被替换掉的 className；如果 className 样式提供的还不够的话，组件自身可以再在元素的 style 里进行扩展。而基于 PostCSS 的 Autoprefixer 可以让我们的 CSS 拥有更广泛的适用范围，甚至阿里开发的 CSSGrace 可以让我们的 CSS 兼容到 IE6，但只需要写最新的无前缀的 CSS 属性。<br>那么怎么把 CSS 加载到页面中呢，甚至最好还能实现 server rendering？<br>比如可以实现这样一个 React Component：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">'fs'</span>;</span><br><span class="line"><span class="keyword">import</span> React, &#123; PropTypes &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Style</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">const</span> css = fs.readFileSync(<span class="keyword">this</span>.props.cssFile, &#123; encoding: <span class="string">'utf-8'</span> &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="xml"><span class="tag">&lt;<span class="title">style</span> <span class="attribute">dangerouslySetInnerHTML</span>=<span class="value">&#123;&#123;</span> <span class="attribute">__html:</span> <span class="attribute">css</span> &#125;&#125; /&gt;</span><span class="css">;</span></span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Style.propTypes = &#123;</span><br><span class="line">    cssFile: PropTypes.string.isRequired,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Style;</span><br></pre></td></tr></table></figure>
<p>然后在写组件的时候：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PropTypes &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> Style <span class="keyword">from</span> <span class="string">'@mtfe/react-tools/utils/Style.js'</span>;</span><br><span class="line"><span class="keyword">import</span> classNameUtils <span class="keyword">from</span> <span class="string">'@mtfe/react-tools/utils/className.js'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> CSS_PATH = <span class="string">'../assets/style.css'</span>;</span><br><span class="line"><span class="keyword">const</span> &#123; classNames, ComponentStyle &#125; = classNameUtils(<span class="xml"><span class="tag">&lt;<span class="title">Style</span> <span class="attribute">cssFile</span>=<span class="value">&#123;CSS_PATH&#125;</span> /&gt;</span><span class="css">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyAwesomeComponent</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="xml"><span class="css">&lt;<span class="tag">section</span>&gt;</span><br><span class="line">                &lt;<span class="tag">ComponentStyle</span> /&gt;</span><br><span class="line">                &lt;<span class="tag">article</span> <span class="tag">className</span>=<span class="rules">&#123;classNames('my-awesome-article')&#125;</span>&gt;</span><br><span class="line">                    &lt;<span class="tag">h2</span> <span class="tag">className</span>=<span class="rules">&#123;classNames('my-awesome-article-title')&gt;Title&lt;/h2&gt;</span><br><span class="line">                    &lt;p&gt;blablablabla&lt;/p&gt;</span><br><span class="line">                &lt;/article&gt;</span><br><span class="line">            &lt;/section&gt;            </span><br><span class="line">        )</span></span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> MyAwesomeComponent;</span><br></pre></td></tr></table></figure>
<p>最后当别人调用我们的组件的时候：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PropTypes &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> AwesomeComponent <span class="keyword">from</span> <span class="string">'my-awesome-component'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="xml"><span class="tag">&lt;<span class="title">html</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">head</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">title</span>&gt;</span>Fancy App<span class="tag">&lt;/<span class="title">title</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">head</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">body</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">header</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="title">h1</span>&gt;</span>My site<span class="tag">&lt;/<span class="title">h1</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="title">header</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">AwesomeComponent</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">body</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">html</span>&gt;</span></span><br><span class="line">        )</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>无需关心样式，组件和样式就都渲染出来了。CSS 部分可以做预处理和后处理，className 允许禁止转换，保持原来的 className，同时添加命名空间，方便用户自己对组件样式进行二次定制，甚至干脆允许禁止加载组件自己的样式，样式部分完全由用户自己去处理；组件的样式 <componentstyle>会在内部统计被加载的次数，将只被渲染一次（对于 server rendering 来说很有好处），而且当组件生命周期结束时，会自动判断是否需要把相应的样式从 DOM 中移除。因为 className 是被替换过的，因此没有命名空间的问题，组件变成了真正的组件，是可以随时调用的资源。如果用户觉得这些配置有些麻烦，可以封装一下组件再用。<br>当然，实现上面这些，困难在于：CSS 样式必须在组件 build 的时候就打包进去（这其实并不难），而且我们需要把对 CSS 类名解析的结果一并打包进去，提供可定制性。build 后的目录结构可能是这样的：</componentstyle></p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">| ...</span></span><br><span class="line"><span class="string">| lib</span></span><br><span class="line"><span class="string">| -- index.js</span></span><br><span class="line"><span class="string">| -- assets</span></span><br><span class="line"><span class="string">| ---- css</span></span><br><span class="line"><span class="string">| ------ style.js</span></span><br><span class="line"><span class="string">| ------ style.classNames.js</span></span><br><span class="line"><span class="string">| ---- images</span></span><br><span class="line"><span class="string">| ------ icon.js</span></span><br><span class="line"><span class="string">| assets</span></span><br><span class="line"><span class="string">| -- css</span></span><br><span class="line"><span class="string">| ---- style.less</span></span><br><span class="line"><span class="string">| -- img</span></span><br><span class="line"><span class="string">| ---- icon.png</span></span><br><span class="line"><span class="string">| ...</span></span><br></pre></td></tr></table></figure>
<p>只把资源相关的东西 build 进去，其他依赖并没有 build 进去，这和 WebPack / Browserify 打包是不一样的。<br>因为急着出门，先写到这里……很多地方比较乱，请大家多提问题和意见</p>
]]></content>
    <summary type="html">
    <![CDATA[<ul>
<li>× 组件小而美，互相独立，不要搞大而全的 ui 框架，但是需要统一的架构（css，demo，test 等）</li>
<li>× 拥抱开源，多利用开源组件，在其基础上做一些本地化，二次开发，最好可以提 pr 反向回馈开源组件</li>
<li>√ 开源组件实在无]]>
    </summary>
    
  </entry>
  
  <entry>
    <title><![CDATA[读一段 JavaScript 代码段]]></title>
    <link href="http://shane.hsi.rocks/2016/03/08/Read-a-JavaScript-Code-Snippet/"/>
    <id>http://shane.hsi.rocks/2016/03/08/Read-a-JavaScript-Code-Snippet/</id>
    <published>2016-03-08T07:00:44.000Z</published>
    <updated>2016-03-08T09:04:04.000Z</updated>
    <content type="html"><![CDATA[<h2 id="u4EE3_u7801"><a href="#u4EE3_u7801" class="headerlink" title="代码"></a>代码</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* eslint no-var:0, vars-on-top:0 */</span></span><br><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV === <span class="literal">undefined</span>) &#123;</span><br><span class="line">  process.env.NODE_ENV = <span class="string">'development'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>);</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"><span class="keyword">var</span> cluster = <span class="built_in">require</span>(<span class="string">'cluster'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> httpHash = <span class="built_in">require</span>(<span class="string">'http-hash'</span>);</span><br><span class="line"><span class="keyword">var</span> ecstatic = <span class="built_in">require</span>(<span class="string">'ecstatic'</span>);</span><br><span class="line"><span class="keyword">var</span> pingme = <span class="built_in">require</span>(<span class="string">'pingme'</span>);</span><br><span class="line"><span class="keyword">var</span> log = <span class="built_in">require</span>(<span class="string">'npmlog'</span>);</span><br><span class="line"><span class="keyword">var</span> cookieParser = <span class="built_in">require</span>(<span class="string">'cookie-parser'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 静态文件 root 目录</span></span><br><span class="line"><span class="keyword">var</span> staticRoot = path.join(process.cwd(), <span class="string">'dist'</span>, process.env.NODE_ENV);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> serveStatic = ecstatic(&#123;</span><br><span class="line">  root: staticRoot,</span><br><span class="line">  cache: process.env.NODE_ENV === <span class="string">'development'</span> ? <span class="string">'no-store'</span> : <span class="number">3600</span>,</span><br><span class="line">  showDir: <span class="literal">false</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> serveHTML = ecstatic(&#123;</span><br><span class="line">  root: staticRoot,</span><br><span class="line">  cache: <span class="string">'no-store'</span>,</span><br><span class="line">  showDir: <span class="literal">false</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 拿到一些常量。包括</span></span><br><span class="line"><span class="keyword">var</span> PORT = <span class="built_in">require</span>(<span class="string">'./apps/@beauty/constants/serverPort'</span>);</span><br><span class="line"><span class="keyword">var</span> getEInHost = <span class="built_in">require</span>(<span class="string">'./apps/@beauty/host/getEInHost'</span>);</span><br><span class="line"><span class="keyword">var</span> getEPassportHost = <span class="built_in">require</span>(<span class="string">'./apps/@beauty/host/getEPassportHost'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> APP_PATHS = [</span><br><span class="line">  <span class="string">'/'</span>,</span><br><span class="line">  <span class="string">'/app/index'</span>,             <span class="comment">// 首页</span></span><br><span class="line">  <span class="string">'/app/home'</span>,              <span class="comment">// 我的</span></span><br><span class="line">  <span class="string">'/app/profile'</span>,           <span class="comment">// 个人信息</span></span><br><span class="line">  <span class="string">'/app/i'</span>,                 <span class="comment">// 个人主页</span></span><br><span class="line">  <span class="string">'/app/i/:beautyId'</span>,       <span class="comment">// 个人主页</span></span><br><span class="line">  <span class="string">'/app/feedback'</span>,          <span class="comment">// 看评价</span></span><br><span class="line">  <span class="string">'/app/product'</span>,           <span class="comment">// 作品</span></span><br><span class="line">  <span class="string">'/app/product/create'</span>,    <span class="comment">// 作品添加</span></span><br><span class="line">  <span class="string">'/app/product/edit/:id'</span>,  <span class="comment">// 作品编辑</span></span><br><span class="line">  <span class="string">'/app/poi/search'</span>,        <span class="comment">// 门店选择</span></span><br><span class="line">  <span class="string">'/app/qrcode'</span>,            <span class="comment">// 用户晒图</span></span><br><span class="line">  <span class="string">'/app/message'</span>,           <span class="comment">// 消息</span></span><br><span class="line">  <span class="string">'/app/statistics'</span>,        <span class="comment">// 查人气</span></span><br><span class="line">  <span class="string">'/app/tell/people'</span>,       <span class="comment">// 告诉朋友</span></span><br><span class="line">  <span class="string">'/app/about'</span>,             <span class="comment">// 关于聚艺</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> RELATION_PATHS = [</span><br><span class="line">  <span class="string">'/relation'</span>,              <span class="comment">// 关联</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// mock server 是 express</span></span><br><span class="line"><span class="keyword">var</span> app = <span class="built_in">require</span>(<span class="string">'express'</span>)();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mockMiddleware</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// T，外部变量</span></span><br><span class="line">  <span class="keyword">var</span> data = mock.get(&#123;</span><br><span class="line">    uri: req.originalUrl,</span><br><span class="line">    method: req.method,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">if</span> (data === <span class="literal">null</span>) <span class="keyword">return</span> next();</span><br><span class="line">  res.type(<span class="string">'json'</span>);</span><br><span class="line">  res.status(data.status);</span><br><span class="line">  res.send(data.body);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 开发环境使用 mock</span></span><br><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV === <span class="string">'development'</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> Mock = <span class="built_in">require</span>(<span class="string">'monkeyjs'</span>);</span><br><span class="line">  <span class="comment">// 构造函数参数： 目录为 mock</span></span><br><span class="line">  <span class="keyword">var</span> mock = <span class="keyword">new</span> Mock(<span class="string">'mock'</span>);</span><br><span class="line"></span><br><span class="line">  app</span><br><span class="line">  .use(mockMiddleware)</span><br><span class="line">  <span class="comment">// .use(require('connect-slashes')(false));</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">epassportMiddleware</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 如果是 '/relation'，则验证 epassort</span></span><br><span class="line">  <span class="keyword">if</span> (req.path === <span class="string">'/relation'</span>) &#123;</span><br><span class="line">    <span class="comment">// 如果是开发环境，则 beauty-sid:test</span></span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV === <span class="string">'development'</span>) &#123;</span><br><span class="line">      log.info(<span class="string">'epassport'</span>, <span class="string">'测试环境 mock bsid'</span>);</span><br><span class="line">      res.cookie(<span class="string">'beauty-bsid'</span>, <span class="string">'test'</span>);</span><br><span class="line">      <span class="comment">// 直接 return，T 这个代码的圈复杂度</span></span><br><span class="line">      <span class="keyword">return</span> next();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> bsid = req.cookies[<span class="string">'beauty-bsid'</span>];</span><br><span class="line">    <span class="keyword">if</span> (!bsid) <span class="keyword">return</span> login();</span><br><span class="line">    <span class="keyword">var</span> request = <span class="built_in">require</span>(<span class="string">'request'</span>);</span><br><span class="line">    <span class="keyword">var</span> baRequest = <span class="built_in">require</span>(<span class="string">'@mtfe/basic-auth'</span>).wrapRequest(request, <span class="string">'mtsalon'</span>, <span class="string">'xoxoxo'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证 epassport epassport 的 host e-in.meituan.com</span></span><br><span class="line">    baRequest(<span class="string">'http://'</span> + getEInHost(req.get(<span class="string">'host'</span>)) + <span class="string">'/bizacct/ssobizacctinfo?bsid='</span> + bsid, <span class="function"><span class="keyword">function</span>(<span class="params">error, response, body</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        log.error(<span class="string">'epassport'</span>, error.message);</span><br><span class="line">        <span class="comment">// 跳转到登录页面</span></span><br><span class="line">        <span class="keyword">return</span> login();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 解析访问 epassport 的 body</span></span><br><span class="line">      <span class="keyword">var</span> bodyJSON = <span class="built_in">JSON</span>.parse(body);</span><br><span class="line">      <span class="keyword">if</span> (bodyJSON.error) &#123;</span><br><span class="line">        log.error(<span class="string">'epassport'</span>, bodyJSON.error.message);</span><br><span class="line">        <span class="keyword">return</span> login();</span><br><span class="line">      &#125;</span><br><span class="line">      log.info(<span class="string">'epassport'</span>, <span class="string">'验证成功'</span>);</span><br><span class="line">      next();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (req.path === <span class="string">'/relation/token'</span>) &#123; <span class="comment">// 如果是 /relation/token，从 request 的 querystring BSID 中拿到值，给 beauty-sid</span></span><br><span class="line">    <span class="keyword">var</span> bsid = req.query.BSID;</span><br><span class="line">    <span class="keyword">if</span> (bsid != <span class="literal">null</span>) &#123;</span><br><span class="line">      res.cookie(<span class="string">'beauty-bsid'</span>, bsid);</span><br><span class="line">    &#125;</span><br><span class="line">    res.redirect(<span class="string">'/relation'</span>);  <span class="comment">// 再跳转</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    next();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    res.redirect(url.format(&#123;</span><br><span class="line">      protocol: <span class="string">'http'</span>,</span><br><span class="line">      host: getEPassportHost(req.get(<span class="string">'host'</span>)),</span><br><span class="line">      pathname: <span class="string">'/account/login'</span>,</span><br><span class="line">      query: &#123;</span><br><span class="line">        service: <span class="string">'mtsalon'</span>,</span><br><span class="line">        loginsource: <span class="number">38</span>,</span><br><span class="line">        <span class="keyword">continue</span>: url.format(&#123;</span><br><span class="line">          protocol: req.protocol,</span><br><span class="line">          host: req.get(<span class="string">'host'</span>),</span><br><span class="line">          pathname: <span class="string">'/relation/token'</span>,</span><br><span class="line">        &#125;),</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">routeMiddleware</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  log.info(<span class="string">'server'</span>, req.method, req.url);</span><br><span class="line">  <span class="keyword">var</span> hash = httpHash();</span><br><span class="line">  APP_PATHS.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">appPath</span>) </span>&#123;</span><br><span class="line">    hash.set(appPath, <span class="function"><span class="keyword">function</span>(<span class="params">req_, res_</span>) </span>&#123;</span><br><span class="line">      req_.url = <span class="string">'/app/entry'</span>;</span><br><span class="line">      <span class="keyword">return</span> serveHTML(req_, res_);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">  RELATION_PATHS.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">appPath</span>) </span>&#123;</span><br><span class="line">    hash.set(appPath, <span class="function"><span class="keyword">function</span>(<span class="params">req_, res_</span>) </span>&#123;</span><br><span class="line">      req_.url = <span class="string">'/relation/entry'</span>;</span><br><span class="line">      <span class="keyword">return</span> serveHTML(req_, res_);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">var</span> route = hash.get(req.url);</span><br><span class="line">  <span class="keyword">if</span> (route.handler) <span class="keyword">return</span> route.handler(req, res);</span><br><span class="line">  next();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app</span><br><span class="line">.use(cookieParser())</span><br><span class="line">.use(epassportMiddleware)</span><br><span class="line">.use(routeMiddleware)</span><br><span class="line">.use(serveStatic);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onerror</span>(<span class="params">req, res, err</span>) </span>&#123;</span><br><span class="line">  res.statusCode = <span class="number">500</span>;</span><br><span class="line">  res.write(err.message);</span><br><span class="line">  res.end();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mainHandler</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> urlOpts = url.parse(req.url);</span><br><span class="line">  <span class="comment">// 简单处理，无应用检查，直接返回 OK</span></span><br><span class="line">  <span class="comment">// TODO 开 task 给 sre， 修改应用健康检查的 url</span></span><br><span class="line">  <span class="comment">// 健康检查</span></span><br><span class="line">  <span class="keyword">if</span> (urlOpts.pathname === <span class="string">'/api/monitor/alive'</span>) &#123;</span><br><span class="line">    res.setHeader(<span class="string">'content-type'</span>, <span class="string">'text/plain'</span>);</span><br><span class="line">    res.end(<span class="string">'OK\n'</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (urlOpts.pathname === <span class="string">'/download'</span>) &#123;</span><br><span class="line">    <span class="comment">// 特殊路径，/download</span></span><br><span class="line">    fs.createReadStream(path.resolve(__dirname, <span class="string">'apps/app/download.html'</span>))</span><br><span class="line">    <span class="comment">// 使用 .bind 创建一个新的包装函数，和 new 类似了</span></span><br><span class="line">    .on(<span class="string">'error'</span>, onerror.bind(<span class="literal">null</span>, req, res))</span><br><span class="line">    .pipe(res)</span><br><span class="line">    .on(<span class="string">'error'</span>, onerror.bind(<span class="literal">null</span>, req, res))</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// app 是这块代码最大的作用域外变量</span></span><br><span class="line">    app(req, res);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = mainHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">require</span>.main === <span class="built_in">module</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> server = http.createServer(mainHandler);</span><br><span class="line">  pingme(&#123;</span><br><span class="line">    server: server,</span><br><span class="line">    <span class="comment">// 简单处理，无应用检查，直接返回 OK</span></span><br><span class="line">    ping: <span class="function"><span class="keyword">function</span>(<span class="params">cb</span>) </span>&#123; cb(<span class="literal">null</span>); &#125;,</span><br><span class="line">    status: <span class="function"><span class="keyword">function</span>(<span class="params">cb</span>) </span>&#123; cb(<span class="literal">null</span>); &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  server.listen(PORT, <span class="string">'0.0.0.0'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    log.info(<span class="string">'server'</span>, <span class="keyword">this</span>.address());</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 开发方便使用</span></span><br><span class="line">  <span class="comment">// cluster fork 模式下不需要</span></span><br><span class="line">  <span class="keyword">if</span> (!cluster.isWorker &amp;&amp; process.env.NODE_ENV === <span class="string">'development'</span>) &#123;</span><br><span class="line">    <span class="comment">// @TODO 必须等到 build 完成? DEV 环境不需要吧</span></span><br><span class="line">    <span class="built_in">require</span>(<span class="string">'./bin/build'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="u4F9D_u8D56"><a href="#u4F9D_u8D56" class="headerlink" title="依赖"></a>依赖</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>);</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"><span class="keyword">var</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>);</span><br><span class="line"><span class="keyword">var</span> cluster = <span class="built_in">require</span>(<span class="string">'cluster'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> httpHash = <span class="built_in">require</span>(<span class="string">'http-hash'</span>);</span><br><span class="line"><span class="keyword">var</span> ecstatic = <span class="built_in">require</span>(<span class="string">'ecstatic'</span>);</span><br><span class="line"><span class="keyword">var</span> pingme = <span class="built_in">require</span>(<span class="string">'pingme'</span>);</span><br><span class="line"><span class="keyword">var</span> log = <span class="built_in">require</span>(<span class="string">'npmlog'</span>);</span><br><span class="line"><span class="keyword">var</span> cookieParser = <span class="built_in">require</span>(<span class="string">'cookie-parser'</span>);</span><br></pre></td></tr></table></figure>
<p>以下是 Node.js 标准模块：</p>
<ul>
<li>fs</li>
<li>path</li>
<li>url</li>
<li>http</li>
<li>crypto</li>
<li>cluster Nodejs多核处理模块</li>
</ul>
<p>以下是第三方 npm 包：</p>
<ul>
<li>http-hash <a href="https://www.npmjs.com/package/http-hash" target="_blank" rel="external">npm</a> HTTP router based on a strict path tree structure</li>
<li>ecstatic <a href="https://www.npmjs.com/package/ecstatic" target="_blank" rel="external">npm</a> A simple static file server middleware that works with both Express and Flatiron</li>
<li>pingme <a href="https://www.npmjs.com/package/pingme" target="_blank" rel="external">npm</a> Super simple HTTP server that can be easily pinged so that Nagios et al can know your stuff’s healthy.</li>
<li>npmlog <a href="https://www.npmjs.com/package/npmlog" target="_blank" rel="external">npm</a> logger for npm</li>
<li>cookie-parser <a href="https://www.npmjs.com/package/cookie-parser" target="_blank" rel="external">npm</a> cookie parsing with signatures</li>
<li>monkeyjs <a href="https://github.com/meituan/monkey" target="_blank" rel="external">github</a> 来自美团 Data mapping system</li>
<li>request <a href="https://www.npmjs.com/package/request" target="_blank" rel="external">npm</a> Simplified HTTP request client.</li>
</ul>
<h2 id="ecstatic"><a href="#ecstatic" class="headerlink" title="ecstatic"></a>ecstatic</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> serveStatic = ecstatic(&#123;</span><br><span class="line">  root: staticRoot,</span><br><span class="line">  cache: process.env.NODE_ENV === <span class="string">'development'</span> ? <span class="string">'no-store'</span> : <span class="number">3600</span>,</span><br><span class="line">  showDir: <span class="literal">false</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> serveHTML = ecstatic(&#123;</span><br><span class="line">  root: staticRoot,</span><br><span class="line">  cache: <span class="string">'no-store'</span>,</span><br><span class="line">  showDir: <span class="literal">false</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>非常直白。感谢 Option 配置式的强大的语法。</p>
<h2 id="http-hash"><a href="#http-hash" class="headerlink" title="http-hash"></a>http-hash</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">routeMiddleware</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  log.info(<span class="string">'server'</span>, req.method, req.url);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> hash = httpHash();</span><br><span class="line"></span><br><span class="line">  APP_PATHS.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">appPath</span>) </span>&#123;</span><br><span class="line">    hash.set(appPath, <span class="function"><span class="keyword">function</span>(<span class="params">req_, res_</span>) </span>&#123; <span class="comment">// route.handler</span></span><br><span class="line">        <span class="comment">// 所有的 url 都是 /app/entry，and 不觉得这个有多好，过分抽象了，直接用 history 挺好</span></span><br><span class="line">      req_.url = <span class="string">'/app/entry'</span>;</span><br><span class="line">      <span class="keyword">return</span> serveHTML(req_, res_);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  RELATION_PATHS.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">appPath</span>) </span>&#123;</span><br><span class="line">    hash.set(appPath, <span class="function"><span class="keyword">function</span>(<span class="params">req_, res_</span>) </span>&#123;</span><br><span class="line">      req_.url = <span class="string">'/relation/entry'</span>;</span><br><span class="line">      <span class="keyword">return</span> serveHTML(req_, res_);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// set 好后，get</span></span><br><span class="line">  <span class="keyword">var</span> route = hash.get(req.url);</span><br><span class="line">  <span class="keyword">if</span> (route.handler) <span class="keyword">return</span> route.handler(req, res);</span><br><span class="line">  next();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个小 library，领域选择的很准确，职责单一。</p>
<h2 id="u4E00_u4E9B_u51B7_u95E8_u77E5_u8BC6"><a href="#u4E00_u4E9B_u51B7_u95E8_u77E5_u8BC6" class="headerlink" title="一些冷门知识"></a>一些冷门知识</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">require</span>.main === <span class="built_in">module</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> server = http.createServer(mainHandler);</span><br><span class="line">  pingme(&#123;</span><br><span class="line">    server: server,</span><br><span class="line">    <span class="comment">// 简单处理，无应用检查，直接返回 OK</span></span><br><span class="line">    ping: <span class="function"><span class="keyword">function</span>(<span class="params">cb</span>) </span>&#123; cb(<span class="literal">null</span>); &#125;,</span><br><span class="line">    status: <span class="function"><span class="keyword">function</span>(<span class="params">cb</span>) </span>&#123; cb(<span class="literal">null</span>); &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  server.listen(PORT, <span class="string">'0.0.0.0'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    log.info(<span class="string">'server'</span>, <span class="keyword">this</span>.address());</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 开发方便使用</span></span><br><span class="line">  <span class="comment">// cluster fork 模式下不需要</span></span><br><span class="line">  <span class="keyword">if</span> (!cluster.isWorker &amp;&amp; process.env.NODE_ENV === <span class="string">'development'</span>) &#123;</span><br><span class="line">    <span class="comment">// @TODO 必须等到 build 完成? DEV 环境不需要吧</span></span><br><span class="line">    <span class="built_in">require</span>(<span class="string">'./bin/build'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参考链接：<a href="http://stackoverflow.com/questions/6398196/node-js-detect-if-called-through-require-or-directly-by-command-line" target="_blank" rel="external">Node.JS: Detect if called through require or directly by command line</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="built_in">require</span>.main === <span class="built_in">module</span>) </span><br><span class="line">   &#123; <span class="built_in">console</span>.log(<span class="string">"called directly"</span>); &#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   &#123; <span class="built_in">console</span>.log(<span class="string">"required as a module"</span>); &#125;</span><br></pre></td></tr></table></figure>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="u4EE3_u7801"><a href="#u4EE3_u7801" class="headerlink" title="代码"></a>代码</h2><figure class="highlight js"><table><tr><td class="gutt]]>
    </summary>
    
  </entry>
  
  <entry>
    <title><![CDATA[学一个 shell 脚本]]></title>
    <link href="http://shane.hsi.rocks/2016/03/07/Let-s-Learn-a-Shell-Script/"/>
    <id>http://shane.hsi.rocks/2016/03/07/Let-s-Learn-a-Shell-Script/</id>
    <published>2016-03-07T07:45:44.000Z</published>
    <updated>2016-03-07T07:47:46.000Z</updated>
    <content type="html"><![CDATA[<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash&#10;# ------------------&#10;# &#32447;&#19978;&#38745;&#24577;&#37096;&#32626;&#33050;&#26412;&#10;#&#10;# @history&#10;#&#10;# ------------------&#10;&#10;WORKSPACE=`pwd`&#10;DIRNAME=`dirname $0`    # &#36820;&#22238;&#36825;&#20010;&#33050;&#26412;&#25991;&#20214;&#25918;&#32622;&#30340;&#30446;&#24405;&#65292;&#28982;&#21518;&#21487;&#20197;&#26681;&#25454;&#36825;&#20010;&#30446;&#24405;&#23450;&#20301;&#35201;&#36816;&#34892;&#31243;&#24207;&#30340;&#30456;&#23545;&#20301;&#32622;&#10;&#10;STATIC_PATH=/opt/xoxo/static/&#10;TEST_STATIC_PATH=/opt/xoxo/static/test&#10;PROJECT_PATH=$WORKSPACE/xxyy-container&#10;DEPLOY_PATH=$PROJECT_PATH/src/main/webapp/deploy/&#10;&#10;pwd;&#10;echo $DIRNAME;  # &#25171;&#21360;&#24403;&#21069;&#30446;&#24405;&#10;&#10;chmod u+x $DIRNAME/color.sh &#38;&#38; source $DIRNAME/color.sh     # &#32473; color.sh &#22686;&#21152;&#25191;&#34892;&#26435;&#38480;&#65292;&#24182;&#20869;&#32852;&#10;if [ $? -eq 0 ]; then   # $? &#19978;&#20010;&#21629;&#20196;&#30340;&#36864;&#20986;&#29366;&#24577;&#65292;&#25110;&#20989;&#25968;&#30340;&#36820;&#22238;&#20540;&#12290;&#10;    echo -e &#34;$&#123;Gre&#125;&#25191;&#34892;color.sh&#25104;&#21151;$&#123;RCol&#125;&#34;&#10;else&#10;    echo &#34;&#25191;&#34892;color.sh&#20986;&#38169;&#20102;&#34;&#10;    exit 1&#10;fi&#10;&#10;cd $DIRNAME &#38;&#38; pwd&#10;&#10;npm install --registry=http://r.npm.xoxo.com     # npm install&#65292;&#24182;&#20351;&#29992; xoxo &#28304;&#65292;&#24403;&#28982;&#36825;&#37324;&#30340;&#20195;&#30721;&#19981;&#20381;&#36182; xoxo &#28304;&#65292;&#36825;&#21477;&#35805;&#21487;&#33021;&#20250;&#25302;&#24930;&#36895;&#24230;&#65288;&#27604;&#22914;&#28857;&#35780; CI &#26080;&#27861;&#35775;&#38382; xoxo &#28304;&#65289;&#10;&#10;if [ $? -eq 0 ]; then&#10;    echo -e &#34;$&#123;Gre&#125;npm&#20381;&#36182;&#21253;&#21152;&#36733;&#23436;&#25104;$&#123;RCol&#125;&#34;&#10;else&#10;    echo -e &#34;$&#123;On_Red&#125;npm&#20381;&#36182;&#21253;&#21152;&#36733;&#22833;&#36133;$&#123;RCol&#125;&#34;&#10;    exit 1;&#10;fi&#10;&#10;# &#20989;&#25968;&#65292;&#35843;&#29992; grunt deploy&#10;grunt_deploy () &#123;&#10;    # grunt task &#30340;&#21442;&#25968; --target&#65292;--project_path&#10;    grunt deploy --target=$1 --project_path=$PROJECT_PATH&#10;&#10;    if [ $? -eq 0 ]; then&#10;        echo -e &#34;$&#123;Gre&#125;$1&#21069;&#31471;&#32534;&#35793;&#25104;&#21151;$&#123;RCol&#125;&#34;&#10;    else&#10;        echo -e &#34;$&#123;On_Red&#125;&#25191;&#34892;&#22833;&#36133;&#12290;&#12290;&#12290;$&#123;RCol&#125;&#34;&#10;        echo &#34;&#23558;&#37325;&#26032;&#32534;&#35793;$1&#34;&#10;        echo -e &#34;\n\n\n\n&#34;;&#10;        # &#37325;&#26032;&#32534;&#35793;&#19968;&#27425;&#65292;&#24182; verbose &#25171;&#21360;&#10;        grunt deploy --target=$1 --project_path=$PROJECT_PATH --verbose&#10;        echo &#34;----------------------&#34;&#10;        echo &#34;$1&#34;&#10;        exit 1;&#10;    fi&#10;&#125;&#10;&#10;# &#20989;&#25968;&#35843;&#29992;&#65292;&#22312;&#20989;&#25968;&#23454;&#29616;&#20013;&#36890;&#36807; $1 $2 ... $9 &#26469;&#25509;&#21463;&#20989;&#25968;&#35843;&#29992;&#26102;&#30340;&#21464;&#37327;&#10;grunt_deploy xxyy&#10;&#10;echo -e &#39;$&#123;Gre&#125;&#25335;&#36125;&#38745;&#24577;&#36164;&#28304;&#21040;&#38745;&#24577;&#26381;&#21153;&#22120;$&#123;RCol&#125;&#39;&#10;&#10;rsync_static () &#123;&#10;    rsync -avi $DEPLOY_PATH xoxo@mobile-static0$1:$STATIC_PATH&#10;&#10;    if [ $? -eq 0 ]; then&#10;        echo -e &#34;$&#123;Gre&#125;rsync &#21040; mobile-static0$1 &#25104;&#21151;$&#123;RCol&#125;&#34;&#10;    else&#10;        echo -e &#34;$&#123;On_Red&#125;rsync &#21040; mobile-static0$1 &#22833;&#36133;$&#123;RCol&#125;&#34;&#10;        exit 1&#10;    fi&#10;&#125;&#10;&#10;rsync_yf_static () &#123;&#10;    # -a, --archive &#24402;&#26723;&#27169;&#24335;&#65292;&#34920;&#31034;&#20197;&#36882;&#24402;&#26041;&#24335;&#20256;&#36755;&#25991;&#20214;&#65292;&#24182;&#20445;&#25345;&#25152;&#26377;&#25991;&#20214;&#23646;&#24615;&#65292;&#31561;&#20110;-rlptgoD &#10;    # -a, --archive               archive mode; same as -rlptgoD (no -H)&#10;    # -v, --verbose &#35814;&#32454;&#27169;&#24335;&#36755;&#20986; &#10;    # -i, --itemize-changes       output a change-summary for all updates&#10;    # &#36825;&#26159; ssh &#36890;&#36947;&#20256;&#20837;&#65292;&#29992;&#25143;&#21517; xoxo &#22320;&#22336; yf-mobile-static0$1&#65288;&#21363;&#65292;yf-mobile-static0xxyy&#65289;&#10;    # &#20174; $DEPLOY_PATH -&#62; &#36828;&#31243;&#26426;&#22120;&#19978;&#30340; $STATIC_PATH&#10;    rsync -avi $DEPLOY_PATH xoxo@yf-mobile-static0$1:$STATIC_PATH&#10;&#10;    if [ $? -eq 0 ]; then&#10;        echo -e &#34;$&#123;Gre&#125;rsync &#21040; yf-mobile-static0$1 &#25104;&#21151;$&#123;RCol&#125;&#34;&#10;    else&#10;        echo -e &#34;$&#123;On_Red&#125;rsync &#21040; yf-mobile-static0$1 &#22833;&#36133;$&#123;RCol&#125;&#34;&#10;        exit 1&#10;    fi&#10;&#125;&#10;&#10;# rsync_static 1&#10;# rsync_static 2&#10;&#10;rsync_yf_static 1&#10;rsync_yf_static 2&#10;&#10;# &#28165;&#31354;&#21457;&#24067;&#21518;&#30340;&#38745;&#24577;&#25991;&#20214;&#10;rm -rf $DEPLOY_PATH</span><br></pre></td></tr></table></figure>
]]></content>
    <summary type="html">
    <![CDATA[<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="li]]>
    </summary>
    
  </entry>
  
</feed>
