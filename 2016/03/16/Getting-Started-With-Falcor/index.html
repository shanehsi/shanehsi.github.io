<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 开始学习 Falcor · Shane Hsi Rocks</title><meta name="description" content="Getting Started With Falcor
OutlineIn this tutorial, we will look at some of Falcor’s basic operations and show how they can be used to construct a virtual JSON model from a data source. The example data we’ll use will model a handful of JavaScript conferences. We’ll start on the client side and eventually move everything over to be served from a NodeJS back end. 
会涉及到 Falcor 的一些基本操作。
"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">博客</a></li><li class="nav-list-item"><a href="https://github.com/shane13hsi" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">开始学习 Falcor</h1><div class="post-meta"><div class="post-time">Mar 16, 2016</div></div><div class="post-content"><p><a href="https://auth0.com/blog/2015/08/28/getting-started-with-falcor/" target="_blank" rel="external">Getting Started With Falcor</a></p>
<h2 id="Outline"><a href="#Outline" class="headerlink" title="Outline"></a>Outline</h2><p>In this tutorial, we will look at some of Falcor’s basic operations and show how they can be used to construct a virtual JSON model from a data source. The example data we’ll use will model a handful of JavaScript conferences. We’ll start on the client side and eventually move everything over to be served from a NodeJS back end. </p>
<p>会涉及到 Falcor 的一些基本操作。</p>
<p>如何从 data source 构造 virutal JSON model。</p>
<p>mock 数据是 JavaScript 会议。</p>
<p>先从 client 端，在写到 NodeJS backend。</p>
<p>Specifically, we will cover:</p>
<ul>
<li>√ What Falcor is and what problems it solves</li>
<li>How to set up a Falcor model on the client and prime it with data 纯 client 端</li>
<li>How to use Falcor’s JSON Graph to avoid having duplicate data JSON Graph 上场，dedupe</li>
<li>How to set up up a Falcor Router with Falcor Express Falcor Router 上场</li>
<li>How to do a basic search using a Falcor route 一个基本的搜索功能</li>
</ul>
<h2 id="What_is_Falcor_3F"><a href="#What_is_Falcor_3F" class="headerlink" title="What is Falcor?"></a>What is Falcor?</h2><p>One of the key problems that Falcor solves is the fact that HTTP wasn’t designed and really isn’t optimized for how web applications should ideally request data. With HTTP, only a single resource can be retrieved per request. Since web applications tend to need to request many small resources, many HTTP requests are often required to get all the data the application needs.</p>
<p>HTTP 并不是为 web application 设计和优化的。</p>
<p>web application 需要很多次小的资源请求。开销又很大。</p>
<p>Another problem that Falcor solves is that JSON objects represent data hierarchically, as trees, whereas data is much more often a graph. In other words, an application’s data doesn’t always have a strict parent-child relationship, but rather will tend to have many predecessors, or be related to many other pieces of data. For example, suppose that we have several categories for our JavaScript conferences. A conference like ng-conf could fit under the category of “JavaScript”, but could also fit under “AngularJS”. If we were to model this with JSON, we might get something like this:</p>
<p>另一个解决的问题，是 data representation，数据展示。</p>
<p>JSON 对象是 tree。</p>
<p>而 data 一般是 graph。</p>
<p>也就是一般不是父子单线关系，而是多线联系。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">categories: &#123;</span><br><span class="line">  javascript: [</span><br><span class="line">    <span class="number">0</span>: &#123;</span><br><span class="line">      name: ng-conf</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  angularjs: [</span><br><span class="line">    <span class="number">0</span>: &#123;</span><br><span class="line">      name: ng-conf</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>As it is expressed here, ng-conf has a parent-child relationship with both categories, when really it is related to both. Falcor makes it possible to deal with data as a graph, but still output it as a normal JSON object.</p>
<p>Falcor 做到是，可以用 graph 来表示 data，但是输出的还是普通的 JSON 对象。</p>
<p>Falcor also helps to make data retrieval more efficient. Instead of pulling many JSON objects from an API and then only using some parts of them in the view layer, Falcor wires together a single virtual JSON model that provides only the data that is required at the time that it is needed. For example, if we wanted to get the name of a conference and the first names of its attendees, we typically would first have our API serve the user data and then we would use the first name value in our view. However, with Falcor, we can easily say that we want only the first name value for each attendee and then have that be the only piece of user data that is returned. In this way, Falcor essentially customizes data to the application’s view. Falcor does this through its JSON Graph convention, which is used to model graph information as a JSON object.</p>
<p>数据获取高效：按需索取。</p>
<p>Furthermore, Falcor caches the virtual JSON model so that it can be accessed in-memory. When it becomes necessary to request more or different data, Falcor first consults the cache and if the data is not available there, it makes another request for only the fragment that is missing.</p>
<p>缓存。</p>
<p>后面的就直接练习吧。</p>
<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> falcor = <span class="built_in">require</span>(<span class="string">'falcor'</span>);</span><br><span class="line"><span class="keyword">var</span> falcorExpress = <span class="built_in">require</span>(<span class="string">'falcor-express'</span>);</span><br><span class="line"><span class="keyword">var</span> Router = <span class="built_in">require</span>(<span class="string">'falcor-router'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> _ = <span class="built_in">require</span>(<span class="string">'lodash'</span>);</span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Have Express request index.html</span></span><br><span class="line">app.use(express.static(<span class="string">'.'</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> $ref = falcor.Model.ref;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Same data that was used in the view for our</span></span><br><span class="line"><span class="comment">// events, but this time on a simple object</span></span><br><span class="line"><span class="comment">// and not a Falcor model.</span></span><br><span class="line"><span class="keyword">var</span> eventsData = &#123;</span><br><span class="line">  locationsById: &#123;</span><br><span class="line">    <span class="number">1</span>: &#123;</span><br><span class="line">      city: <span class="string">"Salt Lake City"</span>,</span><br><span class="line">      state: <span class="string">"Utah"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="number">2</span>: &#123;</span><br><span class="line">      city: <span class="string">"Las Vegas"</span>,</span><br><span class="line">      state: <span class="string">"Nevada"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="number">3</span>: &#123;</span><br><span class="line">      city: <span class="string">"Minneapolis"</span>,</span><br><span class="line">      state: <span class="string">"Minnesota"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="number">4</span>: &#123;</span><br><span class="line">      city: <span class="string">"Walker Creek Ranch"</span>,</span><br><span class="line">      state: <span class="string">"California"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  events: [</span><br><span class="line">    &#123;</span><br><span class="line">      name: <span class="string">"ng-conf"</span>,</span><br><span class="line">      description: <span class="string">"The world's best Angular Conference"</span>,</span><br><span class="line">      location: $ref(<span class="string">'locationsById[1]'</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      name: <span class="string">"React Rally"</span>,</span><br><span class="line">      description: <span class="string">"Conference focusing on Facebook's React"</span>,</span><br><span class="line">      location: $ref(<span class="string">'locationsById[1]'</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      name: <span class="string">"ng-Vegas"</span>,</span><br><span class="line">      description: <span class="string">"Two days jam-packed with Angular goodness with a focus on Angular 2"</span>,</span><br><span class="line">      location: $ref(<span class="string">'locationsById[2]'</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      name: <span class="string">"Midwest JS"</span>,</span><br><span class="line">      description: <span class="string">"Midwest JS is a premier technology conference focused on the JavaScript ecosystem."</span>,</span><br><span class="line">      location: $ref(<span class="string">'locationsById[3]'</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      name: <span class="string">"NodeConf"</span>,</span><br><span class="line">      description: <span class="string">"NodeConf is the longest running community driven conference for the Node community."</span>,</span><br><span class="line">      location: $ref(<span class="string">'locationsById[4]'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.use(<span class="string">"/model.json"</span>, falcorExpress.dataSourceRoute(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Router([&#123;</span><br><span class="line">      <span class="comment">// route 需要符合 整形模式，作为 eventIds</span></span><br><span class="line">    route: <span class="string">"events[&#123;integers:eventIds&#125;]['name', 'description']"</span>,</span><br><span class="line">        get: <span class="function"><span class="keyword">function</span>(<span class="params">pathSet</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> results = [];</span><br><span class="line">            <span class="comment">// 在上面我们指定了 eventIds 标识符</span></span><br><span class="line">            <span class="comment">// 是 array，可以 loop</span></span><br><span class="line">            pathSet.eventIds.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">eventId</span>) </span>&#123;</span><br><span class="line">              <span class="comment">// pathSet[2] 维护的是 key names array</span></span><br><span class="line">              <span class="comment">// JavaScript 嵌套一层（共两层），就会有两个 forEach</span></span><br><span class="line">                pathSet[<span class="number">2</span>].forEach(<span class="function"><span class="keyword">function</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">var</span> eventRecord = eventsData.events[eventId];</span><br><span class="line">                    <span class="comment">// 就是构造一个 &#123;path, value&#125;，让 client 能读懂</span></span><br><span class="line">                    results.push(&#123;</span><br><span class="line">                        path: [<span class="string">'events'</span>, eventId, key],</span><br><span class="line">                        value: eventRecord[key]</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> results;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;]);</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Listening on http://localhost:3000"</span>);</span><br></pre></td></tr></table></figure>
<p>Routes 是匹配 KeySet。在route string 的第一个数组。</p>
<p><code>route: &quot;events[{integers:eventIds}][&#39;name&#39;, &#39;description&#39;]&quot;</code></p>
<p>这里，我们指定：</p>
<ul>
<li>想匹配 integers</li>
<li>要被 eventId 检索</li>
</ul>
<p><code>get</code> 中的 <code>pathSet</code> 参数可以让我们访问 KeySet（KeySet 是客户端提供的，也就是 get 里的）。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> model = <span class="keyword">new</span> falcor.Model(&#123; source: <span class="keyword">new</span> falcor.HttpDataSource(<span class="string">'/model.json'</span>) &#125;);</span><br><span class="line"></span><br><span class="line">model</span><br><span class="line">    .get([</span><br><span class="line">        <span class="string">"events"</span>,</span><br><span class="line">        &#123; from: <span class="number">0</span>, to: <span class="number">2</span> &#125;,</span><br><span class="line">        [<span class="string">"name"</span>, <span class="string">"description"</span>]</span><br><span class="line">    ])</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">document</span>.getElementById(<span class="string">'event-data'</span>).innerHTML = <span class="built_in">JSON</span>.stringify(response, <span class="literal">null</span>, <span class="number">2</span>);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p>总结下，这个 route 就是要访问 <code>name</code> 和 <code>description</code>。</p>
<p>如果要获取 <code>location</code>，要写另一个 route，<strong>同时记得在第一个 route 里加上 ‘location’</strong>。</p>
<p>下面的 route string，加上了 <code>&#39;location&#39;</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">route: <span class="string">"events[&#123;integers:eventIds&#125;]['name', 'description', 'location']"</span>,</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    route: <span class="string">"locationsById[&#123;integers:locationId&#125;]['city', 'state']"</span>,</span><br><span class="line">    get: <span class="function"><span class="keyword">function</span>(<span class="params">pathSet</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> results = [];</span><br><span class="line">        pathSet.locationId.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">locationId</span>) </span>&#123;</span><br><span class="line">            pathSet[<span class="number">2</span>].forEach(<span class="function"><span class="keyword">function</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">var</span> location = eventsData.locationsById[locationId];</span><br><span class="line">                results.push(&#123;</span><br><span class="line">                    path: [<span class="string">'locationsById'</span>, locationId, key],</span><br><span class="line">                    value: location[key]</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> results;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>最后一个 route，<strong>Search for an Event by Name</strong>：</p>
<p>The client can send integers as a KeySet to pull a range of results, but it can also provide strings. We can use this to setup an “event by name” search route.</p>
<blockquote>
<p>吐槽下，route string 非常的诡异啊。得写一个 parser 啊。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    <span class="string">"events"</span>,</span><br><span class="line">    &#123; from: <span class="number">0</span>, to: <span class="number">2</span> &#125;,</span><br><span class="line">    [<span class="string">"name"</span>, <span class="string">"description"</span>]</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>可以用 <code>{ from: 0, to: 2 }</code> 作为 KeySet 来表示 range。</p>
<p>当然，也可以提供 string 啦。可以用这个特性，做一个 search route（“event by name“）。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    route: <span class="string">"events.byName[&#123;keys&#125;]['description']"</span>,</span><br><span class="line">    get: <span class="function"><span class="keyword">function</span>(<span class="params">pathSet</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> results = [];</span><br><span class="line">        pathSet[<span class="number">2</span>].forEach(<span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">            eventsData.events.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (_.includes(event, name)) &#123;</span><br><span class="line">                    results.push(&#123;</span><br><span class="line">                        path: [<span class="string">'events'</span>, <span class="string">'byName'</span>, name, <span class="string">'description'</span>],</span><br><span class="line">                        value: event.description</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> results;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>client 调用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">model.get([<span class="string">"events"</span>, <span class="string">"byName"</span>, [<span class="string">"Midwest JS"</span>], [<span class="string">"description"</span>]])</span><br></pre></td></tr></table></figure>
</div></article></div></section><footer><div class="paginator"><a href="/2016/03/17/What-Relay-is-Solved/" class="prev">上一篇</a><a href="/2016/03/16/Falcor-Getting-Start/" class="next">下一篇</a></div></footer><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>