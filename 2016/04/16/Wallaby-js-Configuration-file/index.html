<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Wallaby.js Configuration file · Shane Hsi Rocks</title><meta name="description" content="by default, wallaby.js is using PhantomJs to run tests.
默认是在 PhantomJs 跑测试（就是 browsers 啦）。
通过 env 来跑在 node 或者 latest Chromium/V8 via Electron
1234567&lt;span class="><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">博客</a></li><li class="nav-list-item"><a href="https://github.com/shane13hsi" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Wallaby.js Configuration file</h1><div class="post-meta"><div class="post-time">Apr 16, 2016</div></div><div class="post-content"><p>by default, wallaby.js is using PhantomJs to run tests.</p>
<p>默认是在 PhantomJs 跑测试（就是 browsers 啦）。</p>
<p>通过 <code>env</code> 来跑在 node 或者 <a href="https://wallabyjs.com/docs/integration/electron.html" target="_blank" rel="external">latest Chromium/V8 via Electron</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">env: &#123;</span><br><span class="line">  type: <span class="string">'node'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> env: &#123;</span><br><span class="line">  kind: <span class="string">'electron'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="API"><a href="#API" class="headerlink" title="API"></a>API</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wallaby</span><br><span class="line">    .localProjectDir <span class="comment">// string 返回 project 当前的目录 </span></span><br><span class="line">    .projectCacheDir <span class="comment">// string project 的 cache 目录 也就是， wallaby 会把文件从 `files` `tests` 复制到 cache 目录，跑的是 cache 里的</span></span><br><span class="line">    .compilers <span class="comment">// 访问 TypeScript Babel compilers https://wallabyjs.com/docs/config/compilers.html</span></span><br><span class="line">    .defaults</span><br></pre></td></tr></table></figure>
<h2 id="u5FEB_u6377_u94FE_u63A5"><a href="#u5FEB_u6377_u94FE_u63A5" class="headerlink" title="快捷链接"></a>快捷链接</h2><ul>
<li><p>配置 compilers <a href="https://wallabyjs.com/docs/integration/typescript.html" target="_blank" rel="external">TypeScript</a> 和 <a href="https://wallabyjs.com/docs/integration/es-next.html" target="_blank" rel="external">ES6/ES7</a></p>
</li>
<li><p>配置 test framework 跑 test 之前设置下环境 <a href="https://wallabyjs.com/docs/config/bootstrap.html" target="_blank" rel="external">setup/bootstrap</a></p>
</li>
<li><p>配置 <a href="https://wallabyjs.com/docs/config/runner.html" target="_blank" rel="external">env</a>，node.js 其他 version 的 phantomjs，electron。</p>
</li>
<li><p><a href="https://wallabyjs.com/docs/config/preprocessors.html" target="_blank" rel="external">preprocessor</a>，比如处理某些 template 为 javascript 来 load tests</p>
</li>
</ul>
<h2 id="test_framework"><a href="#test_framework" class="headerlink" title="test framework"></a>test framework</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">wallaby</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    files: [</span><br><span class="line">      <span class="string">'src/**/*.js'</span></span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">    tests: [</span><br><span class="line">      <span class="string">'test/**/*Spec.js'</span></span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">    testFramework: <span class="string">'mocha'</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="delays"><a href="#delays" class="headerlink" title="delays"></a>delays</h2><p>使用默认的</p>
<h2 id="debug"><a href="#debug" class="headerlink" title="debug"></a>debug</h2><p>输出详细信息，一般不用，报 bug 的时候可以用。</p>
<h1 id="Files_and_tests"><a href="#Files_and_tests" class="headerlink" title="Files and tests"></a>Files and tests</h1><h2 id="Files"><a href="#Files" class="headerlink" title="Files"></a>Files</h2><p>注意：</p>
<ul>
<li>一定要写全<ul>
<li>比如如果你在 js 里 load 了 json，要写上</li>
<li>如果你 require 了其他的 js，要写上</li>
<li>例外<ul>
<li>node_modules 目录（因为 wallaby 不会 cache 它们，就用 local 的）</li>
<li>如果用了 webpack 等 bundler（除非用的是 global）</li>
<li>用了 中间件 <a href="https://wallabyjs.com/docs/config/middleware.html" target="_blank" rel="external">Middleware</a>???</li>
</ul>
</li>
</ul>
</li>
<li>注意根据依赖设置前后顺序</li>
<li>可以是 js，也可以是 css， image json 等任何类型</li>
</ul>
<h2 id="Tests"><a href="#Tests" class="headerlink" title="Tests"></a>Tests</h2><p>略过</p>
<h2 id="File_object"><a href="#File_object" class="headerlink" title="File object"></a>File object</h2><p>pattern</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">files: [</span><br><span class="line">      <span class="string">'src/**/*.js'</span>,</span><br><span class="line">      <span class="comment">// is the same as</span></span><br><span class="line">      &#123; pattern: <span class="string">'src/**/*.js'</span>, instrument: <span class="literal">true</span>, load: <span class="literal">true</span>, ignore: <span class="literal">false</span> &#125;</span><br><span class="line">    ],</span><br></pre></td></tr></table></figure>
<p>其中 <code>ignore</code> 的快捷写法是 <code>!</code> 。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"files"</span>: [</span><br><span class="line">    <span class="string">"src/**/*.js"</span>,</span><br><span class="line">    <span class="string">"!src/**/*Spec.js"</span></span><br><span class="line">  ],</span><br><span class="line"></span><br><span class="line">  <span class="string">"tests"</span>: [</span><br><span class="line">    <span class="string">"src/**/*Spec.js"</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>load</code> 只是否被 sandbox HTML 加载（通过 <code>&lt;script&gt;</code> ）。如果用了 Webpack 就不需要了。</p>
<h2 id="Overriding_defaults"><a href="#Overriding_defaults" class="headerlink" title="Overriding defaults"></a>Overriding defaults</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">wallaby</span>) </span>&#123;</span><br><span class="line">  wallaby.defaults.files.instrument = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    files: [</span><br><span class="line">      <span class="string">'libs/lib1.js'</span>,</span><br><span class="line">      <span class="string">'libs/lib2.js'</span>,</span><br><span class="line">      <span class="string">'libs/lib3.js'</span>,</span><br><span class="line">      <span class="string">'libs/lib4.js'</span>,</span><br><span class="line">      &#123; pattern: <span class="string">'src/**/*.js'</span>, instrument: <span class="literal">true</span> &#125;</span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">    tests: [</span><br><span class="line">      <span class="string">'test/**/*Spec.js'</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h1 id="Runner"><a href="#Runner" class="headerlink" title="Runner"></a>Runner</h1><p>PhantomJs, Chromium/V8 via Electron and node.js</p>
<p>默认的是 By default, PhantomJs (1.9.8)</p>
<p>具体的是细节，默认的和 node 就可以 </p>
<p><a href="https://wallabyjs.com/docs/config/runner.html" target="_blank" rel="external">更多</a></p>
<h1 id="Compilers"><a href="#Compilers" class="headerlink" title="Compilers"></a>Compilers</h1><p>这个和 preprocessors 会混淆。</p>
<p>preprocessors 也能 transform，然后给到 test runner，但是如果你要有 code coverage，首先 wallaby 需要在任意的 preprocessors 前，intstrument 它们。</p>
<p>也就是说 wallaby 需要了解这些 dialect。</p>
<p>Wallaby.js 本身就支持 ES6，JSX。其他的需要配置。</p>
<p>内置了三款：</p>
<blockquote>
<p>Wallaby.js has three built-in compilers: TypeScript, CoffeeScript and Babel.</p>
</blockquote>
<p>如果用了 Babel compiler ，就不要用 Babel preprocessor。</p>
<p>如果只用了 ES6，没用到 ES7，可以 keep using Babel preprocessor without Babel compiler。</p>
<p>但是如果用到了 TypeScript，则必须用 compiler。preprocessors for TypeScript and CoffeeScript are not required</p>
<p>连配置 compiler 的语法和 preprocessors 都差不多。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">compilers: &#123;</span><br><span class="line">  <span class="string">'**/*.js'</span>: wallaby.compilers.babel(&#123;</span><br><span class="line">    <span class="comment">// babel options</span></span><br><span class="line">    <span class="comment">// like `stage: n` for Babel 5.x or `presets: [...]` for Babel 6</span></span><br><span class="line">    <span class="comment">// (no need to duplicate .babelrc, if you have it, it'll be automatically loaded)</span></span><br><span class="line">  &#125;),</span><br><span class="line"></span><br><span class="line">  <span class="string">'**/*.ts'</span>: wallaby.compilers.typeScript(&#123;</span><br><span class="line">    <span class="comment">// TypeScript compiler specific options</span></span><br><span class="line">    <span class="comment">// https://github.com/Microsoft/TypeScript/wiki/Compiler-Options</span></span><br><span class="line">    <span class="comment">// (no need to duplicate tsconfig.json, if you have it, it'll be automatically used)</span></span><br><span class="line">  &#125;),</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Preprocessors"><a href="#Preprocessors" class="headerlink" title="Preprocessors"></a>Preprocessors</h2><p>我的需求已经不需要配置 Preprocessors 了。</p>
<p><a href="https://wallabyjs.com/docs/config/preprocessors.html" target="_blank" rel="external">链接</a></p>
<ul>
<li>compilers</li>
<li>instrumentation</li>
<li>preprocessors</li>
<li>postprocessor</li>
<li>test run</li>
</ul>
<p>It is not recommended to keep any state between function calls because preprocessors and compilers may run in different node processes.</p>
<p>Postprocessor is a function that runs for every batch of file changes after all compilers and preprocessors. It has access not to just one file, but to <strong>all</strong> files (compiled and preprocessed, as well as <strong>original ones</strong>). It is also guaranteed to always run in the <strong>same node process</strong>, so it can <strong>keep some required state</strong>.</p>
<p>Considering all of the above, postprocessor is an ideal place for something like a module bundler, or anything else that needs to  <strong>keep some state between</strong> test runs and have access to all files at the same time.</p>
<p>a function that takes a single argument and is supposed to return a <strong>promise</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> &#123;</span><br><span class="line">     files: [</span><br><span class="line">       <span class="string">'src/**/*.js'</span></span><br><span class="line">     ],</span><br><span class="line"></span><br><span class="line">     tests: [</span><br><span class="line">       <span class="string">'test/**/*Spec.js'</span></span><br><span class="line">     ],</span><br><span class="line"></span><br><span class="line">     <span class="comment">// @param wallaby wallaby.js context</span></span><br><span class="line">     postprocessor: <span class="function"><span class="keyword">function</span> (<span class="params">wallaby</span>) </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(</span><br><span class="line">         <span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="comment">// postprocessor work here</span></span><br><span class="line">              <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">              <span class="comment">// resolve when the work is done</span></span><br><span class="line">              <span class="comment">// or reject on errors</span></span><br><span class="line">              resolve();</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">              reject(err);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;;</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure>
<p>具体的可以看下 webpack 的示例</p>
<p><a href="https://github.com/jeffling/wallaby-webpack/blob/master/index.js" target="_blank" rel="external">wallaby-webpack/index.js</a></p>
<h2 id="Setup"><a href="#Setup" class="headerlink" title="Setup"></a>Setup</h2><p>setup，alias 是 bootstrap。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    files: [</span><br><span class="line">      <span class="string">'src/**/*.js'</span></span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">    tests: [</span><br><span class="line">      <span class="string">'test/**/*Spec.js'</span></span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">    setup: <span class="function"><span class="keyword">function</span> (<span class="params">wallaby</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// wallaby.testFramework is jasmine/QUnit/mocha object</span></span><br><span class="line">      wallaby.testFramework.ui(<span class="string">'tdd'</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// you can access 'window' object in a browser environment,</span></span><br><span class="line">      <span class="comment">// 'global' object or require(...) something in node environment 比如 window 和 global</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></article></div></section><footer><div class="paginator"><a href="/2016/04/16/JavaScript-existential-operator-alternative-syntax/" class="prev">上一篇</a><a href="/2016/04/16/Monorepo/" class="next">下一篇</a></div></footer><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>