<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 阅读 TypeScript Deep Dive · Shane Hsi Rocks</title><meta name="description" content="__extends123456var __extends = this.__extends || function (d, b) &amp;#123;&lt;/span"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">博客</a></li><li class="nav-list-item"><a href="https://github.com/shane13hsi" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">阅读 TypeScript Deep Dive</h1><div class="post-meta"><div class="post-time">Feb 27, 2016</div></div><div class="post-content"><h2 id="extends"><a href="#extends" class="headerlink" title="__extends"></a>__extends</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> __extends = <span class="keyword">this</span>.__extends || <span class="function"><span class="keyword">function</span> (<span class="params">d, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span> b) <span class="keyword">if</span> (b.hasOwnProperty(p)) d[p] = b[p];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__</span>(<span class="params"></span>) </span>&#123; <span class="keyword">this</span>.constructor = d; &#125;</span><br><span class="line">    __.prototype = b.prototype;</span><br><span class="line">    d.prototype = <span class="keyword">new</span> __();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>d - derived class<br>b - base class</p>
<p><strong>1.</strong> 将 static members 复制到 d。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span> b) <span class="keyword">if</span> (b.hasOwnProperty(p)) d[p] = b[p];</span><br></pre></td></tr></table></figure>
<p><strong>2.</strong> 设置 d 的 class function 的 prototype 可选的查找 b 的 proto 的成员。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">d.prototype.__proto__ = b.prototype</span><br></pre></td></tr></table></figure>
<p>详细解释下 <strong>2</strong>。</p>
<p>首先解释为什么 <code>d.prototype.__proto__ = b.prototype</code> 和 </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__</span>(<span class="params"></span>) </span>&#123; <span class="keyword">this</span>.constructor = d; &#125;</span><br><span class="line">__.prototype = b.prototype;</span><br><span class="line">d.prototype = <span class="keyword">new</span> __();</span><br></pre></td></tr></table></figure>
<p>等价。</p>
<p>然后解释这句话的重要性。</p>
<p>先了解这些概念：</p>
<ol>
<li><code>__proto__</code></li>
<li>prototype</li>
<li>effect of <code>new</code> on <code>this</code> inside the called function</li>
<li>effect of <code>new</code> on <code>prototype</code> and <code>__proto__</code></li>
</ol>
<p>每一个 JavaScript 对象都有 <code>__proto__</code>。其中一个目的是：当 <code>obj.property</code> 找不到，会找 <code>obj.__proto__.property</code>，然后 <code>obj.__proto__.__.proto__.property</code>。这就是原型继承。</p>
<p>另一个有用的信息是，所有的 JavaScript function 有一个 property 叫做 <code>prototype</code>。并且有一个 member 叫做 <code>constructor</code> 指向这个 function。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Foo</span>(<span class="params"></span>) </span>&#123; &#125;</span><br><span class="line"><span class="built_in">console</span>.log(Foo.prototype);</span><br><span class="line"><span class="built_in">console</span>.log(Foo.prototype.constructor === Foo);</span><br></pre></td></tr></table></figure>
<p>现在再看下：<code>new</code> 对 <code>this</code> 的作用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.bar = <span class="number">123</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> newFoo = <span class="keyword">new</span> Foo();</span><br><span class="line"><span class="built_in">console</span>.log(newFoo.bar); <span class="comment">// 123</span></span><br></pre></td></tr></table></figure>
<p>大意是：<code>this</code> 会指向新创建的对象。原因是，<strong>在 Function 上使用 <code>new</code> 将 <code>prototype</code> 复制到新创建对象的 <code>__proto__</code></strong>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> foo = <span class="keyword">new</span> Foo();</span><br><span class="line"><span class="built_in">console</span>.log(foo.__proto__ === Foo.prototype); <span class="comment">// True</span></span><br></pre></td></tr></table></figure>
<p>以上。</p>
<p>现在看下： <code>__extends__</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__</span>(<span class="params"></span>) </span>&#123; <span class="keyword">this</span>.constructor = d; &#125;</span><br><span class="line">__.prototype = b.prototype;</span><br><span class="line">d.prototype = <span class="keyword">new</span> __();</span><br></pre></td></tr></table></figure>
<p>d.prototype.<strong>proto</strong> = __.prototype</p>
<p>-&gt; d.prototype = { <strong>proto</strong>: <strong>.prototype}<br>-&gt; d.prototype = { </strong>proto__: b.prototype }</p>
<p>等下，我们需要 d 的 prototype.constructor 保持原来的。</p>
<p>d.prototype.constructor = d;</p>
</div></article></div></section><footer><div class="paginator"><a class="prev"> </a><a href="/2016/02/26/TypeScript-Spec-Version-1-8-Other/" class="next">下一篇</a></div></footer><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>