<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Java 知识点 2016年02月23日 · Shane Hsi Rocks</title><meta name="description" content="Jetty 启动代码Bootstrap.java代码123456&lt;span cla"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">博客</a></li><li class="nav-list-item"><a href="https://github.com/shane13hsi" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Java 知识点 2016年02月23日</h1><div class="post-meta"><div class="post-time">Feb 23, 2016</div></div><div class="post-content"><h2 id="Jetty__u542F_u52A8_u4EE3_u7801"><a href="#Jetty__u542F_u52A8_u4EE3_u7801" class="headerlink" title="Jetty 启动代码"></a>Jetty 启动代码</h2><h3 id="Bootstrap-java"><a href="#Bootstrap-java" class="headerlink" title="Bootstrap.java"></a>Bootstrap.java</h3><h4 id="u4EE3_u7801"><a href="#u4EE3_u7801" class="headerlink" title="代码"></a>代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.*.cfg.Config;</span><br><span class="line"><span class="keyword">import</span> com.*.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Bootstrap</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Bootstrap</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span><br><span class="line">    <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Log.info(<span class="string">"\n"</span>);</span><br><span class="line"></span><br><span class="line">        initClasspath();</span><br><span class="line">        loadConfig();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ()&#123; 配置 logs 地址 &#125; -&gt; logs</span></span><br><span class="line">        String logs = Config.get(<span class="string">"jetty.logs"</span>);</span><br><span class="line">        <span class="keyword">if</span> (logs == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">new</span> File(<span class="string">"/opt/logs/mobile"</span>).exists()) &#123;</span><br><span class="line">                logs = <span class="string">"/opt/logs/mobile"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                logs = <span class="string">"./logs"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">new</span> File(logs).exists()) &#123;</span><br><span class="line">            <span class="keyword">new</span> File(logs).mkdirs();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ()&#123; 配置 webroot &#125; -&gt; void</span></span><br><span class="line">        String webroot = Config.get(<span class="string">"jetty.webroot"</span>);</span><br><span class="line">        <span class="keyword">if</span> (webroot == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">new</span> File(<span class="string">"webroot"</span>).exists()) &#123;</span><br><span class="line">                webroot = <span class="string">"./webroot"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">new</span> File(<span class="string">"src/main/webapp"</span>).exists()) &#123;</span><br><span class="line">                webroot = <span class="string">"./src/main/webapp"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                webroot = <span class="string">"."</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Config.set(<span class="string">"jetty.webroot"</span>, webroot);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ()&#123; 配置 context，并作 path normalize &#125; -&gt; void</span></span><br><span class="line">        String context = Config.get(<span class="string">"jetty.context"</span>);</span><br><span class="line">        <span class="keyword">if</span> ((context == <span class="keyword">null</span>) || (context.isEmpty())) &#123;</span><br><span class="line">            context = <span class="string">"/"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (context.charAt(<span class="number">0</span>) != <span class="string">'/'</span>) &#123;</span><br><span class="line">            context = <span class="string">"/"</span> + context;</span><br><span class="line">        &#125;</span><br><span class="line">        Config.set(<span class="string">"jetty.context"</span>, context);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ? System.getProperty</span></span><br><span class="line">        Log.info(<span class="string">"user.dir="</span> + System.getProperty(<span class="string">"user.dir"</span>));</span><br><span class="line">        Log.info(<span class="string">"jetty.webroot="</span> + webroot);</span><br><span class="line">        Log.info(<span class="string">"jetty.context="</span> + context);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// () &#123; 加载 jetty.xml，或者使用 jetty8.xml &#125; -&gt; jettyConfig</span></span><br><span class="line">        InputStream input = Bootstrap.class.getResourceAsStream(<span class="string">"/jetty/jetty.xml"</span>);</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</span><br><span class="line">            input = Bootstrap.class.getResourceAsStream(<span class="string">"/jetty8.xml"</span>);</span><br><span class="line">            Log.info(<span class="string">"Booting with /jetty8.xml"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Log.info(<span class="string">"Booting with /jetty/jetty.xml"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        XmlConfiguration jettyConfig = <span class="keyword">new</span> XmlConfiguration(input);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ? XmlConfiguration#configure()</span></span><br><span class="line">        Object server = jettyConfig.configure();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ? Pattern.compile</span></span><br><span class="line">        Pattern p = Pattern.compile(<span class="string">"jetty-[\\w]+.xml"</span>);</span><br><span class="line">        <span class="comment">// 数组 aggregate initialization 集初始化 [link](http://book.51cto.com/art/201304/388900.htm)</span></span><br><span class="line">        <span class="comment">// ? WEB-INF/classes/jetty 确认下 classes 目录的生成时间，内容</span></span><br><span class="line">        File[] paths = &#123; <span class="keyword">new</span> File(<span class="string">"src/main/resources/jetty"</span>), <span class="keyword">new</span> File(<span class="string">"src/test/resources/jetty"</span>), <span class="keyword">new</span> File(webroot, <span class="string">"WEB-INF/classes/jetty"</span>) &#125;;</span><br><span class="line">        <span class="keyword">for</span> (File path: paths) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((path.exists()) &amp;&amp; (path.isDirectory())) &#123;</span><br><span class="line">                File[] jettys = path.listFiles(<span class="keyword">new</span> FileFilter() &#123;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">accept</span><span class="params">(File file)</span> </span>&#123;</span><br><span class="line">                        <span class="comment">// ? this 是什么？</span></span><br><span class="line">                        <span class="comment">// ? this.val$p</span></span><br><span class="line">                        <span class="comment">// ? val$p.matcher().matches()</span></span><br><span class="line">                        <span class="keyword">return</span> (file.isFile()) &amp;&amp; (<span class="keyword">this</span>.val$p.matcher(file.getName()).matches());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="comment">// ? 奇怪为什么是 break？不应该是 continue？继续看逻辑</span></span><br><span class="line">                <span class="keyword">if</span> (jettys == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (File jf: jettys) &#123;</span><br><span class="line">                    <span class="comment">// ? File#getName()</span></span><br><span class="line">                    Log.info(<span class="string">"Plusing "</span> + jf.getName());</span><br><span class="line">                    XmlConfiguration cfg = <span class="keyword">new</span> XmlConfiguration(<span class="keyword">new</span> FileInputStream(jf));</span><br><span class="line">                    <span class="comment">// XmlConfiguration.#configure(XmlConfiguration#configure())</span></span><br><span class="line">                    cfg.configure(server);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Log.info(<span class="string">"\n\n"</span>);</span><br><span class="line">        <span class="comment">// ? Object#getClass().getMethod()</span></span><br><span class="line">        <span class="comment">// ? new Class[0]</span></span><br><span class="line">        <span class="comment">// getMethod().invoke(Object, new Object[0])</span></span><br><span class="line">        server.getClass().getMethod(<span class="string">"start"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]).invoke(server, <span class="keyword">new</span> Object[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="u4E1A_u52A1_u903B_u8F91"><a href="#u4E1A_u52A1_u903B_u8F91" class="headerlink" title="业务逻辑"></a>业务逻辑</h4><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">() </span><span class="expression">&#123; </span><br><span class="line">    创建 <span class="variable">logs</span> 目录，</span><br><span class="line"></span><br><span class="line">    配置 <span class="variable">jetty.webroot</span>，<span class="variable">jetty.context</span> 到 <span class="variable">System.setProperty</span>，</span><br><span class="line"></span><br><span class="line">    加载 <span class="variable">jetty.xml</span>，并尝试在 <span class="variable">src</span><span class="end-block">/main</span><span class="end-block">/resources</span><span class="end-block">/jetty</span>，<span class="variable">src</span><span class="end-block">/test</span><span class="end-block">/resources</span><span class="end-block">/jetty</span>，</span><br><span class="line">    $&#123;<span class="variable">webroot</span>&#125;</span><span class="xml">/"WEB-INF/classes/jetty 找 jetty-[\\w]+.xml 文件，</span><br><span class="line">    找到之后会 XmlConfiguration.#configure(server)，</span><br><span class="line">    其中 server 是 jettyConfig.configure()，</span><br><span class="line"></span><br><span class="line">    "start"</span><br><span class="line">&#125; -&gt; void</span></span><br></pre></td></tr></table></figure>
<h3 id="u5176_u4E2D_initClasspath_28_29_3A"><a href="#u5176_u4E2D_initClasspath_28_29_3A" class="headerlink" title="其中 initClasspath():"></a>其中 <code>initClasspath()</code>:</h3><p>注意，感觉这段代码并没有对应用状态产生系统。既没有返回值，也没有 Side Effects。</p>
<h4 id="u4EE3_u7801-1"><a href="#u4EE3_u7801-1" class="headerlink" title="代码"></a>代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initClasspath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ? System#getProperty</span></span><br><span class="line">    <span class="comment">// ? java.class.path</span></span><br><span class="line">    String projectClassPath = System.getProperty(<span class="string">"java.class.path"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// () &#123; 字符串去除 '/jre' &#125; -&gt; javaHome</span></span><br><span class="line">    <span class="comment">// ? java.home</span></span><br><span class="line">    String javaHome = System.getProperty(<span class="string">"java.home"</span>);</span><br><span class="line">    <span class="keyword">if</span> (javaHome.endsWith(<span class="string">"/jre"</span>)) &#123;</span><br><span class="line">        javaHome = javaHome.substring(<span class="number">0</span>, javaHome.length() - <span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Log.info(<span class="string">"JAVA_HOME="</span> + javaHome);</span><br><span class="line">    Log.info(<span class="string">"CLASSPATH="</span> + projectClassPath);</span><br><span class="line">    <span class="comment">// ProjectClassLoader 是项目代码</span></span><br><span class="line">    List &lt; String &gt; classpaths = ProjectClassLoader.getClasspaths();</span><br><span class="line">    <span class="keyword">boolean</span> logger = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (projectClassPath != <span class="keyword">null</span>) &#123;</span><br><span class="line">        StringBuffer excludedString = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        <span class="comment">// ? File.pathSeperatorChar</span></span><br><span class="line">        String[] tokens = projectClassPath.split(String.valueOf(File.pathSeparatorChar));</span><br><span class="line">        <span class="keyword">for</span> (String entry: tokens) &#123;</span><br><span class="line">            <span class="comment">// ? String 赋值是 clone？</span></span><br><span class="line">            String path = entry;</span><br><span class="line">            <span class="comment">// 删除 '-y-'，或 '-n-'</span></span><br><span class="line">            <span class="keyword">if</span> ((path.startsWith(<span class="string">"-y-"</span>)) || (path.startsWith(<span class="string">"-n-"</span>))) &#123;</span><br><span class="line">                path = path.substring(<span class="number">3</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果开始于 '-n-' 或者 javaHome</span></span><br><span class="line">            <span class="keyword">if</span> ((entry.startsWith(<span class="string">"-n-"</span>)) || (entry.startsWith(javaHome))) &#123;</span><br><span class="line">                <span class="keyword">if</span> (logger) &#123;</span><br><span class="line">                    excludedString.append((excludedString.length() &gt; <span class="number">0</span> ? <span class="string">"\n"</span> : <span class="string">""</span>) + <span class="string">"Excluded entry="</span> + path);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (logger) &#123;</span><br><span class="line">                    Log.info(<span class="string">"ProjectClassLoader: entry="</span> + path);</span><br><span class="line">                &#125;</span><br><span class="line">                classpaths.add(path);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Log.info(excludedString.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="u4E1A_u52A1_u903B_u8F91-1"><a href="#u4E1A_u52A1_u903B_u8F91-1" class="headerlink" title="业务逻辑"></a>业务逻辑</h4><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">() &#123;</span><br><span class="line">    获得 java.<span class="keyword">class</span>.path -&gt; projectClassPath，和 java.home -&gt; javaHome，</span><br><span class="line">    然后 split projectClassPath，并根据 path 的开头来增加到 classpaths.add(path)</span><br><span class="line">&#125; -&gt; void</span><br></pre></td></tr></table></figure>
<h3 id="u5176_u4E2D_loadConfig__u4EE3_u7801_uFF1A"><a href="#u5176_u4E2D_loadConfig__u4EE3_u7801_uFF1A" class="headerlink" title="其中 loadConfig 代码："></a>其中 <code>loadConfig</code> 代码：</h3><h4 id="u4EE3_u7801-2"><a href="#u4EE3_u7801-2" class="headerlink" title="代码"></a>代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadConfig</span><span class="params">()</span></span><br><span class="line"><span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// System.getProperties.load()</span></span><br><span class="line">    InputStream input = Bootstrap.class.getResourceAsStream(<span class="string">"/jetty/boot.properties"</span>);</span><br><span class="line">    <span class="keyword">if</span> (input != <span class="keyword">null</span>) &#123;</span><br><span class="line">        System.getProperties().load(input);</span><br><span class="line">        Log.info(<span class="string">"Boot Loaded..."</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Log.info(<span class="string">"No /jetty/boot.properties found to load..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 项目代码</span></span><br><span class="line">    Config.reload();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="u4E1A_u52A1_u903B_u8F91-2"><a href="#u4E1A_u52A1_u903B_u8F91-2" class="headerlink" title="业务逻辑"></a>业务逻辑</h4><figure class="highlight sml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">()</span> &#123;</span><br><span class="line">    拿到 /jetty/boot.properties，并 <span class="type">System</span>.getProperties<span class="literal">()</span>.load<span class="literal">()</span> 进来，</span><br><span class="line"></span><br><span class="line">    <span class="type">Config</span>.reload<span class="literal">()</span></span><br><span class="line">&#125; -&gt; void</span><br></pre></td></tr></table></figure>
<h3 id="u6574_u4F53_u4E1A_u52A1_u903B_u8F91"><a href="#u6574_u4F53_u4E1A_u52A1_u903B_u8F91" class="headerlink" title="整体业务逻辑"></a>整体业务逻辑</h3><ol>
<li>jetty 配置与启动</li>
<li>自定义的初始化 classpath 逻辑</li>
<li>加载 jetty 的 boot 属性配置</li>
</ol>
<h3 id="u6574_u4F53_u9700_u8981_u5B66_u4E60_u7684_u77E5_u8BC6_u70B9"><a href="#u6574_u4F53_u9700_u8981_u5B66_u4E60_u7684_u77E5_u8BC6_u70B9" class="headerlink" title="整体需要学习的知识点"></a>整体需要学习的知识点</h3><h4 id="System-getProperty_28_29"><a href="#System-getProperty_28_29" class="headerlink" title="System.getProperty()"></a><code>System.getProperty()</code></h4><p><code>System.getProperty()</code>，参考链接 <a href="http://www.cnblogs.com/sigh-differ/archive/2012/12/25/java-system-getproperty.html" target="_blank" rel="external">Java 中System里getProperty 方法获得系统参数</a></p>
<h4 id="org-eclipse-jetty-xml-XmlConfiguration"><a href="#org-eclipse-jetty-xml-XmlConfiguration" class="headerlink" title="org.eclipse.jetty.xml.XmlConfiguration"></a><code>org.eclipse.jetty.xml.XmlConfiguration</code></h4><p><code>configure()</code> 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Object server = jettyConfig.configure();</span><br><span class="line"></span><br><span class="line">XmlConfiguration cfg = <span class="keyword">new</span> XmlConfiguration(<span class="keyword">new</span> FileInputStream(jf));</span><br><span class="line">cfg.configure(server);</span><br><span class="line"></span><br><span class="line">server.getClass().getMethod(<span class="string">"start"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]).invoke(server, <span class="keyword">new</span> Object[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure>
<p>参考链接：<a href="http://www.blogjava.net/DLevin/archive/2014/05/24/414061.html" target="_blank" rel="external">深入Jetty源码之XmlConfiguration实现</a></p>
<blockquote>
<p>XmlConfiguration可以使用一个XML文件初始化一个Object实例，它支持属性设置、方法调用、新建新实例等</p>
<p>可以使用带Object实例的参数或不带参数两种方式调用configure方法，带参数表示将XML中内容配置实例中的属性，不带参数则先在内部创建class属性指定的类实例，然后使用XML的内容配置该新创建的实例的属性。</p>
</blockquote>
<h4 id="System-getProperties_28_29-load_28_29"><a href="#System-getProperties_28_29-load_28_29" class="headerlink" title="System.getProperties().load()"></a><code>System.getProperties().load()</code></h4><p>使用Properties的load方法，将这个文件先加载进来，之后可以使用getProperty方法将对应键的值得到。</p>
<h2 id="u5176_u4ED6_u77E5_u8BC6_u70B9"><a href="#u5176_u4ED6_u77E5_u8BC6_u70B9" class="headerlink" title="其他知识点"></a>其他知识点</h2><h3 id="spring__u914D_u7F6E"><a href="#spring__u914D_u7F6E" class="headerlink" title="spring 配置"></a>spring 配置</h3><h4 id="PropertyPlaceholderConfigurer"><a href="#PropertyPlaceholderConfigurer" class="headerlink" title="PropertyPlaceholderConfigurer"></a>PropertyPlaceholderConfigurer</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"propertyConfigurer"</span> </span><br><span class="line">        <span class="attribute">class</span>=<span class="value">"org.springframework.beans.factory.config.PropertyPlaceholderConfigurer"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"locations"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">value</span>&gt;</span>classpath:*-common-config.properties<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">value</span>&gt;</span>classpath:*-custom-config.properties<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>参考链接：<a href="http://blog.csdn.net/zh417/article/details/1728874" target="_blank" rel="external">浅析Spring框架下PropertyPlaceholderConfigurer类</a></p>
<blockquote>
<p>首先要弄清楚一个概念：bean factory post-processor。<br>A bean factory post-processor is a java class which implements the<br>org.springframework.beans.factory.config.BeanFactoryPostProcessor interface. It is executed manually  (in the case of the BeanFactory) or automatically (in the case of the ApplicationContext) to apply changes of some sort to an entire BeanFactory, after it has been constructed.</p>
<ol>
<li>首先bean factory post-processor实现了org.springframework.beans.factory.config.BeanFactoryPostProcessor接口。</li>
<li>在BeanFactory的情况下它被手动的执行。</li>
<li>在ApplicationContext的条件下它会自动的执行。</li>
<li>最关键的一点是，是在一个类的实例被构造出来之后，对整个BeanFactory进行修改。</li>
</ol>
</blockquote>
<p>那么PropertyPlaceholderConfigurer类就是bean factory post-processor的一种，它的作用是一个资源属性的配置器，能够将BeanFactory的里定义的内容放在一个以.propertis后缀的文件中。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"dataSource"</span> <span class="attribute">class</span>=<span class="value">"org.springframework.jdbc.datasource.DriverManagerDataSource"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"driverClassName"</span>&gt;</span><span class="tag">&lt;<span class="title">value</span>&gt;</span>$&#123;driver&#125;<span class="tag">&lt;/<span class="title">value</span>&gt;</span><span class="tag">&lt;/<span class="title">property</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"url"</span>&gt;</span><span class="tag">&lt;<span class="title">value</span>&gt;</span>jdbc:$&#123;dbname&#125;<span class="tag">&lt;/<span class="title">value</span>&gt;</span><span class="tag">&lt;/<span class="title">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>而 jdbc.propertis：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">jdbc.driverClassName=org.hsqldb.jdbcDriver</span><br><span class="line">jdbc.url=<span class="string">jdbc:</span><span class="string">hsqldb:</span><span class="string">hsql:</span><span class="comment">//production:9002</span></span><br><span class="line">jdbc.username=sa</span><br><span class="line">jdbc.password=root</span><br></pre></td></tr></table></figure>
<p>引用就是：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"propertyConfigurer"</span>  <span class="attribute">class</span>=<span class="value">"org.springframework.beans.factory.config.PropertyPlaceholderConfigurer"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"locations"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">list</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">value</span>&gt;</span>/WEB-INF/jdbc.properties<span class="tag">&lt;/<span class="title">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">property</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="title">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>将上边一段配置注册在web.xml中就可以了：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">context-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="title">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">param-value</span>&gt;</span>/WEB-INF/spring-context.xml<span class="tag">&lt;/<span class="title">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">context-param</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>当然，不要忘了spring的监听器注册：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">listener-class</span>&gt;</span></span><br><span class="line">        org.springframework.web.context.ContextLoaderListener</span><br><span class="line">    <span class="tag">&lt;/<span class="title">listener-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">listener</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>ContextLoaderListener监听器的作用就是启动Web容器时，自动装配ApplicationContext的配置信息。因为它实现了ServletContextListener这个接口，在web.xml配置这个监听器，启动容器时，就会默认执行它实现的方法。来源：<a href="http://blog.csdn.net/ysughw/article/details/8992322" target="_blank" rel="external">ContextLoaderListener作用详解</a>。</p>
<h3 id="web-xml"><a href="#web-xml" class="headerlink" title="web.xml"></a>web.xml</h3><h4 id="WEB-INF"><a href="#WEB-INF" class="headerlink" title="WEB-INF"></a>WEB-INF</h4><p>WEB-INF是Java的WEB应用的安全目录。所谓安全就是客户端无法访问，只有服务端可以访问的目录。如果想在页面中直接访问其中的文件，必须通过web.xml文件对要访问的文件进行相应映射才能访问。来源：<a href="http://baike.baidu.com/link?url=lXauen8uR9fVVAOBticfuWrBNz0s65cto_raI_B9ugUUB0uCuEENR3_rjApc2LeEcTkynqrphIEHOwN9e3xTlq" target="_blank" rel="external">web-inf</a>。</p>
<h4 id="web-xml__u8BE6_u89E3"><a href="#web-xml__u8BE6_u89E3" class="headerlink" title="web.xml 详解"></a>web.xml 详解</h4><h5 id="u52A0_u8F7D_u987A_u5E8F"><a href="#u52A0_u8F7D_u987A_u5E8F" class="headerlink" title="加载顺序"></a>加载顺序</h5><p>参考：<a href="http://www.cnblogs.com/hellojava/archive/2012/12/28/2835730.html" target="_blank" rel="external">web.xml文件详解</a></p>
<p>web.xml主要用来配置 Filter、Listener、Servlet 等。</p>
<p>WEB容器的加载顺序是： ServletContext -&gt; context-param -&gt; listener -&gt; filter -&gt; servlet。并且这些元素可以配置在文件中的任意位置。</p>
<p>加载过程顺序如下：</p>
<ol>
<li>启动一个 WEB 项目的时候，WEB 容器会去读取它的配置文件 web.xml，读取 <listener> 和 <context-param> 两个结点。 </context-param></listener></li>
<li>紧接着，容创建一个 ServletContext（servlet上下文），这个web项目的所有部分都将共享这个上下文。 </li>
<li>容器将 <context-param> 转换为键值对，并交给servletContext。 </context-param></li>
<li>容器创建 <listener> 中的类实例，创建监听器。 </listener></li>
</ol>
<blockquote>
<p>所以，是现有 ServletContext，然后将 context-param 交给 ServletContext，然后创建 listener 实例</p>
</blockquote>
<h5 id="u6587_u4EF6_u5143_u7D20_u8BE6_u89E3"><a href="#u6587_u4EF6_u5143_u7D20_u8BE6_u89E3" class="headerlink" title="文件元素详解"></a>文件元素详解</h5><p><strong>1.</strong> schema</p>
<p><strong>2.</strong> <display-name> Web应用名称</display-name></p>
<p>提供GUI工具可能会用来标记这个特定的Web应用的一个名称</p>
<p><strong>3.</strong> <context-param>上下文参数</context-param></p>
<p>声明应用范围内的初始化参数。它用于向 ServletContext提供键值对，即应用程序上下文信息。我们的listener, filter等在初始化时会用到这些上下文中的信息。在servlet里面可以通过getServletContext().getInitParameter(“context/param”)得到。</p>
<p><strong>4.</strong> <filter>过滤器</filter></p>
<p><strong>5.</strong> <listener>监听器</listener></p>
<p><strong>6.</strong> <servlet></servlet></p>
<p><servlet></servlet> 用来声明一个servlet的数据，主要有以下子元素：</p>
<ul>
<li><servlet-name></servlet-name> 指定servlet的名称</li>
<li><servlet-class></servlet-class> 指定servlet的类名称</li>
<li><init-param></init-param> 用来定义参数，可有多个init-param。在servlet类中通过getInitParamenter(String name)方法访问初始化参数</li>
<li><load-on-startup></load-on-startup>指定当Web应用启动时，装载Servlet的次序。当值为正数或零时：Servlet容器先加载数值小的servlet，再依次加载其他数值大的servlet。当值为负或未定义：Servlet容器将在Web客户首次访问这个servlet时加载它。</li>
</ul>
<p><servlet-mapping></servlet-mapping> 用来定义servlet所对应的URL，包含两个子元素</p>
<ul>
<li><servlet-name></servlet-name> 指定servlet的名称</li>
<li><url-pattern></url-pattern> 指定servlet所对应的URL</li>
</ul>
<p>其他参考文章：<a href="http://zhxing.iteye.com/blog/399668" target="_blank" rel="external">web.xml 中的listener、 filter、servlet 加载顺序及其详解</a></p>
<h3 id="jetty__u914D_u7F6E"><a href="#jetty__u914D_u7F6E" class="headerlink" title="jetty 配置"></a>jetty 配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">context-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">param-name</span>&gt;</span>org.eclipse.jetty.servlet.SessionIdPathParameterName<span class="tag">&lt;/<span class="title">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">param-value</span>&gt;</span>none<span class="tag">&lt;/<span class="title">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">context-param</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>参考：<a href="http://ykgarfield.github.io/jetty-9.2.3.v20140905-zh/session-management.html" target="_blank" rel="external">Session 管理</a></p>
<blockquote>
<p>Session URL 参数名称.默认为 jsessionid,但是可以使用这个 context 参数为一个特定 webapp 进行设置. 设置为 “none” 禁用 URL 重写.</p>
</blockquote>
<h3 id="u81EA_u5DF1_u5199_listener"><a href="#u81EA_u5DF1_u5199_listener" class="headerlink" title="自己写 listener"></a>自己写 listener</h3><p>例子：</p>
<p>配置 xml：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">listener-class</span>&gt;</span>com.meituan.service.mobile.tesla.core.listener.ContextListener<span class="tag">&lt;/<span class="title">listener-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">listener</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContextListener</span> <span class="keyword">implements</span> <span class="title">ServletContextListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextInitialized</span><span class="params">(ServletContextEvent sce)</span> </span>&#123;</span><br><span class="line">        WebApplicationContext webApplicationContext = WebApplicationContextUtils.getWebApplicationContext(sce.getServletContext());</span><br><span class="line">        <span class="comment">// 服务启动时，初始化context</span></span><br><span class="line">        LogService.register();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextDestroyed</span><span class="params">(ServletContextEvent sce)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="u53E6_u5916_u4E00_u4E9B_u9AD8_u7EA7_u7528_u6CD5"><a href="#u53E6_u5916_u4E00_u4E9B_u9AD8_u7EA7_u7528_u6CD5" class="headerlink" title="另外一些高级用法"></a>另外一些高级用法</h3><h4 id="u53CD_u5C04"><a href="#u53CD_u5C04" class="headerlink" title="反射"></a>反射</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ? Object#getClass().getMethod()</span></span><br><span class="line"><span class="comment">// ? new Class[0]</span></span><br><span class="line"><span class="comment">// getMethod().invoke(Object, new Object[0])</span></span><br><span class="line">server.getClass().getMethod(<span class="string">"start"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]).invoke(server, <span class="keyword">new</span> Object[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure>
<h4 id="Pattern-compile"><a href="#Pattern-compile" class="headerlink" title="Pattern.compile"></a>Pattern.compile</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Pattern p = Pattern.compile(<span class="string">"jetty-[\\w]+.xml"</span>);</span><br><span class="line"><span class="keyword">return</span> (file.isFile()) &amp;&amp; (<span class="keyword">this</span>.val$p.matcher(file.getName()).matches());</span><br></pre></td></tr></table></figure>
<p>完全没有遇见过 <code>this.val$p</code> 这种用法。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/02/23/Time-Management-Reading-from-Zhihu/" class="prev">上一篇</a><a href="/2016/02/22/Financing-Knownledge-from-Zhihu/" class="next">下一篇</a></div></footer><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>