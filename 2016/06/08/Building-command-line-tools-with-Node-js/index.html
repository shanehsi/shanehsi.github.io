<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Building command line tools with Node.js · Shane Hsi Rocks</title><meta name="description" content="
packaging new shell commands with npm
parsing command line options
reading text and passwords from stdin
dodging callbacks with ES6 generators
error output and codes
coloring terminal output
rendering an ASCII progress bar

Packaging shell commands初始化一个 node 项目：
npm init
index.js：
&lt;span class=&quot;l"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">博客</a></li><li class="nav-list-item"><a href="https://github.com/shane13hsi" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Building command line tools with Node.js</h1><div class="post-meta"><div class="post-time">Jun 8, 2016</div></div><div class="post-content"><ul>
<li>packaging new shell commands with npm</li>
<li>parsing command line options</li>
<li>reading text and passwords from stdin</li>
<li>dodging callbacks with ES6 generators</li>
<li>error output and codes</li>
<li>coloring terminal output</li>
<li>rendering an ASCII progress bar</li>
</ul>
<h2 id="Packaging_shell_commands"><a href="#Packaging_shell_commands" class="headerlink" title="Packaging shell commands"></a>Packaging shell commands</h2><p>初始化一个 node 项目：</p>
<p><code>npm init</code></p>
<p>index.js：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ #!/usr/bin/env node</span></span><br><span class="line"><span class="addition">+ console.log('Hello, world!');</span></span><br></pre></td></tr></table></figure>
<p>package.json</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  "author": "Tim Pettersen",</span><br><span class="line">  "license": "Apache-2.0",</span><br><span class="line"><span class="addition">+ "bin": &#123;</span></span><br><span class="line"><span class="addition">+   "snippet": "./index.js"</span></span><br><span class="line"><span class="addition">+ &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>安装项目到全局，可以测试：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install -g&#10;$ snippet&#10;Hello, world!</span><br></pre></td></tr></table></figure>
<p>查看命令的路径：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ which snippet&#10;/usr/local/bin/snippet&#10;$ readlink /usr/local/bin/snippet&#10;../lib/node_modules/bitbucket-snippet/index.js</span><br></pre></td></tr></table></figure>
<p>方便开发：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm link&#10;/usr/local/bin/snippet -&#62; /usr/local/lib/node_modules/bitbucket-snippet/index.js&#10;/usr/local/lib/node_modules/bitbucket-snippet -&#62; /Users/kannonboy/src/bitbucket-snippet</span><br></pre></td></tr></table></figure>
<p>最后 publish</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm publish</span><br></pre></td></tr></table></figure>
<h2 id="Parsing_command_line_options"><a href="#Parsing_command_line_options" class="headerlink" title="Parsing command line options"></a>Parsing command line options</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install --save commander</span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env node</span><br><span class="line"><span class="deletion">- console.log('Hello, world!');</span></span><br><span class="line"><span class="addition">+ var program = require('commander');</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+ program</span></span><br><span class="line"><span class="addition">+  .arguments('&lt;file&gt;')</span></span><br><span class="line"><span class="addition">+  .option('-u, --username &lt;username&gt;', 'The user to authenticate as')</span></span><br><span class="line"><span class="addition">+  .option('-p, --password &lt;password&gt;', 'The user\'s password')</span></span><br><span class="line"><span class="addition">+  .action(function(file) &#123;</span></span><br><span class="line"><span class="addition">+    console.log('user: %s pass: %s file: %s',</span></span><br><span class="line"><span class="addition">+        program.username, program.password, file);</span></span><br><span class="line"><span class="addition">+  &#125;)</span></span><br><span class="line"><span class="addition">+  .parse(process.argv);</span></span><br></pre></td></tr></table></figure>
<p>quick test：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ snippet -u kannonboy -p correcthorsebatterystaple my_awesome_file&#10;user: kannonboy pass: correcthorsebatterystaple file: my_awesome_file</span><br></pre></td></tr></table></figure>
<p>自动生成一些 help 信息：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ snippet --help&#10;&#10;  Usage: snippet [options] &#60;file&#62;&#10;&#10;  Options:&#10;&#10;    -h, --help                 output usage information&#10;    -u, --username &#60;username&#62;  The user to authenticate as&#10;    -p, --password &#60;password&#62;  The user\&#39;s password</span><br></pre></td></tr></table></figure>
<h2 id="Prompting_for_user_input"><a href="#Prompting_for_user_input" class="headerlink" title="Prompting for user input"></a>Prompting for user input</h2><p>安装：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install --save co co-prompt</span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ var co = require('co');</span></span><br><span class="line"><span class="addition">+ var prompt = require('co-prompt');</span></span><br><span class="line">  var program = require('commander');</span><br><span class="line">...</span><br><span class="line">  .option('-u, --username &lt;username&gt;', 'The user to authenticate as')</span><br><span class="line">  .option('-p, --password &lt;password&gt;', 'The user\'s password')</span><br><span class="line">  .action(function(file) &#123;</span><br><span class="line"><span class="addition">+    co(function *() &#123;</span></span><br><span class="line"><span class="addition">+      var username = yield prompt('username: ');</span></span><br><span class="line"><span class="addition">+      var password = yield prompt.password('password: ');</span></span><br><span class="line">       console.log('user: %s pass: %s file: %s',</span><br><span class="line"><span class="deletion">-          program.username, program.password, file);</span></span><br><span class="line"><span class="addition">+          username, password, file);</span></span><br><span class="line"><span class="addition">+    &#125;);</span></span><br><span class="line">  &#125;)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>quick test：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ snippet my_awesome_file&#10;username: kannonboy&#10;password: *************************&#10;user: kannonboy pass: correcthorsebatterystaple file: my_awesome_file</span><br></pre></td></tr></table></figure>
<h2 id="POSTing_the_snippet"><a href="#POSTing_the_snippet" class="headerlink" title="POSTing the snippet"></a>POSTing the snippet</h2><h2 id="Handling_error_cases"><a href="#Handling_error_cases" class="headerlink" title="Handling error cases"></a>Handling error cases</h2><p>So we’re handling the happy case OK, but what if the upload fails or the user enters the wrong credentials? The UNIX-y way to handle it would be to write an message to standard error and exit with a non-zero code, so let’s do that.</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  request</span><br><span class="line">    .post('https://api.bitbucket.org/2.0/snippets/')</span><br><span class="line">    .auth(username, password)</span><br><span class="line">    .attach('file', filename, file)</span><br><span class="line">    .set('Accept', 'application/json')</span><br><span class="line">    .end(function (err, res) &#123;</span><br><span class="line"><span class="addition">+     if (!err &amp;&amp; res.ok) &#123;</span></span><br><span class="line">        var link = res.body.links.html.href;</span><br><span class="line">        console.log('Snippet created: %s', link);</span><br><span class="line"><span class="addition">+       process.exit(0);</span></span><br><span class="line"><span class="addition">+     &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+     var errorMessage;</span></span><br><span class="line"><span class="addition">+     if (res &amp;&amp; res.status === 401) &#123;</span></span><br><span class="line"><span class="addition">+       errorMessage = "Authentication failed! Bad username/password?";</span></span><br><span class="line"><span class="addition">+     &#125; else if (err) &#123;</span></span><br><span class="line"><span class="addition">+       errorMessage = err;</span></span><br><span class="line"><span class="addition">+     &#125; else &#123;</span></span><br><span class="line"><span class="addition">+       errorMessage = res.text;</span></span><br><span class="line"><span class="addition">+     &#125;</span></span><br><span class="line"><span class="addition">+     console.error(errorMessage);</span></span><br><span class="line"><span class="addition">+     process.exit(1);</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<h2 id="Adding_a_progress_bar"><a href="#Adding_a_progress_bar" class="headerlink" title="Adding a progress bar"></a>Adding a progress bar</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save progress</span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ var fs = require('fs');</span></span><br><span class="line"><span class="addition">+ var ProgressBar = require('progress');</span></span><br><span class="line">  var chalk = require('chalk');</span><br><span class="line">  var request = require('superagent');</span><br><span class="line">...</span><br><span class="line">  var username = yield prompt('username: ');</span><br><span class="line">  var password = yield prompt.password('password: ');</span><br><span class="line"></span><br><span class="line"><span class="addition">+ var fileSize = fs.statSync(file).size;</span></span><br><span class="line"><span class="addition">+ var fileStream = fs.createReadStream(file);</span></span><br><span class="line"><span class="addition">+ var barOpts = &#123;</span></span><br><span class="line"><span class="addition">+   width: 20,</span></span><br><span class="line"><span class="addition">+   total: fileSize,</span></span><br><span class="line"><span class="addition">+   clear: true</span></span><br><span class="line"><span class="addition">+ &#125;;</span></span><br><span class="line"><span class="addition">+ var bar = new ProgressBar(' uploading [:bar] :percent :etas', barOpts);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+ fileStream.on('data', function (chunk) &#123;</span></span><br><span class="line"><span class="addition">+   bar.tick(chunk.length);</span></span><br><span class="line"><span class="addition">+ &#125;);</span></span><br><span class="line"></span><br><span class="line">  request</span><br><span class="line">    .post('https://api.bitbucket.org/2.0/snippets/')</span><br><span class="line">    .auth(username, password)</span><br><span class="line"><span class="deletion">-   .attach('file', file)</span></span><br><span class="line"><span class="addition">+   .attach('file', fileStream)</span></span><br><span class="line">    .set('Accept', 'application/json')</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>We’ve barely scraped the surface of what’s possible with command line tooling in node. As per Atwood’s Law, there are npm packages for elegantly handling standard input, managing parallel tasks, watching files, globbing, compressing, ssh, git, and almost everything else you did with Bash. Plus, there are nice APIs for forking child processes if you need to fall back on another shell script or command that you can’t find a decent JavaScript implementation of.<br>The source code for the example we built above is liberally licensed and available on Bitbucket and, of course, published to npm. I’ve also implemented a couple of features that aren’t shown here, like OAuth, so you don’t have to keep typing in your username and password. You can start using it yourself with a simple:</p>
</div></article></div></section><footer><div class="paginator"><a class="prev"> </a><a href="/2016/06/02/Communications-between-Objects/" class="next">下一篇</a></div></footer><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>