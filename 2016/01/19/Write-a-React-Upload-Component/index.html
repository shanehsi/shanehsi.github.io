<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Write a React Upload Component · Shane Hsi Rocks</title><meta name="description" content="这是一遍学习文档，目的：

了解 upload 相关技术细节。
了解 IE8/9 的兼容性如何解决，即所谓的渐进增强，优雅降级。

参考文档：

SoAanyip/React-FileUpload
react-component/upload
文件上传的渐进式增强
XMLHt"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">博客</a></li><li class="nav-list-item"><a href="https://github.com/shane13hsi" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Write a React Upload Component</h1><div class="post-meta"><div class="post-time">Jan 19, 2016</div></div><div class="post-content"><p>这是一遍学习文档，目的：</p>
<ul>
<li>了解 upload 相关技术细节。</li>
<li>了解 IE8/9 的兼容性如何解决，即所谓的渐进增强，优雅降级。</li>
</ul>
<p>参考文档：</p>
<ol>
<li><a href="https://github.com/SoAanyip/React-FileUpload" target="_blank" rel="external">SoAanyip/React-FileUpload</a></li>
<li><a href="https://github.com/react-component/upload" target="_blank" rel="external">react-component/upload</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2012/08/file_upload.html" target="_blank" rel="external">文件上传的渐进式增强</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2012/09/xmlhttprequest_level_2.html" target="_blank" rel="external">XMLHttpRequest Level 2 使用指南</a></li>
<li><a href="http://www.html5rocks.com/zh/tutorials/file/xhr2/" target="_blank" rel="external">XMLHttpRequest2 新技巧</a></li>
<li><a href="http://www.cnblogs.com/wangmeijian/p/3978407.html" target="_blank" rel="external">利用iframe无刷新上传文件的坑</a></li>
<li><a href="http://fex.baidu.com/webuploader/" target="_blank" rel="external">Web Uploader</a> 这块只是说明，上传也需要一个集成式的方案</li>
</ol>
<h1 id="u4E0A_u4F20_u6587_u4EF6"><a href="#u4E0A_u4F20_u6587_u4EF6" class="headerlink" title="上传文件"></a>上传文件</h1><h2 id="1-__u4F20_u7EDF_u5F62_u5F0F"><a href="#1-__u4F20_u7EDF_u5F62_u5F0F" class="headerlink" title="1. 传统形式"></a>1. 传统形式</h2><p>使用 Form，用户先选择文件，然后点击”Upload”按钮，文件开始上传。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">form</span> <span class="attribute">id</span>=<span class="value">"upload-form"</span> <span class="attribute">action</span>=<span class="value">"upload.php"</span> <span class="attribute">method</span>=<span class="value">"post"</span> <span class="attribute">enctype</span>=<span class="value">"multipart/form-data"</span> &gt;</span></span><br><span class="line">　　<span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"file"</span> <span class="attribute">id</span>=<span class="value">"upload"</span> <span class="attribute">name</span>=<span class="value">"upload"</span> /&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="title">br</span> /&gt;</span></span><br><span class="line">　　<span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"submit"</span> <span class="attribute">value</span>=<span class="value">"Upload"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="2-_iframe_u4E0A_u4F20"><a href="#2-_iframe_u4E0A_u4F20" class="headerlink" title="2. iframe上传"></a>2. iframe上传</h2><p>Form 上传是同步的，用户需等待上传结束。而且上传成功后，会跳转到 action 所指的页面。</p>
<p>如果要实现异步上传，在 HTML5 之前，需要使用 iframe。当用户点击提交时，动态插入 iframe 元素。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> form = $(<span class="string">"#upload-form"</span>);</span><br><span class="line">　form.on(<span class="string">'submit'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">　<span class="comment">// 此处动态插入iframe元素</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>插入 iframe 的代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 随机生成数作为 id</span></span><br><span class="line"><span class="keyword">var</span> seed = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> id = <span class="string">"uploader-frame-"</span> + seed;</span><br><span class="line"><span class="keyword">var</span> callback = <span class="string">"uploader-cb-"</span> + seed;　　</span><br><span class="line"> <span class="comment">// iframe 的 html 代码</span></span><br><span class="line"><span class="keyword">var</span> iframe = $(<span class="string">'&lt;iframe id="'</span> + id + <span class="string">'" name="'</span> + id + <span class="string">'" style="display:none;"&gt;'</span>); </span><br><span class="line"><span class="keyword">var</span> url = form.attr(<span class="string">'action'</span>);</span><br><span class="line">form.attr(<span class="string">'target'</span>, id).append(iframe).attr(<span class="string">'action'</span>, url + <span class="string">'?iframe='</span> + callback);</span><br></pre></td></tr></table></figure>
<p>最后一行，</p>
<ol>
<li>向 Form 添加 target 属性，指向动态插入的 iframe。使得上传结束后，服务器将结果返回 iframe 窗口。当前页面就不会跳转了。</li>
<li>其次在 action 属性指定的上传网址后面添加了一个参数，使得服务器知道回调函数的名称。这样能将服务器返回的信息，从 iframe 返回到上层页面。</li>
</ol>
<p>服务器返回的信息，格式如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span>&gt;</span><span class="javascript"></span><br><span class="line">    <span class="built_in">window</span>.top.window[<span class="string">'callback'</span>](data);</span><br><span class="line"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>所以，在当前页面定义回调：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>[callback] = <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;　　　　</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'received callback:'</span>, data);　　　　</span><br><span class="line">    iframe.remove(); <span class="comment">//removing iframe</span></span><br><span class="line">    　　　　</span><br><span class="line">    form.removeAttr(<span class="string">'target'</span>);　　　　</span><br><span class="line">    form.attr(<span class="string">'action'</span>, url);　　　　</span><br><span class="line">    <span class="built_in">window</span>[callback] = <span class="literal">undefined</span>; <span class="comment">//removing callback</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="3-_ajax__u4E0A_u4F20"><a href="#3-_ajax__u4E0A_u4F20" class="headerlink" title="3. ajax 上传"></a>3. ajax 上传</h2><p>HTML5 提出了 XMLHttpRequest Level 2，使得 ajax 可以上传文件，为异步上传。</p>
<p>上传代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">form.on(<span class="string">'submit'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;　</span><br><span class="line">    <span class="comment">// 此处进行ajax上传</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这里主要使用 FormData 对象，它能够构建类似表单的键值对。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="built_in">window</span>.FormData) &#123;　</span><br><span class="line">　　<span class="keyword">var</span> formData = <span class="keyword">new</span> FormData();</span><br><span class="line">　　<span class="comment">// 建立一个upload表单项，值为上传的文件</span></span><br><span class="line">　　formData.append(<span class="string">'upload'</span>, <span class="built_in">document</span>.getElementById(<span class="string">'upload'</span>).files[<span class="number">0</span>]);</span><br><span class="line">　　<span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">　　xhr.open(<span class="string">'POST'</span>, $(<span class="keyword">this</span>).attr(<span class="string">'action'</span>));</span><br><span class="line">　　<span class="comment">// 定义上传完成后的回调函数</span></span><br><span class="line">　　xhr.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">　　　　<span class="keyword">if</span> (xhr.status === <span class="number">200</span>) &#123;</span><br><span class="line">　　　　　　<span class="built_in">console</span>.log(<span class="string">'上传成功'</span>);</span><br><span class="line">　　　　&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">　　　　　　<span class="built_in">console</span>.log(<span class="string">'出错了'</span>);</span><br><span class="line">　　　　&#125;</span><br><span class="line">　　&#125;;</span><br><span class="line">　　xhr.send(formData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-__u8FDB_u5EA6_u6761"><a href="#4-__u8FDB_u5EA6_u6761" class="headerlink" title="4. 进度条"></a>4. 进度条</h2><p>XMLHttpRequest Level2 定义了一个 progress 事件，获取上传进度。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">progress</span> <span class="attribute">id</span>=<span class="value">"uploadprogress"</span> <span class="attribute">min</span>=<span class="value">"0"</span> <span class="attribute">max</span>=<span class="value">"100"</span> <span class="attribute">value</span>=<span class="value">"0"</span>&gt;</span>0<span class="tag">&lt;/<span class="title">progress</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">xhr.upload.onprogress = <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">　　<span class="keyword">if</span> (event.lengthComputable) &#123;</span><br><span class="line">　　　　<span class="keyword">var</span> complete = (event.loaded / event.total * <span class="number">100</span> | <span class="number">0</span>);</span><br><span class="line">　　　　<span class="keyword">var</span> progress = <span class="built_in">document</span>.getElementById(<span class="string">'uploadprogress'</span>);</span><br><span class="line">　　　　progress.value = progress.innerHTML = complete;</span><br><span class="line">　　&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>注意，progress事件不是定义在xhr，而是定义在xhr.upload，因为这里需要区分下载和上传，下载也有一个progress事件</p>
<p>关于图片预览暂时不了解。</p>
<p>关于拖放上传暂时不了解。</p>
<h1 id="XMLHttpRequest_Level_2"><a href="#XMLHttpRequest_Level_2" class="headerlink" title="XMLHttpRequest Level 2"></a>XMLHttpRequest Level 2</h1><h2 id="u8001_u7248_u672C_XMLHttpRequest"><a href="#u8001_u7248_u672C_XMLHttpRequest" class="headerlink" title="老版本 XMLHttpRequest"></a>老版本 XMLHttpRequest</h2><p>我们看下老版的示例代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">xhr.open(<span class="string">'GET'</span>, <span class="string">'example.php'</span>);</span><br><span class="line">xhr.send();</span><br></pre></td></tr></table></figure>
<p>然后监控 XMLHttpRequest 对象的状态变化：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">xhr.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">　　<span class="keyword">if</span> ( xhr.readyState == <span class="number">4</span> &amp;&amp; xhr.status == <span class="number">200</span> ) &#123;</span><br><span class="line">　　　　alert( xhr.responseText );</span><br><span class="line">　　&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">　　　　alert( xhr.statusText );</span><br><span class="line">　　&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>xhr.readyState：XMLHttpRequest对象的状态，等于4表示数据已经接收完毕。</li>
<li>xhr.status：服务器返回的状态码，等于200表示一切正常。</li>
<li>xhr.responseText：服务器返回的文本数据</li>
<li>xhr.responseXML：服务器返回的XML格式的数据</li>
<li>xhr.statusText：服务器返回的状态文本。</li>
</ul>
<p>老版本的缺点：</p>
<ul>
<li>只支持文本数据的传送，无法用来读取和上传二进制文件。</li>
<li>传送和接收数据时，没有进度信息，只能提示有没有完成。</li>
<li>受到”同域限制”（Same Origin Policy），只能向同一域名的服务器请求数据。</li>
</ul>
<h2 id="XMLHttpRequest_Level_2-1"><a href="#XMLHttpRequest_Level_2-1" class="headerlink" title="XMLHttpRequest Level 2"></a>XMLHttpRequest Level 2</h2><ul>
<li>可以设置HTTP请求的时限。</li>
<li>可以使用FormData对象管理表单数据。</li>
<li>可以上传文件。</li>
<li>可以请求不同域名下的数据（跨域请求）。</li>
<li>可以获取服务器端的二进制数据。</li>
<li>可以获得数据传输的进度信息。</li>
</ul>
<p>下面直接用示例代码，实际使用时注意下浏览器兼容性。</p>
<h3 id="HTTP_u8BF7_u6C42_u7684_u65F6_u9650"><a href="#HTTP_u8BF7_u6C42_u7684_u65F6_u9650" class="headerlink" title="HTTP请求的时限"></a>HTTP请求的时限</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xhr.timeout = <span class="number">3000</span>;</span><br><span class="line">xhr.ontimeout = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">　alert(<span class="string">'请求超时！'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="FormData_u5BF9_u8C61"><a href="#FormData_u5BF9_u8C61" class="headerlink" title="FormData对象"></a>FormData对象</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> formData = <span class="keyword">new</span> FormData();</span><br><span class="line"><span class="comment">// 添加表单项</span></span><br><span class="line">formData.append(<span class="string">'username'</span>, <span class="string">'张三'</span>);</span><br><span class="line">formData.append(<span class="string">'id'</span>, <span class="number">123456</span>);</span><br><span class="line"><span class="comment">// 直接传送 FormData 对象，和提交网页表单效果一样</span></span><br><span class="line">xhr.send(formData);</span><br></pre></td></tr></table></figure>
<p>也可以直接获取网页表单的值：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> form = <span class="built_in">document</span>.getElementById(<span class="string">'myform'</span>);</span><br><span class="line"><span class="keyword">var</span> formData = <span class="keyword">new</span> FormData(form);</span><br><span class="line">formData.append(<span class="string">'secret'</span>, <span class="string">'123456'</span>); <span class="comment">// 添加一个表单项</span></span><br><span class="line">xhr.open(<span class="string">'POST'</span>, form.action);</span><br><span class="line">xhr.send(formData);</span><br></pre></td></tr></table></figure>
<h3 id="u4E0A_u4F20_u6587_u4EF6-1"><a href="#u4E0A_u4F20_u6587_u4EF6-1" class="headerlink" title="上传文件"></a>上传文件</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> formData = <span class="keyword">new</span> FormData();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt; files.length;i++) &#123;</span><br><span class="line">　　formData.append(<span class="string">'files[]'</span>, files[i]);</span><br><span class="line">&#125;</span><br><span class="line">xhr.send(formData);</span><br></pre></td></tr></table></figure>
<h3 id="u8DE8_u57DF_u8D44_u6E90_u5171_u4EAB_uFF08CORS_uFF09"><a href="#u8DE8_u57DF_u8D44_u6E90_u5171_u4EAB_uFF08CORS_uFF09" class="headerlink" title="跨域资源共享（CORS）"></a>跨域资源共享（CORS）</h3><p>前提是，浏览器必须支持这个功能，而且服务器端必须同意这种”跨域”。</p>
<p>其余写法一样。</p>
<h3 id="u63A5_u6536_u4E8C_u8FDB_u5236_u6570_u636E"><a href="#u63A5_u6536_u4E8C_u8FDB_u5236_u6570_u636E" class="headerlink" title="接收二进制数据"></a>接收二进制数据</h3><p>两种方式</p>
<h4 id="u8001_u65B9_u6CD5_uFF1A_u6539_u5199MIMEType"><a href="#u8001_u65B9_u6CD5_uFF1A_u6539_u5199MIMEType" class="headerlink" title="老方法：改写MIMEType"></a>老方法：改写MIMEType</h4><p>即将二进制当做纯文本，再在浏览器端将字节还原成二进制数据。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">xhr.overrideMimeType(<span class="string">"text/plain; charset=x-user-defined"</span>);</span><br><span class="line"><span class="keyword">var</span> binStr = xhr.responseText;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = binStr.length; i &lt; len; ++i) &#123;</span><br><span class="line">　　<span class="keyword">var</span> c = binStr.charCodeAt(i);</span><br><span class="line">　　<span class="keyword">var</span> byte = c &amp; <span class="number">0xff</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>最后一行的位运算”c &amp; 0xff”，表示在每个字符的两个字节之中，只保留后一个字节，将前一个字节扔掉。原因是浏览器解读字符的时候，会把字符自动解读成Unicode的0xF700-0xF7ff区段。</p>
</blockquote>
<h4 id="responseType_u5C5E_u6027"><a href="#responseType_u5C5E_u6027" class="headerlink" title="responseType属性"></a>responseType属性</h4><p>使用新增的 responseType 属性。使用到的时候再具体了解。</p>
<p>进度信息上面已经写过，暂时不了解详细用法。</p>
<h1 id="React__u5B9E_u6218"><a href="#React__u5B9E_u6218" class="headerlink" title="React 实战"></a>React 实战</h1><p>学习的目的是由浅入深，知其所以然，从最简单的开始。</p>
<h2 id="XHR2_2C_FormData"><a href="#XHR2_2C_FormData" class="headerlink" title="XHR2, FormData"></a>XHR2, FormData</h2><p>先写一个简单的表单。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Props &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; findDOMNode &#125; <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AjaxUpload</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span>&lt;<span class="title">Props</span>&lt;<span class="title">any</span>&gt;, </span>&#123;&#125;&gt; &#123;</span><br><span class="line"></span><br><span class="line">  constructor() &#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    <span class="keyword">this</span>.sendForm = <span class="keyword">this</span>.sendForm.bind(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private sendForm() &#123;</span><br><span class="line">    <span class="keyword">const</span> node = findDOMNode(<span class="keyword">this</span>.refs[<span class="string">'file'</span>]);</span><br><span class="line">    <span class="keyword">const</span> formData = <span class="keyword">new</span> FormData();</span><br><span class="line">    formData.append(<span class="string">'file'</span>, node.files[<span class="number">0</span>]);;</span><br><span class="line">    <span class="keyword">const</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">    xhr.open(<span class="string">'POST'</span>, <span class="string">'url'</span>);</span><br><span class="line">    xhr.send(formData);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="xml"><span class="tag">&lt;<span class="title">form</span> <span class="attribute">id</span>=<span class="value">"form1"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">input</span> <span class="attribute">ref</span>=<span class="value">"file"</span> <span class="attribute">type</span>=<span class="value">"file"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"button"</span></span><br><span class="line">               <span class="attribute">onClick</span>=<span class="value">&#123;this.sendForm&#125;</span></span><br><span class="line">               <span class="attribute">value</span>=<span class="value">"Upload"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="title">form</span>&gt;</span></span><br><span class="line">    )</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="iframe__u65E0_u5237_u65B0"><a href="#iframe__u65E0_u5237_u65B0" class="headerlink" title="iframe 无刷新"></a>iframe 无刷新</h2><h3 id="u7B2C_u4E00_u4E2A_u793A_u4F8B"><a href="#u7B2C_u4E00_u4E2A_u793A_u4F8B" class="headerlink" title="第一个示例"></a>第一个示例</h3><p>由于对 iFrame 不甚了解。所以，先花点篇幅了解下。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"file"</span> <span class="attribute">name</span>=<span class="value">"datafile"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">br</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"button"</span> <span class="attribute">value</span>=<span class="value">"upload"</span> </span><br><span class="line">        <span class="attribute">onClick</span>=<span class="value">"fileUpload(this.form,'index.php','upload'); return false;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">div</span> <span class="attribute">id</span>=<span class="value">"upload"</span>&gt;</span><span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fileUpload</span>(<span class="params">form, action_url, div_id</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Create the iframe...</span></span><br><span class="line">    <span class="keyword">var</span> iframe = <span class="built_in">document</span>.createElement(<span class="string">"iframe"</span>);</span><br><span class="line">    iframe.setAttribute(<span class="string">"id"</span>, <span class="string">"upload_iframe"</span>);</span><br><span class="line">    iframe.setAttribute(<span class="string">"name"</span>, <span class="string">"upload_iframe"</span>);</span><br><span class="line">    iframe.setAttribute(<span class="string">"width"</span>, <span class="string">"0"</span>);</span><br><span class="line">    iframe.setAttribute(<span class="string">"height"</span>, <span class="string">"0"</span>);</span><br><span class="line">    iframe.setAttribute(<span class="string">"border"</span>, <span class="string">"0"</span>);</span><br><span class="line">    iframe.setAttribute(<span class="string">"style"</span>, <span class="string">"width: 0; height: 0; border: none;"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add to document...</span></span><br><span class="line">    form.parentNode.appendChild(iframe);</span><br><span class="line">    <span class="built_in">window</span>.frames[<span class="string">'upload_iframe'</span>].name = <span class="string">"upload_iframe"</span>;</span><br><span class="line"></span><br><span class="line">    iframeId = <span class="built_in">document</span>.getElementById(<span class="string">"upload_iframe"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add event...</span></span><br><span class="line">    <span class="keyword">var</span> eventHandler = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (iframeId.detachEvent) iframeId.detachEvent(<span class="string">"onload"</span>, eventHandler);</span><br><span class="line">        <span class="keyword">else</span> iframeId.removeEventListener(<span class="string">"load"</span>, eventHandler, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Message from server...</span></span><br><span class="line">        <span class="keyword">if</span> (iframeId.contentDocument) &#123;</span><br><span class="line">            content = iframeId.contentDocument.body.innerHTML;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (iframeId.contentWindow) &#123;</span><br><span class="line">            content = iframeId.contentWindow.document.body.innerHTML;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (iframeId.document) &#123;</span><br><span class="line">            content = iframeId.document.body.innerHTML;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">document</span>.getElementById(div_id).innerHTML = content;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Del the iframe...</span></span><br><span class="line">        setTimeout(<span class="string">'iframeId.parentNode.removeChild(iframeId)'</span>, <span class="number">250</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (iframeId.addEventListener) iframeId.addEventListener(<span class="string">"load"</span>, eventHandler, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (iframeId.attachEvent) iframeId.attachEvent(<span class="string">"onload"</span>, eventHandler);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set properties of form...</span></span><br><span class="line">    form.setAttribute(<span class="string">"target"</span>, <span class="string">"upload_iframe"</span>);</span><br><span class="line">    form.setAttribute(<span class="string">"action"</span>, action_url);</span><br><span class="line">    form.setAttribute(<span class="string">"method"</span>, <span class="string">"post"</span>);</span><br><span class="line">    form.setAttribute(<span class="string">"enctype"</span>, <span class="string">"multipart/form-data"</span>);</span><br><span class="line">    form.setAttribute(<span class="string">"encoding"</span>, <span class="string">"multipart/form-data"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Submit the form...</span></span><br><span class="line">    form.submit();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">document</span>.getElementById(div_id).innerHTML = <span class="string">"Uploading..."</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上做的步骤是：</p>
<ol>
<li>创建 iframe，并且设置 id 和 style（即不可见）</li>
<li>append 到 document</li>
<li>创建 event handler，主要是两块逻辑，一是 remove event listener，而是获取服务器返回的数据，并写到上层的 document</li>
<li>然后用两种方式，<code>addEventListener(&#39;load&#39;)</code>，<code>attachEvent(&#39;onload&#39;)</code></li>
<li>设置 form 属性，特别是设置 <code>target</code> 为创建的 iframe</li>
<li>提交表单</li>
</ol>
<h3 id="u7B2C_u4E8C_u4E2A_u793A_u4F8B"><a href="#u7B2C_u4E8C_u4E2A_u793A_u4F8B" class="headerlink" title="第二个示例"></a>第二个示例</h3><p>上面的例子还是太复杂了，需要动态创建 iframe。下面这个例子是最最简单的例子。没有任何 JavaScript。但是，既然是从基础开始，还是要了解下基础的几个 attribute 的作用。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">iframe</span> <span class="attribute">name</span>=<span class="value">"fileUpload"</span>&gt;</span><span class="tag">&lt;/<span class="title">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">form</span> <span class="attribute">method</span>=<span class="value">"post"</span> <span class="attribute">action</span>=<span class="value">"xxxx"</span> <span class="attribute">enctype</span>=<span class="value">"multipart/form-data"</span> <span class="attribute">name</span>=<span class="value">"fileForm"</span> <span class="attribute">target</span>=<span class="value">"fileUpload"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"file"</span> <span class="attribute">class</span>=<span class="value">"fileInput"</span> <span class="attribute">name</span>=<span class="value">"fileInput"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"submit"</span> <span class="attribute">value</span>=<span class="value">"提交"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>同样是：</p>
<ol>
<li><code>enctype=&quot;multipart/form-data&quot;</code> 通过文件流传递给后端，具体含义，参考 <a href="https://imququ.com/post/four-ways-to-post-data-in-http.html" target="_blank" rel="external">四种常见的POST 提交数据方式</a></li>
<li><code>target=&quot;fileUpload&quot;</code>，Form 表单的 target 属性设置为 frame，即将远程服务器返回的内容显示到 iframe 上，其他还有 <code>_blank</code> 新页面。</li>
<li>name 用在表单提交时，这里 input 的 name，fileInput，就是传递给后台的 Form 键值对的 key，或者，就是 FormData <code>formData.append(&#39;file&#39;, node.files[0]);</code>。再比如多个 radio 有多个 id，但是 name 是一样的，所以表单提交时，只会传一个值。再比如 select 也是类似的行为。</li>
</ol>
<h3 id="u7B2C_u4E09_u4E2A_u793A_u4F8B_-__u52A8_u6001_u521B_u5EFA_iframe"><a href="#u7B2C_u4E09_u4E2A_u793A_u4F8B_-__u52A8_u6001_u521B_u5EFA_iframe" class="headerlink" title="第三个示例 - 动态创建 iframe"></a>第三个示例 - 动态创建 iframe</h3><p>例子来源于：<a href="http://www.cnblogs.com/wangmeijian/p/3978407.html" target="_blank" rel="external">利用iframe无刷新上传文件的坑</a>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*2014年9月18日17:39:47 By 王美建*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ajaxUpload</span>(<span class="params">opt</span>) </span>&#123;</span><br><span class="line">    <span class="comment">/*</span><br><span class="line">        参数说明:</span><br><span class="line">        opt.frameName : iframe的name值;</span><br><span class="line">        opt.url : 文件要提交到的地址;</span><br><span class="line">        opt.fileName : file控件的name;</span><br><span class="line">        opt.format : 文件格式，以数组的形式传递，如['jpg','png','gif','bmp'];</span><br><span class="line">        opt.callBack : 上传成功后回调;</span><br><span class="line">    */</span></span><br><span class="line">    <span class="keyword">var</span> iName = opt.frameName; <span class="comment">//太长了，变短点</span></span><br><span class="line">    <span class="keyword">var</span> iframe, form;</span><br><span class="line">    <span class="comment">//创建iframe和form表单</span></span><br><span class="line">    iframe = $(<span class="string">'&lt;iframe name="'</span> + iName + <span class="string">'" /&gt;'</span>);</span><br><span class="line">    form = $(<span class="string">'&lt;form method="post" style="display:none;" target="'</span> + iName + <span class="string">'" action="'</span> + opt.url + <span class="string">'"  name="form_'</span> + iName + <span class="string">'" enctype="multipart/form-data" /&gt;'</span>);</span><br><span class="line">    file = $(<span class="string">'&lt;input type="file" name="'</span> + opt.fileName + <span class="string">'" /&gt;'</span>);</span><br><span class="line">    file.appendTo(form);</span><br><span class="line">    <span class="comment">//插入body</span></span><br><span class="line">    $(<span class="built_in">document</span>.body).append(iframe).append(form);</span><br><span class="line">    <span class="comment">//触发浏览事件，选择文件</span></span><br><span class="line">    file.click();</span><br><span class="line">    <span class="comment">//选中文件后，验证文件格式是否符合要求</span></span><br><span class="line">    file.change(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">//取得所选文件的扩展名</span></span><br><span class="line">        <span class="keyword">var</span> fileFormat = $(<span class="keyword">this</span>).val().exec(<span class="regexp">/\.[a-zA-Z]+$/</span>)[<span class="number">0</span>].substring(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (opt.format.join(<span class="string">'-'</span>).indexOf(fileVal) != -<span class="number">1</span>) &#123;</span><br><span class="line">            form.submit(); <span class="comment">//格式通过验证后提交表单;</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            iframe.remove();</span><br><span class="line">            form.remove();</span><br><span class="line">            alert(<span class="string">'文件格式错误，请重新选择！'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//文件提交完后</span></span><br><span class="line">    iframe.load(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> data = $(<span class="keyword">this</span>).contents().find(<span class="string">'body'</span>).html();</span><br><span class="line">        opt.callBack(data);</span><br><span class="line">        iframe.remove();</span><br><span class="line">        form.remove();</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分解下步骤：</p>
<p>1.创建iframe和form表单，并 append 到 document 中。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建iframe和form表单</span></span><br><span class="line">iframe = $(<span class="string">'&lt;iframe name="'</span> + iName + <span class="string">'" /&gt;'</span>);</span><br><span class="line">form = $(<span class="string">'&lt;form method="post" style="display:none;" target="'</span> + iName + <span class="string">'" action="'</span> + opt.url + <span class="string">'"  name="form_'</span> + iName + <span class="string">'" enctype="multipart/form-data" /&gt;'</span>);</span><br><span class="line">file = $(<span class="string">'&lt;input type="file" name="'</span> + opt.fileName + <span class="string">'" /&gt;'</span>);</span><br><span class="line">file.appendTo(form);</span><br><span class="line"><span class="comment">//插入body</span></span><br><span class="line">$(<span class="built_in">document</span>.body).append(iframe).append(form);</span><br></pre></td></tr></table></figure>
<p>2.触发浏览事件，选择文件 <code>file.click();</code>。</p>
<p>3.<code>file.change</code> 事件判断文件格式，符合则提交，否则要 remove 掉创建的 form 和 iframe。</p>
<p>4.<code>iframe.load</code> 事件，拿到服务器返回的数据，并调用 callback 回传。remove 掉创建的 form 和 iframe。</p>
<p>因为<strong>低版本的IE（IE8及以下）做了安全限制，file控件必须由用户主动点击触发选择的文件才可以上传，而不能使用js的click事件来模拟点击触发</strong>。</p>
<p>所以，<code>file = $(&#39;&lt;input type=&quot;file&quot; name=&quot;&#39; + opt.fileName + &#39;&quot; /&gt;&#39;);</code> 不要动态创建，而是显示在 HTML 里，但是在 <code>file.change</code> 时会将 file 的 id 传入<code>ajaxUpload</code>，然后 appendTo 到 form 里。之后无异。此时要主要创建一个中间变量，保存 file 的父级，用完后 appendTo 回去，否则 file 会被删除。</p>
<p>看下代码（来源：<a href="http://www.cnblogs.com/wangmeijian/p/3978407.html" target="_blank" rel="external">利用iframe无刷新上传文件的坑</a>）：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*2014年9月19日11:11:07 By 王美建*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ajaxUpload</span>(<span class="params">opt</span>)</span>&#123;</span><br><span class="line">    <span class="comment">/*</span><br><span class="line">        参数说明:</span><br><span class="line">        opt.id : 页面里file控件的ID;</span><br><span class="line">        opt.frameName : iframe的name值;</span><br><span class="line">        opt.url : 文件要提交到的地址;</span><br><span class="line">        opt.format : 文件格式，以数组的形式传递，如['jpg','png','gif','bmp'];</span><br><span class="line">        opt.callBack : 上传成功后回调;</span><br><span class="line">    */</span></span><br><span class="line">    <span class="keyword">var</span> iName=opt.frameName; <span class="comment">//太长了，变短点</span></span><br><span class="line">    <span class="keyword">var</span> iframe,form,file,fileParent;</span><br><span class="line">    <span class="comment">//创建iframe和form表单</span></span><br><span class="line">    iframe = $(<span class="string">'&lt;iframe name="'</span>+iName+<span class="string">'" /&gt;'</span>);</span><br><span class="line">    form = $(<span class="string">'&lt;form method="post" style="display:n1one;" target="'</span>+iName+<span class="string">'" action="'</span>+opt.url+<span class="string">'"  name="form_'</span>+iName+<span class="string">'" enctype="multipart/form-data" /&gt;'</span>);</span><br><span class="line">    file = $(<span class="string">'#'</span>+opt.id); <span class="comment">//通过id获取flie控件</span></span><br><span class="line">    fileParent = file.parent(); <span class="comment">//存父级</span></span><br><span class="line">    file.appendTo(form);</span><br><span class="line">    <span class="comment">//插入body</span></span><br><span class="line">    $(<span class="built_in">document</span>.body).append(iframe).append(form);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//取得所选文件的扩展名</span></span><br><span class="line">    <span class="keyword">var</span> fileFormat=<span class="regexp">/\.[a-zA-Z]+$/</span>.exec(file.val())[<span class="number">0</span>].substring(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(opt.format.join(<span class="string">'-'</span>).indexOf(fileFormat)!=-<span class="number">1</span>)&#123;</span><br><span class="line">        form.submit();<span class="comment">//格式通过验证后提交表单;</span></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        file.appendTo(fileParent); <span class="comment">//将file控件放回到页面</span></span><br><span class="line">        iframe.remove();</span><br><span class="line">        form.remove();</span><br><span class="line">        alert(<span class="string">'文件格式错误，请重新选择！'</span>);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//文件提交完后</span></span><br><span class="line">    iframe.load(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> data = $(<span class="keyword">this</span>).contents().find(<span class="string">'body'</span>).html();        </span><br><span class="line">        file.appendTo(fileParent);</span><br><span class="line">        iframe.remove();</span><br><span class="line">        form.remove();</span><br><span class="line">        opt.callBack(data);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后再优化下显示。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/01/20/Git-Tips/" class="prev">上一篇</a><a href="/2016/01/16/Learn-Redux/" class="next">下一篇</a></div></footer><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>